<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Admin Dashboard - Dr. Dhingra's Clinic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'medical-blue': '#0B4D6B',
                        'medical-light': '#E6F3F8',
                        'medical-accent': '#2196F3',
                        'medical-success': '#10B981',
                        'medical-warning': '#F59E0B',
                        'medical-error': '#EF4444',
                        'medical-dark': '#1E293B',
                        'medical-gray': '#64748B',
                        'medical-light-gray': '#F8FAFC',
                    },
                    fontFamily: {
                        'primary': ['Poppins', 'sans-serif'],
                        'secondary': ['Inter', 'sans-serif']
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'pulse-gentle': 'pulseGentle 2s infinite',
                        'slide-in-right': 'slideInRight 0.3s ease-out',
                        'bounce-gentle': 'bounceGentle 0.5s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(30px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        slideInRight: {
                            '0%': { opacity: '0', transform: 'translateX(20px)' },
                            '100%': { opacity: '1', transform: 'translateX(0)' }
                        },
                        bounceGentle: {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(1.05)' }
                        },
                        pulseGentle: {
                            '0%, 100%': { opacity: '0.4' },
                            '50%': { opacity: '0.6' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #F8FAFC 0%, #E6F3F8 50%, #F8FAFC 100%);
            min-height: 100vh;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .medical-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
        }

        .sidebar-gradient {
            background: linear-gradient(135deg, #0B4D6B 0%, #2196F3 100%);
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(230, 243, 248, 0.4) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(33, 150, 243, 0.1);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(33, 150, 243, 0.2);
            background: linear-gradient(135deg, rgba(255, 255, 255, 1) 0%, rgba(230, 243, 248, 0.6) 100%);
        }

        .nav-item {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .nav-item:hover::before {
            left: 100%;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: inset 4px 0 0 rgba(255, 255, 255, 0.8);
        }

        .calendar-cell {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .calendar-cell:hover {
            background: rgba(33, 150, 243, 0.1);
            transform: scale(1.05);
        }

        .appointment-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin: 1px;
        }

        .medical-button {
            background: linear-gradient(135deg, #2196F3 0%, #0B4D6B 100%);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .medical-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .medical-button:hover::before {
            left: 100%;
        }

        .medical-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(33, 150, 243, 0.4);
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .floating-elements::before {
            content: '';
            position: absolute;
            top: -50px;
            right: -50px;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(33, 150, 243, 0.05) 0%, transparent 70%);
            border-radius: 50%;
            animation: pulse-gentle 3s infinite;
        }

        .table-row {
            transition: all 0.2s ease;
        }

        .table-row:hover {
            background: rgba(33, 150, 243, 0.05);
            transform: scale(1.01);
        }

        .scroll-custom::-webkit-scrollbar {
            width: 6px;
        }

        .scroll-custom::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }

        .scroll-custom::-webkit-scrollbar-thumb {
            background: #2196F3;
            border-radius: 3px;
        }

        .scroll-custom::-webkit-scrollbar-thumb:hover {
            background: #0B4D6B;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const API_BASE_URL = 'http://127.0.0.1:8000';

        // API utility function with authentication
        const api = async (url, options = {}) => {
            const token = sessionStorage.getItem('accessToken');
            if (!token) {
                window.location.href = './admin_login.html';
                return;
            }

            const config = {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    ...options.headers
                }
            };

            try {
                const res = await fetch(API_BASE_URL + url, config);
                if (res.status === 401) {
                    sessionStorage.clear();
                    window.location.href = './admin_login.html';
                    return;
                }
                return res.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        };

        // Utility Components
        const LoadingSpinner = () => (
            <div className="flex items-center justify-center p-8">
                <div className="w-8 h-8 border-4 border-medical-accent border-t-transparent rounded-full animate-spin"></div>
            </div>
        );

        const StatCard = ({ icon, title, value, subtitle, color = "medical-accent" }) => (
            <div className="stat-card p-6 rounded-2xl medical-card animate-slide-up">
                <div className="flex items-center justify-between mb-4">
                    <div className={`w-12 h-12 bg-${color}/10 rounded-xl flex items-center justify-center`}>
                        <i className={`${icon} text-${color} text-xl`}></i>
                    </div>
                    <div className={`px-3 py-1 bg-${color}/10 text-${color} text-sm font-medium rounded-full`}>
                        {subtitle}
                    </div>
                </div>
                <div className="text-3xl font-bold text-medical-dark mb-1">{value}</div>
                <div className="text-medical-gray font-secondary">{title}</div>
            </div>
        );

        const Modal = ({ isOpen, onClose, title, children, width = "max-w-2xl" }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
                    <div className={`bg-white rounded-2xl shadow-2xl ${width} max-h-[90vh] overflow-hidden animate-bounce-gentle flex flex-col`}>
                        <div className="flex items-center justify-between p-6 border-b border-gray-200 flex-shrink-0">
                            <h2 className="text-xl font-bold text-medical-dark font-primary">{title}</h2>
                            <button onClick={onClose} className="text-medical-gray hover:text-medical-dark">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div className="p-6 overflow-y-auto scroll-custom flex-grow">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // Sidebar Component
        const Sidebar = ({ currentView, setCurrentView, user }) => {
            const menuItems = [
                { id: 'dashboard', label: 'Dashboard', icon: 'fas fa-home' },
                { id: 'appointments', label: 'Appointments', icon: 'fas fa-calendar-alt' },
                { id: 'schedule', label: 'Doctor Schedule', icon: 'fas fa-clock' },
                { id: 'patients', label: 'Patients', icon: 'fas fa-users' },
                { id: 'prescriptions', label: 'Prescriptions', icon: 'fas fa-prescription' },
                { id: 'users', label: 'Users', icon: 'fas fa-user-cog', adminOnly: true },
                { id: 'logs', label: 'Audit Logs', icon: 'fas fa-clipboard-list', adminOnly: true }
            ];

            const handleLogout = () => {
                sessionStorage.clear();
                window.location.href = './admin_login.html';
            };

            return (
                <div className="w-64 sidebar-gradient text-white flex flex-col h-full">
                    <div className="p-6 border-b border-white/20">
                        <div className="flex items-center mb-4">
                            <div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center mr-3">
                                <i className="fas fa-stethoscope text-white text-xl"></i>
                            </div>
                            <div>
                                <h1 className="text-xl font-bold font-primary">Medical Portal</h1>
                                <p className="text-blue-200 font-secondary text-sm">Dr. Dhingra's Clinic</p>
                            </div>
                        </div>
                        <div className="bg-white/10 p-3 rounded-xl">
                            <div className="flex items-center">
                                <div className="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center mr-2">
                                    <i className="fas fa-user text-white text-sm"></i>
                                </div>
                                <div>
                                    <div className="font-semibold text-sm">{user?.username}</div>
                                    <div className="text-blue-200 text-xs capitalize">{user?.role}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <nav className="flex-1 p-4 space-y-2">
                        {menuItems.map(item => {
                            if (item.adminOnly && user?.role !== 'admin') return null;
                            return (
                                <button
                                    key={item.id}
                                    onClick={() => setCurrentView(item.id)}
                                    className={`nav-item w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 font-secondary ${currentView === item.id ? 'active' : ''
                                        }`}
                                >
                                    <i className={item.icon}></i>
                                    <span>{item.label}</span>
                                </button>
                            );
                        })}
                    </nav>

                    <div className="p-4 border-t border-white/20">
                        <button
                            onClick={handleLogout}
                            className="nav-item w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 font-secondary text-red-200 hover:bg-red-500/10"
                        >
                            <i className="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </button>
                    </div>
                </div>
            );
        };

        // Dashboard Component
                        const Dashboard = ({ openModal, closeModal }) => {
            const [stats, setStats] = React.useState(null);
            const [loading, setLoading] = React.useState(true);

            React.useEffect(() => {
                const fetchStats = async () => {
                    try {
                        const data = await api('/api/v1/dashboard/stats');
                        setStats(data);
                    } catch (error) {
                        console.error('Error fetching stats:', error);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchStats();
            }, []);

                        if (loading) return <LoadingSpinner />;


            return (
                <div className="space-y-8">
                    <div className="flex items-center justify-between">
                        <h2 className="text-2xl font-bold text-medical-dark font-primary">Dashboard Overview</h2>
                        <div className="text-medical-gray font-secondary">
                            <i className="fas fa-calendar-day mr-2"></i>
                            {new Date().toLocaleDateString('en-US', {
                                weekday: 'long',
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            })}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <StatCard
                            icon="fas fa-users"
                            title="Total Patients"
                            value={stats?.total_patients || 0}
                            subtitle="All Time"
                            color="medical-success"
                        />
                        <StatCard
                            icon="fas fa-calendar-check"
                            title="Today's Appointments"
                            value={stats?.appointments_today || 0}
                            subtitle="Today"
                            color="medical-accent"
                        />
                        <StatCard
                            icon="fas fa-clock"
                            title="Pending Appointments"
                            value={stats?.pending_appointments || 0}
                            subtitle="Waiting"
                            color="medical-warning"
                        />
                        <StatCard
                            icon="fas fa-chart-line"
                            title="This Week"
                            value={stats?.appointments_week || 0}
                            subtitle="7 Days"
                            color="medical-blue"
                        />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div className="medical-card p-6 rounded-2xl">
                            <h3 className="text-lg font-bold text-medical-dark mb-4 font-primary">Quick Actions</h3>
                            <div className="space-y-3">
                                                                <button onClick={() => openModal('Create New Appointment', <AppointmentEditor onClose={closeModal} />)} className="medical-button w-full p-3 text-white rounded-xl font-secondary flex items-center justify-center space-x-2 relative z-10">
                                    <i className="fas fa-plus"></i>
                                    <span>New Appointment</span>
                                </button>
                                                                <button onClick={() => openModal('Add New Patient', <PatientEditor onClose={closeModal} />)} className="medical-button w-full p-3 text-white rounded-xl font-secondary flex items-center justify-center space-x-2 relative z-10">
                                    <i className="fas fa-user-plus"></i>
                                    <span>Add Patient</span>
                                </button>
                                                                <button onClick={() => openModal('Create New Prescription', <PrescriptionEditor onClose={closeModal} />)} className="medical-button w-full p-3 text-white rounded-xl font-secondary flex items-center justify-center space-x-2 relative z-10">
                                    <i className="fas fa-prescription"></i>
                                    <span>New Prescription</span>
                                </button>
                            </div>
                        </div>

                        <div className="medical-card p-6 rounded-2xl">
                            <h3 className="text-lg font-bold text-medical-dark mb-4 font-primary">System Status</h3>
                            <div className="space-y-3">
                                <div className="flex items-center justify-between p-3 bg-medical-success/10 rounded-xl">
                                    <div className="flex items-center space-x-3">
                                        <div className="w-3 h-3 bg-medical-success rounded-full"></div>
                                        <span className="font-secondary">Database</span>
                                    </div>
                                    <span className="text-medical-success text-sm font-medium">Online</span>
                                </div>
                                <div className="flex items-center justify-between p-3 bg-medical-success/10 rounded-xl">
                                    <div className="flex items-center space-x-3">
                                        <div className="w-3 h-3 bg-medical-success rounded-full"></div>
                                        <span className="font-secondary">API Services</span>
                                    </div>
                                    <span className="text-medical-success text-sm font-medium">Online</span>
                                </div>
                                <div className="flex items-center justify-between p-3 bg-medical-warning/10 rounded-xl">
                                    <div className="flex items-center space-x-3">
                                        <div className="w-3 h-3 bg-medical-warning rounded-full animate-pulse"></div>
                                        <span className="font-secondary">WhatsApp Bot</span>
                                    </div>
                                    <span className="text-medical-warning text-sm font-medium">Limited</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Calendar Component
        const Calendar = ({ appointments, onDateClick, onAppointmentClick }) => {
            const [currentDate, setCurrentDate] = React.useState(new Date());

            const getDaysInMonth = (date) => {
                return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            };

            const getFirstDayOfMonth = (date) => {
                return new Date(date.getFullYear(), date.getMonth(), 1).getDay();
            };

            const getAppointmentsForDate = (date) => {
                if (!appointments) return [];
                return appointments.filter(apt => {
                    const aptDate = new Date(apt.start_time);
                    return aptDate.toDateString() === date.toDateString();
                });
            };

            const renderCalendarDays = () => {
                const daysInMonth = getDaysInMonth(currentDate);
                const firstDayOfMonth = getFirstDayOfMonth(currentDate);
                const days = [];

                // Empty cells for days before the first day of the month
                for (let i = 0; i < firstDayOfMonth; i++) {
                    days.push(<div key={`empty-${i}`} className="p-2"></div>);
                }

                // Days of the month
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                    const dayAppointments = getAppointmentsForDate(date);
                    const isToday = date.toDateString() === new Date().toDateString();

                    days.push(
                        <div
                            key={day}
                            className={`calendar-cell p-2 border border-gray-200 rounded-lg min-h-[80px] ${isToday ? 'bg-medical-accent/10 border-medical-accent' : ''
                                }`}
                            onClick={() => onDateClick(date)}
                        >
                            <div className={`font-semibold mb-1 ${isToday ? 'text-medical-accent' : 'text-medical-dark'}`}>
                                {day}
                            </div>
                            <div className="space-y-1">
                                {dayAppointments.slice(0, 3).map(apt => (
                                    <div
                                        key={apt.id}
                                        className="text-xs p-1 bg-medical-accent/20 text-medical-accent rounded cursor-pointer hover:bg-medical-accent/30"
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            onAppointmentClick(apt);
                                        }}
                                    >
                                        {new Date(apt.start_time).toLocaleTimeString('en-US', {
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        })}
                                    </div>
                                ))}
                                {dayAppointments.length > 3 && (
                                    <div className="text-xs text-medical-gray">
                                        +{dayAppointments.length - 3} more
                                    </div>
                                )}
                            </div>
                        </div>
                    );
                }

                return days;
            };

            const navigateMonth = (direction) => {
                const newDate = new Date(currentDate);
                newDate.setMonth(currentDate.getMonth() + direction);
                setCurrentDate(newDate);
            };

            return (
                <div className="medical-card p-6 rounded-2xl">
                    <div className="flex items-center justify-between mb-6">
                        <h3 className="text-xl font-bold text-medical-dark font-primary">
                            {currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                        </h3>
                        <div className="flex space-x-2">
                            <button
                                onClick={() => navigateMonth(-1)}
                                className="p-2 text-medical-accent hover:bg-medical-accent/10 rounded-lg"
                            >
                                <i className="fas fa-chevron-left"></i>
                            </button>
                            <button
                                onClick={() => navigateMonth(1)}
                                className="p-2 text-medical-accent hover:bg-medical-accent/10 rounded-lg"
                            >
                                <i className="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-7 gap-2">
                        {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                            <div key={day} className="p-2 text-center font-semibold text-medical-gray">
                                {day}
                            </div>
                        ))}
                        {renderCalendarDays()}
                    </div>
                </div>
            );
        };

        // Appointments Component
        const Appointments = () => {
            const [appointments, setAppointments] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [selectedAppointment, setSelectedAppointment] = React.useState(null);
            const [selectedDate, setSelectedDate] = React.useState(null);
            const [showModal, setShowModal] = React.useState(false);

            React.useEffect(() => {
                const fetchAppointments = async () => {
                    try {
                        const data = await api('/api/v1/appointments');
                        setAppointments(Array.isArray(data) ? data : data.appointments || []);
                    } catch (error) {
                        console.error('Error fetching appointments:', error);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchAppointments();
            }, []);

            const handleDateClick = (date) => {
                setSelectedDate(date);
                setShowModal(true);
            };

            const handleAppointmentClick = (appointment) => {
                setSelectedAppointment(appointment);
                setShowModal(true);
            };

            if (loading) return <LoadingSpinner />;

            return (
                <div className="space-y-8">
                    <div className="flex items-center justify-between">
                        <h2 className="text-2xl font-bold text-medical-dark font-primary">Appointments</h2>
                        <button className="medical-button px-6 py-3 text-white rounded-xl font-secondary flex items-center space-x-2 relative z-10">
                            <i className="fas fa-plus"></i>
                            <span>New Appointment</span>
                        </button>
                    </div>

                    <Calendar
                        appointments={appointments}
                        onDateClick={handleDateClick}
                        onAppointmentClick={handleAppointmentClick}
                    />

                    <Modal
                        isOpen={showModal}
                        onClose={() => {
                            setShowModal(false);
                            setSelectedAppointment(null);
                            setSelectedDate(null);
                        }}
                        title={selectedAppointment ? "Appointment Details" : "Appointments for Date"}
                        width="max-w-4xl"
                    >
                        {selectedAppointment ? (
                            <AppointmentDetails appointment={selectedAppointment} />
                        ) : selectedDate ? (
                            <DateAppointments
                                date={selectedDate}
                                appointments={appointments.filter(apt =>
                                    new Date(apt.start_time).toDateString() === selectedDate.toDateString()
                                )}
                            />
                        ) : null}
                    </Modal>
                </div>
            );
        };

        // Appointment Details Component
        const AppointmentDetails = ({ appointment }) => (
            <div className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 className="font-semibold text-medical-dark mb-3">Appointment Information</h4>
                        <div className="space-y-2 text-sm">
                            <div><span className="font-medium">Date:</span> {new Date(appointment.start_time).toLocaleDateString()}</div>
                            <div><span className="font-medium">Time:</span> {new Date(appointment.start_time).toLocaleTimeString()}</div>
                            <div><span className="font-medium">Status:</span>
                                <span className="ml-2 px-2 py-1 bg-medical-accent/10 text-medical-accent rounded-full text-xs">
                                    {appointment.status}
                                </span>
                            </div>
                            <div><span className="font-medium">Type:</span> {appointment.appointment_type}</div>
                        </div>
                    </div>
                    <div>
                        <h4 className="font-semibold text-medical-dark mb-3">Patient Information</h4>
                        <div className="space-y-2 text-sm">
                            <div><span className="font-medium">Name:</span> {`${appointment.patient?.first_name || ''} ${appointment.patient?.last_name || ''}`.trim() || 'N/A'}</div>
                            <div><span className="font-medium">Phone:</span> {appointment.patient?.phone_number || 'N/A'}</div>
                            <div><span className="font-medium">Email:</span> {appointment.patient?.email || 'N/A'}</div>
                        </div>
                    </div>
                </div>

                <div>
                    <h4 className="font-semibold text-medical-dark mb-3">Notes</h4>
                    <div className="bg-gray-50 p-3 rounded-lg text-sm">
                        {appointment.notes || appointment.reason || 'No notes available'}
                    </div>
                </div>

                <div className="flex space-x-3">
                    <button className="medical-button px-4 py-2 text-white rounded-lg text-sm relative z-10">
                        <i className="fas fa-edit mr-2"></i>Edit
                    </button>
                    <button className="px-4 py-2 bg-medical-error text-white rounded-lg text-sm hover:bg-medical-error/90">
                        <i className="fas fa-times mr-2"></i>Cancel
                    </button>
                    <button className="px-4 py-2 bg-medical-success text-white rounded-lg text-sm hover:bg-medical-success/90">
                        <i className="fas fa-check mr-2"></i>Complete
                    </button>
                </div>
            </div>
        );

        // Date Appointments Component
        const DateAppointments = ({ date, appointments }) => (
            <div className="space-y-4">
                <h4 className="font-semibold text-medical-dark">
                    Appointments for {date.toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    })}
                </h4>
                {appointments.length === 0 ? (
                    <div className="text-center py-8 text-medical-gray">
                        <i className="fas fa-calendar-times text-4xl mb-4"></i>
                        <p>No appointments scheduled for this date</p>
                    </div>
                ) : (
                    <div className="space-y-3">
                        {appointments.map(apt => (
                            <div key={apt.id} className="table-row p-4 border border-gray-200 rounded-lg">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <div className="font-semibold">{`${apt.patient?.first_name || ''} ${apt.patient?.last_name || ''}`.trim() || 'Unknown Patient'}</div>
                                        <div className="text-sm text-medical-gray">
                                            {new Date(apt.start_time).toLocaleTimeString()} - {apt.appointment_type}
                                        </div>
                                    </div>
                                    <div className="flex items-center space-x-2">
                                        <span className="px-2 py-1 bg-medical-accent/10 text-medical-accent rounded-full text-xs">
                                            {apt.status}
                                        </span>
                                        <button className="text-medical-accent hover:text-medical-dark">
                                            <i className="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );

        // Schedule Calendar Component (Updated for Unified View)
        const ScheduleCalendar = ({ homeClinicSchedule, hospitalSchedule, onDateClick }) => {
            const [currentDate, setCurrentDate] = React.useState(new Date());

            const getDaysInMonth = (date) => new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            const getFirstDayOfMonth = (date) => new Date(date.getFullYear(), date.getMonth(), 1).getDay();

            const getScheduleForDate = (date, schedule) => {
                if (!schedule) return null;
                const dayOfWeek = (date.getDay() + 6) % 7; // 0 = Monday, 6 = Sunday
                return schedule[dayOfWeek];
            };

            const renderCalendarDays = () => {
                const daysInMonth = getDaysInMonth(currentDate);
                const firstDayOfMonth = getFirstDayOfMonth(currentDate);
                const days = [];

                for (let i = 0; i < firstDayOfMonth; i++) {
                    days.push(<div key={`empty-${i}`} className="p-2"></div>);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                    const clinicSchedule = getScheduleForDate(date, homeClinicSchedule);
                    const hospitalScheduleData = getScheduleForDate(date, hospitalSchedule);
                    const isToday = date.toDateString() === new Date().toDateString();

                    days.push(
                        <div
                            key={day}
                            className={`calendar-cell p-2 border border-gray-200 rounded-lg min-h-[90px] ${isToday ? 'bg-medical-accent/10 border-medical-accent' : ''}`}
                            onClick={() => onDateClick(date, { clinicSchedule, hospitalSchedule: hospitalScheduleData })}
                        >
                            <div className={`font-semibold mb-1 ${isToday ? 'text-medical-accent' : 'text-medical-dark'}`}>{day}</div>
                            <div className="text-xs space-y-1">
                                {clinicSchedule && clinicSchedule.is_available ? (
                                    <div className="text-blue-600"><strong>C:</strong> {clinicSchedule.start_time.substring(0, 5)} - {clinicSchedule.end_time.substring(0, 5)}</div>
                                ) : (
                                    <div className="text-gray-400"><strong>C:</strong> Off</div>
                                )}
                                {hospitalScheduleData && hospitalScheduleData.is_available ? (
                                    <div className="text-green-700"><strong>H:</strong> {hospitalScheduleData.start_time.substring(0, 5)} - {hospitalScheduleData.end_time.substring(0, 5)}</div>
                                ) : (
                                    <div className="text-gray-400"><strong>H:</strong> Off</div>
                                )}
                            </div>
                        </div>
                    );
                }
                return days;
            };

            const navigateMonth = (direction) => {
                const newDate = new Date(currentDate);
                newDate.setMonth(currentDate.getMonth() + direction);
                setCurrentDate(newDate);
            };

            return (
                <div className="medical-card p-6 rounded-2xl">
                    <div className="flex items-center justify-between mb-6">
                        <h3 className="text-xl font-bold text-medical-dark font-primary">
                            {currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                        </h3>
                        <div className="flex space-x-2">
                            <button onClick={() => navigateMonth(-1)} className="p-2 text-medical-accent hover:bg-medical-accent/10 rounded-lg">
                                <i className="fas fa-chevron-left"></i>
                            </button>
                            <button onClick={() => navigateMonth(1)} className="p-2 text-medical-accent hover:bg-medical-accent/10 rounded-lg">
                                <i className="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div className="grid grid-cols-7 gap-2">
                        {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                            <div key={day} className="p-2 text-center font-semibold text-medical-gray">{day}</div>
                        ))}
                        {renderCalendarDays()}
                    </div>
                </div>
            );
        };

        // Doctor Schedule Component (Updated for Unified View & Edit Logic)
        const DoctorSchedule = () => {
            const [schedules, setSchedules] = React.useState({ 1: {}, 2: {} });
            const [locations, setLocations] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [showModal, setShowModal] = React.useState(false);
            const [modalContent, setModalContent] = React.useState(null);
            const [modalTitle, setModalTitle] = React.useState('');

            const fetchSchedulesAndLocations = async () => {
                setLoading(true);
                try {
                    const fetchedLocations = [
                        { id: 1, name: "Home Clinic" },
                        { id: 2, name: "Hospital" }
                    ];
                    setLocations(fetchedLocations);

                    const newSchedules = { 1: {}, 2: {} };
                    for (const loc of fetchedLocations) {
                        const data = await api(`/api/v1/schedules/${loc.id}`);
                        const scheduleMap = (data || []).reduce((acc, item) => {
                            acc[item.day_of_week] = item;
                            return acc;
                        }, {});
                        newSchedules[loc.id] = scheduleMap;
                    }
                    setSchedules(newSchedules);

                } catch (error) {
                    console.error("Error fetching schedules:", error);
                } finally {
                    setLoading(false);
                }
            };

            React.useEffect(() => {
                fetchSchedulesAndLocations();
            }, []);
            
            const handleSave = async (updatedSchedules) => {
                try {
                    for (const locationId in updatedSchedules) {
                        const schedulePayload = Object.values(updatedSchedules[locationId]);
                        await api(`/api/v1/schedules/${locationId}`, {
                            method: 'POST',
                            body: JSON.stringify(schedulePayload)
                        });
                    }
                    setShowModal(false);
                    fetchSchedulesAndLocations(); // Re-fetch after saving
                } catch (error) {
                    console.error("Error saving schedules:", error);
                    // You might want to show an error message to the user here
                }
            };

            const handleDateClick = (date) => {
                setModalTitle('Block Off Dates');
                setModalContent(<DailyUnavailabilityEditor date={date} onClose={() => setShowModal(false)} />);
                setShowModal(true);
            };

            if (loading) return <LoadingSpinner />;

            return (
                <div className="space-y-8">
                    <div className="flex items-center justify-between">
                        <h2 className="text-2xl font-bold text-medical-dark font-primary">Doctor Schedule</h2>
                        <button
                            onClick={() => {
                                setModalTitle('Edit Weekly Schedule');
                                setModalContent(<ScheduleEditor schedules={schedules} locations={locations} onSave={handleSave} onClose={() => setShowModal(false)} />);
                                setShowModal(true);
                            }}
                            className="medical-button px-6 py-3 text-white rounded-xl font-secondary flex items-center space-x-2 relative z-10"
                        >
                            <i className="fas fa-edit"></i>
                            <span>Edit Weekly Schedule</span>
                        </button>
                    </div>

                    <ScheduleCalendar
                        homeClinicSchedule={schedules[1]}
                        hospitalSchedule={schedules[2]}
                        onDateClick={handleDateClick}
                    />

                    <Modal
                        isOpen={showModal}
                        onClose={() => setShowModal(false)}
                        title={modalTitle}
                        width="max-w-4xl"
                    >
                        {modalContent}
                    </Modal>
                </div>
            );
        };

        // Schedule Editor Component (Updated for Multi-Location Weekly Edit)
        const ScheduleEditor = ({ schedules, locations, onSave, onClose }) => {
            const [localSchedules, setLocalSchedules] = React.useState(JSON.parse(JSON.stringify(schedules))); // Deep copy
            const [activeLocationId, setActiveLocationId] = React.useState(locations[0]?.id || 1);

            const handleTimeChange = (locationId, dayIndex, field, value) => {
                setLocalSchedules(prev => ({
                    ...prev,
                    [locationId]: {
                        ...prev[locationId],
                        [dayIndex]: {
                            ...(prev[locationId][dayIndex] || { day_of_week: dayIndex, start_time: '09:00:00', end_time: '17:00:00', is_available: false }),
                            [field]: value
                        }
                    }
                }));
            };

            const handleAvailabilityChange = (locationId, dayIndex, isAvailable) => {
                setLocalSchedules(prev => ({
                    ...prev,
                    [locationId]: {
                        ...prev[locationId],
                        [dayIndex]: {
                            ...(prev[locationId][dayIndex] || { day_of_week: dayIndex, start_time: '09:00:00', end_time: '17:00:00' }),
                            is_available: isAvailable
                        }
                    }
                }));
            };
            
            const activeSchedule = localSchedules[activeLocationId] || {};

            return (
                <div className="space-y-6">
                    <div className="flex space-x-1 bg-gray-100 p-1 rounded-xl">
                        {locations.map(loc => (
                            <button
                                key={loc.id}
                                onClick={() => setActiveLocationId(loc.id)}
                                className={`flex-1 py-2 px-4 rounded-lg font-medium transition-all ${activeLocationId === loc.id ? 'bg-white text-medical-accent shadow-sm' : 'text-medical-gray hover:text-medical-dark'}`}
                            >
                                {loc.name}
                            </button>
                        ))}
                    </div>

                    {[...Array(7).keys()].map(dayIndex => {
                        const dayName = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'][dayIndex];
                        const dayData = activeSchedule[dayIndex] || { start_time: '09:00:00', end_time: '17:00:00', is_available: false };

                        return (
                            <div key={dayIndex} className="grid grid-cols-4 gap-4 items-center p-3 border-b">
                                <h4 className="font-semibold text-medical-dark">{dayName}</h4>
                                <div>
                                    <label className="block text-xs font-medium text-medical-gray mb-1">Start Time</label>
                                    <input
                                        type="time"
                                        value={dayData.start_time}
                                        onChange={(e) => handleTimeChange(activeLocationId, dayIndex, 'start_time', e.target.value)}
                                        className="w-full p-2 border border-gray-300 rounded-lg"
                                        disabled={!dayData.is_available}
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-medium text-medical-gray mb-1">End Time</label>
                                    <input
                                        type="time"
                                        value={dayData.end_time}
                                        onChange={(e) => handleTimeChange(activeLocationId, dayIndex, 'end_time', e.target.value)}
                                        className="w-full p-2 border border-gray-300 rounded-lg"
                                        disabled={!dayData.is_available}
                                    />
                                </div>
                                <div className="flex items-center justify-center">
                                    <label className="flex items-center space-x-2 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={dayData.is_available}
                                            onChange={(e) => handleAvailabilityChange(activeLocationId, dayIndex, e.target.checked)}
                                            className="w-4 h-4 text-medical-accent rounded"
                                        />
                                        <span>Available</span>
                                    </label>
                                </div>
                            </div>
                        )
                    })}

                    <div className="flex justify-end space-x-3">
                        <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                            Cancel
                        </button>
                        <button onClick={() => onSave(localSchedules)} className="medical-button px-4 py-2 text-white rounded-lg relative z-10">
                            Save Schedule
                        </button>
                    </div>
                </div>
            )
        };


        // Patients Component
        const Patients = () => {
            const [patients, setPatients] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [searchTerm, setSearchTerm] = React.useState('');
            const [selectedPatient, setSelectedPatient] = React.useState(null);
            const [showModal, setShowModal] = React.useState(false);

            React.useEffect(() => {
                const fetchPatients = async () => {
                    try {
                        const data = await api(`/api/v1/patients?search=${searchTerm}`);
                        setPatients(Array.isArray(data) ? data : data.patients || []);
                    } catch (error) {
                        console.error('Error fetching patients:', error);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchPatients();
            }, [searchTerm]);

            const handlePatientClick = (patient) => {
                setSelectedPatient(patient);
                setShowModal(true);
            };

            if (loading) return <LoadingSpinner />;

            return (
                <div className="space-y-6">
                    <div className="flex items-center justify-between">
                        <h2 className="text-2xl font-bold text-medical-dark font-primary">Patients</h2>
                        <div className="flex space-x-4">
                            <div className="relative">
                                <input
                                    type="text"
                                    placeholder="Search patients..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:border-medical-accent focus:outline-none font-secondary"
                                />
                                <i className="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-medical-gray"></i>
                            </div>
                            <button className="medical-button px-6 py-3 text-white rounded-xl font-secondary flex items-center space-x-2 relative z-10">
                                <i className="fas fa-user-plus"></i>
                                <span>Add Patient</span>
                            </button>
                        </div>
                    </div>

                    <div className="medical-card rounded-2xl overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-medical-light">
                                    <tr>
                                        <th className="text-left p-4 font-semibold text-medical-dark">Name</th>
                                        <th className="text-left p-4 font-semibold text-medical-dark">Phone</th>
                                        <th className="text-left p-4 font-semibold text-medical-dark">Email</th>
                                        <th className="text-left p-4 font-semibold text-medical-dark">Last Visit</th>
                                        <th className="text-left p-4 font-semibold text-medical-dark">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {patients.map(patient => (
                                        <tr key={patient.id} className="table-row border-b border-gray-100">
                                            <td className="p-4">
                                                <div className="flex items-center space-x-3">
                                                    <div className="w-10 h-10 bg-medical-accent/10 rounded-full flex items-center justify-center">
                                                        <span className="text-medical-accent font-semibold">
                                                            {patient.first_name?.charAt(0) || 'P'}
                                                        </span>
                                                    </div>
                                                    <div>
                                                        <div className="font-semibold text-medical-dark">{`${patient.first_name} ${patient.last_name || ''}`}</div>
                                                        <div className="text-sm text-medical-gray">ID: {patient.id}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td className="p-4 text-medical-gray">{patient.phone_number || 'N/A'}</td>
                                            <td className="p-4 text-medical-gray">{patient.email || 'N/A'}</td>
                                            <td className="p-4 text-medical-gray">
                                                {patient.last_visit_date ?
                                                    new Date(patient.last_visit_date).toLocaleDateString() :
                                                    'Never'
                                                }
                                            </td>
                                            <td className="p-4">
                                                <div className="flex space-x-2">
                                                    <button
                                                        onClick={() => handlePatientClick(patient)}
                                                        className="text-medical-accent hover:text-medical-dark"
                                                    >
                                                        <i className="fas fa-eye"></i>
                                                    </button>
                                                    <button className="text-medical-success hover:text-green-700">
                                                        <i className="fas fa-edit"></i>
                                                    </button>
                                                    <button className="text-medical-error hover:text-red-700">
                                                        <i className="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        {patients.length === 0 && (
                            <div className="text-center py-12">
                                <i className="fas fa-users text-4xl text-medical-gray mb-4"></i>
                                <p className="text-medical-gray">No patients found</p>
                            </div>
                        )}
                    </div>

                    <Modal
                        isOpen={showModal}
                        onClose={() => setShowModal(false)}
                        title="Patient Details"
                        width="max-w-6xl"
                    >
                        {selectedPatient && <PatientDetails patient={selectedPatient} />}
                    </Modal>
                </div>
            );
        };

        // Patient Details Component
        const PatientDetails = ({ patient }) => {
            const [activeTab, setActiveTab] = React.useState('overview');
            const [patientAppointments, setPatientAppointments] = React.useState([]);
            const [patientPrescriptions, setPatientPrescriptions] = React.useState([]);
            const [patientRemarks, setPatientRemarks] = React.useState([]);
            const [newRemark, setNewRemark] = React.useState('');

            React.useEffect(() => {
                const fetchPatientData = async () => {
                    if (!patient) return;

                    // Fetch Prescriptions
                    try {
                        const prescriptionData = await api(`/api/v1/prescriptions/by-patient/${patient.id}`);
                        setPatientPrescriptions(prescriptionData || []);
                    } catch (error) {
                        console.error('Error fetching patient prescriptions:', error);
                    }
                    
                    // Fetch Remarks
                    try {
                        const remarksData = await api(`/api/v1/patients/${patient.id}/remarks/`);
                        setPatientRemarks(remarksData || []);
                    } catch (error) {
                        console.error('Error fetching patient remarks:', error);
                    }

                    // TODO: Fetch Appointments when endpoint is ready
                    setPatientAppointments([
                        {
                            id: 1,
                            start_time: '2024-01-15T10:00:00',
                            appointment_type: 'Consultation',
                            status: 'completed',
                            notes: 'Regular checkup, patient doing well'
                        },
                        {
                            id: 2,
                            start_time: '2024-01-20T14:30:00',
                            appointment_type: 'Follow-up',
                            status: 'scheduled',
                            notes: 'Follow-up for blood pressure monitoring'
                        }
                    ]);
                };

                fetchPatientData();
            }, [patient]);

            const handleAddRemark = async () => {
                if (!newRemark.trim()) return;
                try {
                    const addedRemark = await api(`/api/v1/patients/${patient.id}/remarks/`, {
                        method: 'POST',
                        body: JSON.stringify({ text: newRemark }),
                    });
                    setPatientRemarks([addedRemark, ...patientRemarks]);
                    setNewRemark('');
                } catch (error) {
                    console.error('Error adding remark:', error);
                }
            };

            const tabs = [
                { id: 'overview', label: 'Overview', icon: 'fas fa-user' },
                { id: 'appointments', label: 'Appointments', icon: 'fas fa-calendar' },
                { id: 'prescriptions', label: 'Prescriptions', icon: 'fas fa-prescription' },
                { id: 'remarks', label: 'Remarks', icon: 'fas fa-comment-medical' }
            ];

            return (
                <div className="space-y-6">
                    <div className="flex items-center space-x-4 pb-4 border-b border-gray-200">
                        <div className="w-16 h-16 bg-medical-accent/10 rounded-full flex items-center justify-center">
                            <span className="text-medical-accent text-xl font-bold">
                                {patient.name?.charAt(0) || 'P'}
                            </span>
                        </div>
                        <div>
                            <h3 className="text-2xl font-bold text-medical-dark">{`${patient.first_name || ''} ${patient.last_name || ''}`.trim() || 'Unknown Patient'}</h3>
                            <p className="text-medical-gray">Patient ID: {patient.id}</p>
                        </div>
                    </div>

                    <div className="flex space-x-1 bg-gray-100 p-1 rounded-xl">
                        {tabs.map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => setActiveTab(tab.id)}
                                className={`flex-1 flex items-center justify-center space-x-2 py-2 px-4 rounded-lg font-medium transition-all ${activeTab === tab.id
                                    ? 'bg-white text-medical-accent shadow-sm'
                                    : 'text-medical-gray hover:text-medical-dark'
                                    }`}
                            >
                                <i className={tab.icon}></i>
                                <span>{tab.label}</span>
                            </button>
                        ))}
                    </div>

                    <div className="min-h-[400px]">
                        {activeTab === 'overview' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h4 className="font-semibold text-medical-dark mb-4">Personal Information</h4>
                                    <div className="space-y-3 text-sm">
                                        <div className="flex justify-between">
                                            <span className="text-medical-gray">Phone:</span>
                                            <span>{patient.phone_number || 'N/A'}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-medical-gray">Email:</span>
                                            <span>{patient.email || 'N/A'}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-medical-gray">Date of Birth:</span>
                                            <span>{patient.date_of_birth || 'N/A'}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-medical-gray">Gender:</span>
                                            <span>{patient.gender || 'N/A'}</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 className="font-semibold text-medical-dark mb-4">Medical Information</h4>
                                    <div className="space-y-3 text-sm">
                                        <div className="flex justify-between">
                                            <span className="text-medical-gray">Blood Type:</span>
                                            <span>{patient.blood_type || 'Unknown'}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-medical-gray">Allergies:</span>
                                            <span>{patient.allergies || 'None known'}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-medical-gray">Last Visit:</span>
                                            <span>
                                                {patient.last_visit_date ?
                                                    new Date(patient.last_visit_date).toLocaleDateString() :
                                                    'Never'
                                                }
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'appointments' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center">
                                    <h4 className="font-semibold text-medical-dark">Appointment History</h4>
                                    <button className="medical-button px-4 py-2 text-white rounded-lg text-sm relative z-10">
                                        <i className="fas fa-plus mr-2"></i>New Appointment
                                    </button>
                                </div>
                                <div className="space-y-3">
                                    {patientAppointments.map(apt => (
                                        <div key={apt.id} className="table-row p-4 border border-gray-200 rounded-lg">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <div className="font-semibold">
                                                        {new Date(apt.start_time).toLocaleDateString()} - {apt.appointment_type}
                                                    </div>
                                                    <div className="text-sm text-medical-gray mt-1">{apt.notes}</div>
                                                </div>
                                                <span className={`px-2 py-1 rounded-full text-xs ${apt.status === 'completed'
                                                    ? 'bg-medical-success/10 text-medical-success'
                                                    : 'bg-medical-accent/10 text-medical-accent'
                                                    }`}>
                                                    {apt.status}
                                                </span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'prescriptions' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center">
                                    <h4 className="font-semibold text-medical-dark">Prescription History</h4>
                                    <button className="medical-button px-4 py-2 text-white rounded-lg text-sm relative z-10">
                                        <i className="fas fa-plus mr-2"></i>New Prescription
                                    </button>
                                </div>
                                <div className="space-y-3">
                                    {patientPrescriptions.map(prescription => (
                                        <div key={prescription.id} className="table-row p-4 border border-gray-200 rounded-lg">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <div className="font-semibold">{prescription.medication_name}</div>
                                                    <div className="text-sm text-medical-gray">
                                                        {prescription.dosage} - {prescription.frequency}
                                                    </div>
                                                    <div className="text-xs text-medical-gray mt-1">
                                                        Prescribed: {new Date(prescription.prescribed_date).toLocaleDateString()}
                                                    </div>
                                                </div>
                                                <span className={`px-2 py-1 rounded-full text-xs ${prescription.is_active
                                                    ? 'bg-medical-success/10 text-medical-success'
                                                    : 'bg-medical-gray/10 text-medical-gray'
                                                    }`}>
                                                    {prescription.is_active ? 'Active' : 'Inactive'}
                                                </span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'remarks' && (
                            <div className="space-y-4 animate-fade-in">
                                <h4 className="font-semibold text-medical-dark">Patient Remarks</h4>
                                <div className="space-y-4">
                                    <div className="bg-gray-50 p-4 rounded-lg">
                                        <textarea
                                            value={newRemark}
                                            onChange={(e) => setNewRemark(e.target.value)}
                                            className="w-full p-2 border border-gray-300 rounded-lg focus:border-medical-accent focus:outline-none"
                                            rows="3"
                                            placeholder="Add a new remark..."
                                        ></textarea>
                                        <div className="flex justify-end mt-2">
                                            <button
                                                onClick={handleAddRemark}
                                                className="medical-button px-4 py-2 text-white rounded-lg text-sm relative z-10"
                                            >
                                                Add Remark
                                            </button>
                                        </div>
                                    </div>

                                    <div className="space-y-3">
                                        {patientRemarks.length > 0 ? (
                                            patientRemarks.map(remark => (
                                                <div key={remark.id} className="table-row p-4 border border-gray-200 rounded-lg">
                                                    <p className="text-sm text-medical-dark">{remark.text}</p>
                                                    <div className="text-xs text-medical-gray mt-2">
                                                        <span>By {remark.author?.username || 'Unknown'} on </span>
                                                        <span>{new Date(remark.created_at).toLocaleString()}</span>
                                                    </div>
                                                </div>
                                            ))
                                        ) : (
                                            <p className="text-sm text-medical-gray text-center py-4">No remarks for this patient yet.</p>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Prescriptions Component
        const Prescriptions = () => {
            const [prescriptions, setPrescriptions] = React.useState([]);
            const [loading, setLoading] = React.useState(true);

            React.useEffect(() => {
                // Mock data - replace with actual API call
                setTimeout(() => {
                    setPrescriptions([
                        {
                            id: 1,
                            patient: { name: 'John Doe', id: 1 },
                            medication_name: 'Lisinopril',
                            dosage: '10mg',
                            frequency: 'Once daily',
                            prescribed_date: '2024-01-15',
                            is_active: true,
                            prescriber: { username: 'Dr. Smith' }
                        },
                        {
                            id: 2,
                            patient: { name: 'Jane Smith', id: 2 },
                            medication_name: 'Metformin',
                            dosage: '500mg',
                            frequency: 'Twice daily',
                            prescribed_date: '2024-01-10',
                            is_active: true,
                            prescriber: { username: 'Dr. Johnson' }
                        }
                    ]);
                    setLoading(false);
                }, 500);
            }, []);

            if (loading) return <LoadingSpinner />;

            return (
                <div className="space-y-6">
                    <div className="flex items-center justify-between">
                        <h2 className="text-2xl font-bold text-medical-dark font-primary">Prescriptions</h2>
                        <button className="medical-button px-6 py-3 text-white rounded-xl font-secondary flex items-center space-x-2 relative z-10">
                            <i className="fas fa-plus"></i>
                            <span>New Prescription</span>
                        </button>
                    </div>

                    <div className="medical-card rounded-2xl overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-medical-light">
                                    <tr>
                                        <th className="text-left p-4 font-semibold text-medical-dark">Patient</th>
                                        <th className="text-left p-4 font-semibold text-medical-dark">Medication</th>
                                        <th className="text-left p-4 font-semibold text-medical-dark">Dosage</th>
                                        <th className="text-left p-4 font-semibold text-medical-dark">Frequency</th>
                                        <th className="text-left p-4 font-semibold text-medical-dark">Date</th>
                                        <th className="text-left p-4 font-semibold text-medical-dark">Status</th>
                                        <th className="text-left p-4 font-semibold text-medical-dark">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {prescriptions.map(prescription => (
                                        <tr key={prescription.id} className="table-row border-b border-gray-100">
                                            <td className="p-4">
                                                <div className="font-semibold text-medical-dark">{prescription.patient.name}</div>
                                                <div className="text-sm text-medical-gray">ID: {prescription.patient.id}</div>
                                            </td>
                                            <td className="p-4 text-medical-gray">{prescription.medication_name}</td>
                                            <td className="p-4 text-medical-gray">{prescription.dosage}</td>
                                            <td className="p-4 text-medical-gray">{prescription.frequency}</td>
                                            <td className="p-4 text-medical-gray">
                                                {new Date(prescription.prescribed_date).toLocaleDateString()}
                                            </td>
                                            <td className="p-4">
                                                <span className={`px-2 py-1 rounded-full text-xs ${prescription.is_active
                                                    ? 'bg-medical-success/10 text-medical-success'
                                                    : 'bg-medical-gray/10 text-medical-gray'
                                                    }`}>
                                                    {prescription.is_active ? 'Active' : 'Inactive'}
                                                </span>
                                            </td>
                                            <td className="p-4">
                                                <div className="flex space-x-2">
                                                    <button className="text-medical-accent hover:text-medical-dark">
                                                        <i className="fas fa-eye"></i>
                                                    </button>
                                                    <button className="text-medical-success hover:text-green-700">
                                                        <i className="fas fa-edit"></i>
                                                    </button>
                                                    <button className="text-medical-error hover:text-red-700">
                                                        <i className="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // Users Component (Admin Only)
        const Users = () => {
        const [users, setUsers] = React.useState([]);
        const [loading, setLoading] = React.useState(true);
        const [showModal, setShowModal] = React.useState(false);
        const [editingUser, setEditingUser] = React.useState(null);

        const fetchUsers = async () => {
        setLoading(true);
        try {
        const data = await api('/api/v1/users');
        setUsers(Array.isArray(data) ? data : data.users || []);
        } catch (error) {
        console.error('Error fetching users:', error);
        } finally {
        setLoading(false);
        }
        };

        React.useEffect(() => {
        fetchUsers();
        }, []);

        const handleEditUser = (user) => {
        setEditingUser(user);
        setShowModal(true);
        };

        const handleAddUser = () => {
        setEditingUser(null);
        setShowModal(true);
        };

        const handleCloseModal = () => {
        setShowModal(false);
        setEditingUser(null);
        };

        if (loading) return <LoadingSpinner />;

        return (
        <div className="space-y-6">
        <div className="flex items-center justify-between">
        <h2 className="text-2xl font-bold text-medical-dark font-primary">User Management</h2>
        <button
        onClick={handleAddUser}
        className="medical-button px-6 py-3 text-white rounded-xl font-secondary flex items-center space-x-2 relative z-10"
        >
        <i className="fas fa-user-plus"></i>
        <span>Add User</span>
        </button>
        </div>

        <div className="medical-card rounded-2xl overflow-hidden">
        <div className="overflow-x-auto">
        <table className="w-full">
        <thead className="bg-medical-light">
        <tr>
        <th className="text-left p-4 font-semibold text-medical-dark">User</th>
        <th className="text-left p-4 font-semibold text-medical-dark">Role</th>
        <th className="text-left p-4 font-semibold text-medical-dark">Email</th>
        <th className="text-left p-4 font-semibold text-medical-dark">Status</th>
        <th className="text-left p-4 font-semibold text-medical-dark">Last Login</th>
        <th className="text-left p-4 font-semibold text-medical-dark">Actions</th>
        </tr>
        </thead>
        <tbody>
        {users.map(user => (
        <tr key={user.id} className="table-row border-b border-gray-100">
        <td className="p-4">
        <div className="flex items-center space-x-3">
        <div className="w-10 h-10 bg-medical-accent/10 rounded-full flex items-center justify-center">
        <span className="text-medical-accent font-semibold">
        {user.username?.charAt(0).toUpperCase() || 'U'}
        </span>
        </div>
        <div>
        <div className="font-semibold text-medical-dark">{user.username}</div>
        <div className="text-sm text-medical-gray">ID: {user.id}</div>
        </div>
        </div>
        </td>
        <td className="p-4">
        <span className={`px-3 py-1 rounded-full text-xs font-medium capitalize ${user.role === 'admin' ? 'bg-medical-error/10 text-medical-error' :
        user.role === 'doctor' ? 'bg-medical-success/10 text-medical-success' :
        'bg-medical-accent/10 text-medical-accent'
        }`}>
        {user.role}
        </span>
        </td>
        <td className="p-4 text-medical-gray">{user.email}</td>
        <td className="p-4">
        <span className={`px-2 py-1 rounded-full text-xs ${user.is_active
        ? 'bg-medical-success/10 text-medical-success'
        : 'bg-medical-error/10 text-medical-error'
        }`}>
        {user.is_active ? 'Active' : 'Inactive'}
        </span>
        </td>
        <td className="p-4 text-medical-gray">
        {user.last_login ?
        new Date(user.last_login).toLocaleDateString() :
        'Never'
        }
        </td>
        <td className="p-4">
        <div className="flex space-x-2">
        <button
        onClick={() => handleEditUser(user)}
        className="text-medical-accent hover:text-medical-dark"
        >
        <i className="fas fa-edit"></i>
        </button>
        <button className="text-medical-success hover:text-green-700">
        <i className="fas fa-key"></i>
        </button>
        <button className="text-medical-error hover:text-red-700">
        <i className="fas fa-trash"></i>
        </button>
        </div>
        </td>
        </tr>
        ))}
        </tbody>
        </table>
        </div>
        </div>

        <Modal
        isOpen={showModal}
        onClose={handleCloseModal}
        title={editingUser ? 'Edit User' : 'Add New User'}
        >
        <UserEditor user={editingUser} onClose={handleCloseModal} refreshUsers={fetchUsers} />
        </Modal>
        </div>
        );
        };

                                // Prescription Editor Component
        const PrescriptionEditor = ({ prescription, onClose, refreshPrescriptions }) => {
            const [patientId, setPatientId] = React.useState(prescription?.patient_id || '');
            const [medication, setMedication] = React.useState(prescription?.medication_name || '');
            const [dosage, setDosage] = React.useState(prescription?.dosage || '');
            const [frequency, setFrequency] = React.useState(prescription?.frequency || '');
            const [duration, setDuration] = React.useState(prescription?.duration || '');
            const [patients, setPatients] = React.useState([]);
            const [errors, setErrors] = React.useState([]);

            React.useEffect(() => {
                const fetchPatients = async () => {
                    try {
                        const data = await api('/api/v1/patients');
                        setPatients(data || []);
                    } catch (err) {
                        console.error('Failed to fetch patients', err);
                    }
                };
                fetchPatients();
            }, []);

            React.useEffect(() => {
                const fetchAvailableSlots = async () => {
                    if (appointmentDate) {
                        try {
                            // Hardcoding location_id=1 for now
                            const slots = await api(`/api/v1/schedules/availability/1/${appointmentDate}`);
                            // The backend returns \"HH:MM:SS\", so we format it to \"HH:MM\"
                            setAvailableSlots(slots.map(slot => slot.substring(0, 5)) || []);
                        } catch (error) {
                            console.error('Error fetching available slots:', error);
                            setAvailableSlots([]); // Clear slots on error
                        }
                    } else {
                        setAvailableSlots([]);
                    }
                };
                fetchAvailableSlots();
            }, [appointmentDate]);

            const handleSubmit = async () => {
                setError('');
                if (!patientId || !medication || !dosage || !frequency || !duration) {
                    setError('All fields are required.');
                    return;
                }
                const payload = { patient_id: parseInt(patientId), medication_name: medication, dosage, frequency, duration };

                try {
                    await api('/api/v1/prescriptions', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    if(refreshPrescriptions) refreshPrescriptions();
                    onClose();
                } catch (err) {
                    setError('An error occurred. Please check the console and try again.');
                    console.error('Save prescription error:', err);
                }
            };

            return (
                <div className="space-y-6">
                    {errors.length > 0 && (
                        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg">
                            <p className="font-bold mb-2">Please fix the following issues:</p>
                            <ul className="list-disc list-inside text-sm">
                                {errors.map((err, index) => <li key={index}>{err}</li>)}
                            </ul>
                        </div>
                    )}
                    <div>
                        <label className="block text-sm font-medium text-medical-gray mb-2">Patient</label>
                        <select value={patientId} onChange={(e) => setPatientId(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:border-medical-accent focus:outline-none">
                            <option value="">Select a Patient</option>
                            {patients.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                        </select>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label className="block text-sm font-medium text-medical-gray mb-2">Medication Name</label>
                            <input type="text" value={medication} onChange={(e) => setMedication(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:border-medical-accent focus:outline-none" placeholder="e.g., Lisinopril" />
                        </div>
                         <div>
                            <label className="block text-sm font-medium text-medical-gray mb-2">Dosage</label>
                            <input type="text" value={dosage} onChange={(e) => setDosage(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:border-medical-accent focus:outline-none" placeholder="e.g., 10mg" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-medical-gray mb-2">Frequency</label>
                            <input type="text" value={frequency} onChange={(e) => setFrequency(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:border-medical-accent focus:outline-none" placeholder="e.g., Once daily" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-medical-gray mb-2">Duration</label>
                            <input type="text" value={duration} onChange={(e) => setDuration(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:border-medical-accent focus:outline-none" placeholder="e.g., 30 days" />
                        </div>
                    </div>
                    <div className="flex justify-end space-x-3">
                        <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                        <button onClick={handleSubmit} className="medical-button px-4 py-2 text-white rounded-lg relative z-10">
                            Create Prescription
                        </button>
                    </div>
                </div>
            );
        };

        // Appointment Editor Component
        const AppointmentEditor = ({ appointment, onClose, refreshAppointments }) => {
            const [patientId, setPatientId] = React.useState(appointment?.patient_id || '');
            const [locationId, setLocationId] = React.useState(appointment?.location_id || 1);
            const [appointmentDate, setAppointmentDate] = React.useState(appointment ? new Date(appointment.start_time).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]);
            const [appointmentTime, setAppointmentTime] = React.useState(appointment ? new Date(appointment.start_time).toTimeString().substring(0, 5) : '');
            const [reason, setReason] = React.useState(appointment?.reason || '');
            const [patients, setPatients] = React.useState([]);
            const [error, setError] = React.useState('');

            // New state for creating a new patient
            const [isNewPatient, setIsNewPatient] = React.useState(false);
            const [firstName, setFirstName] = React.useState('');
            const [lastName, setLastName] = React.useState('');
            const [dob, setDob] = React.useState('');
            const [city, setCity] = React.useState('');

            // New state for patient search
            const [patientSearch, setPatientSearch] = React.useState('');
            const [filteredPatients, setFilteredPatients] = React.useState([]);
            const [availableSlots, setAvailableSlots] = React.useState([]);


            React.useEffect(() => {
                const fetchPatients = async () => {
                    try {
                        const data = await api('/api/v1/patients');
                        setPatients(data || []);
                    } catch (err) {
                        console.error('Failed to fetch patients', err);
                    }
                };
                fetchPatients();
            }, []);

            const handlePatientSearch = (e) => {
                const searchTerm = e.target.value;
                setPatientSearch(searchTerm);
                if (searchTerm) {
                    setFilteredPatients(
                        patients.filter(p =>
                            p.name.toLowerCase().includes(searchTerm.toLowerCase())
                        )
                    );
                } else {
                    setFilteredPatients(patients);
                }
            };

            const selectPatient = (patient) => {
                setPatientId(patient.id);
                setPatientSearch(patient.name);
                setFilteredPatients([]);
            };


            const handleSubmit = async () => {
                const validationErrors = [];
                if (!isNewPatient) {
                    if (!patientId) validationErrors.push('An existing patient must be selected.');
                } else {
                    if (!firstName) validationErrors.push('First Name is a required field.');
                    if (!dob) validationErrors.push('Date of Birth is a required field.');
                }
                if (!appointmentDate) validationErrors.push('Appointment Date is required.');
                if (!appointmentTime) validationErrors.push('Appointment Time is required.');

                if (validationErrors.length > 0) {
                    setErrors(validationErrors);
                    return;
                }
                setErrors([]);
                
                // Calculate end time
                const startTimeObj = new Date(`${appointmentDate}T${appointmentTime}`);
                const endTimeObj = new Date(startTimeObj.getTime() + 15 * 60000); // Add 15 minutes

                const formatToLocalDateTimeString = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    return `${year}-${month}-${day}T${hours}:${minutes}:00`;
                };

                const formattedStartTime = formatToLocalDateTimeString(startTimeObj);
                const formattedEndTime = formatToLocalDateTimeString(endTimeObj);

                let payload = {
                    location_id: locationId,
                    start_time: formattedStartTime,
                    end_time: formattedEndTime,
                    reason
                };

                if (isNewPatient) {
                    payload.patient = {
                        first_name: firstName,
                        last_name: lastName,
                        date_of_birth: dob,
                        city: city
                    };
                } else {
                    payload.patient_id = parseInt(patientId);
                }


                try {
                    await api('/api/v1/appointments', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    if(refreshAppointments) refreshAppointments();
                    onClose();
                } catch (err) {
                    setError('An error occurred. Please check the console and try again.');
                    console.error('Save appointment error:', err);
                }
            };

            return (
                <div className="space-y-6">
                    {error && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg">{error}</div>}

                    {/* New Patient Toggle */}
                    <div className="flex items-center justify-center bg-gray-100 p-1 rounded-lg">
                        <button
                            onClick={() => setIsNewPatient(false)}
                            className={`flex-1 py-2 px-4 rounded-md font-medium transition-all ${!isNewPatient ? 'bg-white shadow text-medical-accent' : 'text-medical-gray'}`}
                        >
                            Existing Patient
                        </button>
                        <button
                            onClick={() => setIsNewPatient(true)}
                            className={`flex-1 py-2 px-4 rounded-md font-medium transition-all ${isNewPatient ? 'bg-white shadow text-medical-accent' : 'text-medical-gray'}`}
                        >
                            New Patient
                        </button>
                    </div>


                    {isNewPatient ? (
                        <div className="space-y-4 animate-fade-in">
                            <h3 className="text-lg font-semibold text-medical-dark">New Patient Details</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label className="block text-sm font-medium text-medical-gray mb-2">First Name <span className="text-red-500">*</span></label>
                                    <input type="text" value={firstName} onChange={(e) => setFirstName(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:border-medical-accent focus:outline-none" placeholder="Enter first name" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-medical-gray mb-2">Last Name</label>
                                    <input type="text" value={lastName} onChange={(e) => setLastName(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:border-medical-accent focus:outline-none" placeholder="Enter last name" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-medical-gray mb-2">Date of Birth <span className="text-red-500">*</span></label>
                                    <input type="date" value={dob} onChange={(e) => setDob(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:border-medical-accent focus:outline-none" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-medical-gray mb-2">City</label>
                                    <input type="text" value={city} onChange={(e) => setCity(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:border-medical-accent focus:outline-none" placeholder="Enter city" />
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div className="animate-fade-in">
                            <label className="block text-sm font-medium text-medical-gray mb-2">Patient</label>
                            <div className="relative">
                                <input
                                    type="text"
                                    value={patientSearch}
                                    onChange={handlePatientSearch}
                                    onFocus={() => setFilteredPatients(patients.filter(p => p.name.toLowerCase().includes(patientSearch.toLowerCase())))}
                                    onBlur={() => setTimeout(() => setFilteredPatients([]), 200)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:border-medical-accent focus:outline-none"
                                    placeholder="Search for an existing patient..."
                                />
                                {filteredPatients.length > 0 && (
                                    <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                        {filteredPatients.map(p => (
                                            <div
                                                key={p.id}
                                                onClick={() => selectPatient(p)}
                                                className="p-3 hover:bg-medical-light cursor-pointer"
                                            >
                                                {p.name}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}


                    <div className="border-t border-gray-200 pt-4 space-y-4">
                        <h3 className="text-lg font-semibold text-medical-dark">Appointment Details</h3>
                         <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label className="block text-sm font-medium text-medical-gray mb-2">Date <span className="text-red-500">*</span></label>
                                <input type="date" value={appointmentDate} onChange={(e) => setAppointmentDate(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:border-medical-accent focus:outline-none" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-medical-gray mb-2">Time <span className="text-red-500">*</span></label>
                                {appointmentDate ? (
                                    availableSlots.length > 0 ? (
                                        <div className="grid grid-cols-4 gap-2">
                                            {availableSlots.map(slot => (
                                                <button
                                                    key={slot}
                                                    type="button"
                                                    onClick={() => setAppointmentTime(slot)}
                                                    className={`p-2 rounded-lg border text-sm transition-all ${appointmentTime === slot ? 'bg-medical-accent text-white border-medical-accent font-semibold shadow' : 'border-gray-300 hover:border-medical-accent hover:text-medical-accent'}`}
                                                >
                                                    {new Date(`1970-01-01T${slot}`).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true })}
                                                </button>
                                            ))}
                                        </div>
                                    ) : (
                                        <p className="text-medical-gray text-sm p-3 bg-gray-50 rounded-lg">No available slots for this date.</p>
                                    )
                                ) : (
                                    <p className="text-medical-gray text-sm p-3 bg-gray-50 rounded-lg">Select a date to see available times.</p>
                                )}
                            </div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-medical-gray mb-2">Reason for Visit</label>
                            <textarea value={reason} onChange={(e) => setReason(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:border-medical-accent focus:outline-none" rows="3" placeholder="Enter reason for appointment"></textarea>
                        </div>
                    </div>


                    <div className="flex justify-end space-x-3">
                        <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                        <button onClick={handleSubmit} className="medical-button px-4 py-2 text-white rounded-lg relative z-10">
                            Create Appointment
                        </button>
                    </div>
                </div>
            );
        };

        // Patient Editor Component
        const PatientEditor = ({ patient, onClose, refreshPatients }) => {
            const [firstName, setFirstName] = React.useState(patient?.first_name || '');
            const [lastName, setLastName] = React.useState(patient?.last_name || '');
            const [phoneNumber, setPhoneNumber] = React.useState(patient?.phone_number || '');
            const [email, setEmail] = React.useState(patient?.email || '');
            const [dob, setDob] = React.useState(patient?.date_of_birth || '');
            const [error, setError] = React.useState('');

            const handleSubmit = async () => {
                setError('');
                if (!firstName) {
                    setError('Patient first name is required.');
                    return;
                }
                const payload = { 
                    first_name: firstName, 
                    last_name: lastName, 
                    phone_number: phoneNumber, 
                    email, 
                    date_of_birth: dob 
                };

                try {
                    if (patient) {
                        // Update logic would go here
                    } else {
                        await api('/api/v1/patients', {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        });
                    }
                    if(refreshPatients) refreshPatients();
                    onClose();
                } catch (err) {
                    setError('An error occurred. Please check the console and try again.');
                    console.error('Save patient error:', err);
                }
            };

            return (
                <div className="space-y-6">
                    {error && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg">{error}</div>}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label className="block text-sm font-medium text-medical-gray mb-2">First Name</label>
                            <input type="text" value={firstName} onChange={(e) => setFirstName(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:border-medical-accent focus:outline-none" placeholder="Enter first name" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-medical-gray mb-2">Last Name</label>
                            <input type="text" value={lastName} onChange={(e) => setLastName(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:border-medical-accent focus:outline-none" placeholder="Enter last name" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-medical-gray mb-2">Date of Birth</label>
                            <input type="date" value={dob} onChange={(e) => setDob(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:border-medical-accent focus:outline-none" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-medical-gray mb-2">Phone Number</label>
                            <input type="tel" value={phoneNumber} onChange={(e) => setPhoneNumber(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:border-medical-accent focus:outline-none" placeholder="Enter phone number" />
                        </div>
                        <div className="md:col-span-2">
                            <label className="block text-sm font-medium text-medical-gray mb-2">Email</label>
                            <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:border-medical-accent focus:outline-none" placeholder="Enter email" />
                        </div>
                    </div>
                    <div className="flex justify-end space-x-3">
                        <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                        <button onClick={handleSubmit} className="medical-button px-4 py-2 text-white rounded-lg relative z-10">
                            {patient ? 'Update Patient' : 'Create Patient'}
                        </button>
                    </div>
                </div>
            );
        };

        // User Editor Component
        const UserEditor = ({ user, onClose, refreshUsers }) => {
            const [username, setUsername] = React.useState(user?.username || '');
            const [email, setEmail] = React.useState(user?.email || '');
            const [role, setRole] = React.useState(user?.role || 'staff');
            const [phoneNumber, setPhoneNumber] = React.useState(user?.phone_number || '');
            const [password, setPassword] = React.useState('');
            const [isActive, setIsActive] = React.useState(user ? user.is_active : true);
            const [error, setError] = React.useState('');

            const handleSubmit = async () => {
                setError('');
                const payload = {
                    username, email, role, phone_number: phoneNumber, is_active: isActive
                };

                if (!user || password) {
                    if (password.length < 8) {
                        setError('Password must be at least 8 characters long.');
                        return;
                    }
                    payload.password = password;
                }

                try {
                    if (user) {
                        await api(`/api/v1/users/${user.id}`, {
                            method: 'PUT',
                            body: JSON.stringify(payload)
                        });
                    } else {
                        await api('/api/v1/users', {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        });
                    }
                    refreshUsers();
                    onClose();
                } catch (err) {
                    setError('An error occurred. Please try again.');
                    console.error('Save user error:', err);
                }
            };

            return (
                <div className="space-y-6">
                    {error && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg">{error}</div>}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label className="block text-sm font-medium text-medical-gray mb-2">Username</label>
                            <input
                                type="text"
                                value={username}
                                onChange={(e) => setUsername(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg focus:border-medical-accent focus:outline-none"
                                placeholder="Enter username"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-medical-gray mb-2">Email</label>
                            <input
                                type="email"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg focus:border-medical-accent focus:outline-none"
                                placeholder="Enter email"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-medical-gray mb-2">Role</label>
                            <select
                                value={role}
                                onChange={(e) => setRole(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg focus:border-medical-accent focus:outline-none"
                            >
                                <option value="staff">Staff</option>
                                <option value="doctor">Doctor</option>
                                <option value="nurse">Nurse</option>
                                <option value="receptionist">Receptionist</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-medical-gray mb-2">Phone Number</label>
                            <input
                                type="tel"
                                value={phoneNumber}
                                onChange={(e) => setPhoneNumber(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg focus:border-medical-accent focus:outline-none"
                                placeholder="Enter phone number"
                            />
                        </div>
                    </div>

                    {!user && (
                        <div>
                            <label className="block text-sm font-medium text-medical-gray mb-2">Password</label>
                            <input
                                type="password"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg focus:border-medical-accent focus:outline-none"
                                placeholder="Enter new password"
                            />
                        </div>
                    )}

                    <div className="flex items-center space-x-4">
                        <label className="flex items-center space-x-2">
                            <input
                                type="checkbox"
                                checked={isActive}
                                onChange={(e) => setIsActive(e.target.checked)}
                                className="w-4 h-4 text-medical-accent rounded focus:ring-medical-accent"
                            />
                            <span>Active User</span>
                        </label>
                        <label className="flex items-center space-x-2">
                            <input
                                type="checkbox"
                                defaultChecked={user?.mfa_enabled}
                                className="w-4 h-4 text-medical-accent rounded focus:ring-medical-accent"
                            />
                            <span>Enable MFA</span>
                        </label>
                    </div>

                    <div className="flex justify-end space-x-3">
                        <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                            Cancel
                        </button>
                        <button onClick={handleSubmit} className="medical-button px-4 py-2 text-white rounded-lg relative z-10">
                            {user ? 'Update User' : 'Create User'}
                        </button>
                    </div>
                </div>
            );
        };

        // Daily Unavailability Editor Component
        const DailyUnavailabilityEditor = ({ date, onClose }) => {
            const [startDate, setStartDate] = React.useState(date ? date.toISOString().split('T')[0] : '');
            const [endDate, setEndDate] = React.useState(date ? date.toISOString().split('T')[0] : '');
            const [reason, setReason] = React.useState('');
            const [error, setError] = React.useState('');

            const handleSubmit = async () => {
                setError('');
                if (!startDate || !endDate) {
                    setError('Start date and end date are required.');
                    return;
                }

                const startDateTime = new Date(startDate);
                const endDateTime = new Date(endDate);
                endDateTime.setHours(23, 59, 59); // Set to end of day

                const payload = {
                    location_id: 1, // Hardcoding location_id=1 for now
                    start_datetime: startDateTime.toISOString(),
                    end_datetime: endDateTime.toISOString(),
                    reason: reason,
                };

                try {
                    await api('/api/v1/unavailable-periods/', {
                        method: 'POST',
                        body: JSON.stringify(payload),
                    });
                    onClose(); // Close modal on success
                } catch (err) {
                    setError('An error occurred. Please try again.');
                    console.error('Save unavailable period error:', err);
                }
            };

            return (
                <div className="space-y-6">
                    {error && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg">{error}</div>}
                    <div>
                        <label className="block text-sm font-medium text-medical-gray mb-2">Block Off Dates</label>
                        <p className="text-sm text-medical-gray">Select a date range to mark as unavailable for online bookings.</p>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label className="block text-sm font-medium text-medical-gray mb-2">Start Date</label>
                            <input type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:border-medical-accent focus:outline-none" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-medical-gray mb-2">End Date</label>
                            <input type="date" value={endDate} onChange={(e) => setEndDate(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:border-medical-accent focus:outline-none" />
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-medical-gray mb-2">Reason (Optional)</label>
                        <input type="text" value={reason} onChange={(e) => setReason(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:border-medical-accent focus:outline-none" placeholder="e.g., Holiday, Personal Leave" />
                    </div>
                    <div className="flex justify-end space-x-3">
                        <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                        <button onClick={handleSubmit} className="medical-button px-4 py-2 text-white rounded-lg relative z-10">
                            Save Block
                        </button>
                    </div>
                </div>
            );
        };

        // Log Viewer Component (Advanced)
        const LogViewer = () => {
            const [logs, setLogs] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [filters, setFilters] = React.useState({
                userId: '',
                category: '',
                startDate: '',
                endDate: '',
            });
            const [users, setUsers] = React.useState([]); // For the user filter dropdown

            // Fetch users for the filter dropdown
            React.useEffect(() => {
                const fetchUsers = async () => {
                    try {
                        const data = await api('/api/v1/users');
                        setUsers(Array.isArray(data) ? data : []);
                    } catch (error) {
                        console.error('Error fetching users:', error);
                    }
                };
                fetchUsers();
            }, []);

            // Fetch logs based on filters
            React.useEffect(() => {
                const fetchLogs = async () => {
                    setLoading(true);
                    const params = new URLSearchParams();
                    if (filters.userId) params.append('user_id', filters.userId);
                    if (filters.category) params.append('category', filters.category);
                    if (filters.startDate) params.append('start_date', filters.startDate);
                    if (filters.endDate) params.append('end_date', filters.endDate);

                    try {
                        const data = await api(`/api/v1/logs?${params.toString()}`);
                        setLogs(Array.isArray(data) ? data : []);
                    } catch (error) {
                        console.error('Error fetching logs:', error);
                        setLogs([]);
                    } finally {
                        setLoading(false);
                    }
                };
                // Debounce the fetch
                const handler = setTimeout(() => fetchLogs(), 500);
                return () => clearTimeout(handler);
            }, [filters]);

            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
            };

            const logCategories = ['GENERAL', 'AUTHENTICATION', 'PATIENT', 'APPOINTMENT', 'USER'];

            const getSeverityClass = (severity) => {
                switch(severity) {
                    case 'CRITICAL': return 'bg-red-600 text-white';
                    case 'ERROR': return 'bg-red-200 text-red-800';
                    case 'WARN': return 'bg-yellow-200 text-yellow-800';
                    default: return 'bg-blue-200 text-blue-800';
                }
            };
            
            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold text-medical-dark font-primary">Audit Logs</h2>

                    <div className="p-4 bg-gray-50 rounded-xl border border-gray-200 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label className="text-sm font-medium text-medical-gray">User</label>
                            <select name="userId" value={filters.userId} onChange={handleFilterChange} className="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                                <option value="">All Users</option>
                                {users.map(user => <option key={user.id} value={user.id}>{user.username}</option>)}                            </select>
                        </div>
                        <div>
                            <label className="text-sm font-medium text-medical-gray">Category</label>
                            <select name="category" value={filters.category} onChange={handleFilterChange} className="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                                <option value="">All Categories</option>
                                {logCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}                            </select>
                        </div>
                        <div>
                            <label className="text-sm font-medium text-medical-gray">Start Date</label>
                            <input type="date" name="startDate" value={filters.startDate} onChange={handleFilterChange} className="mt-1 w-full p-2 border border-gray-300 rounded-lg" />
                        </div>
                        <div>
                            <label className="text-sm font-medium text-medical-gray">End Date</label>
                            <input type="date" name="endDate" value={filters.endDate} onChange={handleFilterChange} className="mt-1 w-full p-2 border border-gray-300 rounded-lg" />
                        </div>
                    </div>

                    <div className="medical-card rounded-2xl overflow-hidden">
                        <div className="overflow-x-auto">
                            {loading ? <LoadingSpinner /> : (
                                <table className="w-full">
                                    <thead className="bg-medical-light">
                                        <tr>
                                            <th className="text-left p-4 font-semibold text-medical-dark">Timestamp</th>
                                            <th className="text-left p-4 font-semibold text-medical-dark">User</th>
                                            <th className="text-left p-4 font-semibold text-medical-dark">Category</th>
                                            <th className="text-left p-4 font-semibold text-medical-dark">Severity</th>
                                            <th className="text-left p-4 font-semibold text-medical-dark">Action</th>
                                            <th className="text-left p-4 font-semibold text-medical-dark">Details</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {logs.map(log => (
                                            <tr key={log.id} className="table-row border-b border-gray-100">
                                                <td className="p-4 text-medical-gray text-sm whitespace-nowrap">{new Date(log.timestamp).toLocaleString()}</td>
                                                <td className="p-4 text-medical-gray">{log.username || 'System'}</td>
                                                <td className="p-4">
                                                    <span className="px-2 py-1 bg-gray-200 text-gray-800 rounded-full text-xs font-medium">
                                                        {log.category}
                                                    </span>
                                                </td>
                                                <td className="p-4">
                                                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${getSeverityClass(log.severity)}`}>
                                                        {log.severity}
                                                    </span>
                                                </td>
                                                <td className="p-4 text-medical-gray">{log.action}</td>
                                                <td className="p-4 text-medical-gray text-sm">{log.details || 'N/A'}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>
                        {!loading && logs.length === 0 && (
                            <div className="text-center py-12">
                                <i className="fas fa-clipboard-list text-4xl text-medical-gray mb-4"></i>
                                <p className="text-medical-gray">No logs found for the selected filters.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const [user, setUser] = React.useState(() => {
                const userData = sessionStorage.getItem('user');
                return userData ? JSON.parse(userData) : null;
            });
            const [currentView, setCurrentView] = React.useState('dashboard');
            const [isModalOpen, setIsModalOpen] = React.useState(false);
            const [modalTitle, setModalTitle] = React.useState('');
            const [modalContent, setModalContent] = React.useState(null);

            const openModal = (title, content) => {
                setModalTitle(title);
                setModalContent(content);
                setIsModalOpen(true);
            };

            const closeModal = () => {
                setIsModalOpen(false);
                setModalTitle('');
                setModalContent(null);
            };

            // Route guard
            React.useEffect(() => {
                const token = sessionStorage.getItem('accessToken');
                if (!token || !user) {
                    window.location.href = './admin_login.html';
                }
            }, [user]);

            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <LoadingSpinner />
                    </div>
                );
            }

            const renderCurrentView = () => {
                switch (currentView) {
                    case 'dashboard':
                        return <Dashboard openModal={openModal} closeModal={closeModal} />;
                    case 'appointments':
                        return <Appointments />;
                    case 'schedule':
                        return <DoctorSchedule />;
                    case 'patients':
                        return <Patients />;
                    case 'prescriptions':
                        return <Prescriptions />;
                    case 'users':
                        return user.role === 'admin' ? <Users /> : <Dashboard />;
                    case 'logs':
                        return user.role === 'admin' ? <LogViewer /> : <Dashboard />;
                    default:
                        return <Dashboard />;
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-medical-light-gray via-medical-light to-medical-light-gray">
                    <div className="flex h-screen">
                        <Sidebar
                            currentView={currentView}
                            setCurrentView={setCurrentView}
                            user={user}
                        />
                        <main className="flex-1 overflow-auto">
                            <div className="p-8">
                                <div className="max-w-7xl mx-auto floating-elements relative">
                                    {renderCurrentView()}
                                    <Modal
                                        isOpen={isModalOpen}
                                        onClose={closeModal}
                                        title={modalTitle}
                                    >
                                        {modalContent}
                                    </Modal>
                                </div>
                            </div>
                        </main>
                    </div>
                </div>
            );
        };

        // Render the App
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>

</html>