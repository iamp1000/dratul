<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Admin Dashboard - Dr. Dhingra's Clinic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'medical-blue': '#0B4D6B',
                        'medical-light': '#E6F3F8',
                        'medical-accent': '#2196F3',
                        'medical-success': '#10B981',
                        'medical-warning': '#F59E0B',
                        'medical-error': '#EF4444',
                        'medical-dark': '#1E293B',
                        'medical-gray': '#64748B',
                        'medical-light-gray': '#F8FAFC',
                    },
                    fontFamily: {
                        'primary': ['Poppins', 'sans-serif'],
                        'secondary': ['Inter', 'sans-serif']
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'pulse-gentle': 'pulseGentle 2s infinite',
                        'slide-in-right': 'slideInRight 0.3s ease-out',
                        'bounce-gentle': 'bounceGentle 0.5s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(30px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        slideInRight: {
                            '0%': { opacity: '0', transform: 'translateX(20px)' },
                            '100%': { opacity: '1', transform: 'translateX(0)' }
                        },
                        bounceGentle: {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(1.05)' }
                        },
                        pulseGentle: {
                            '0%, 100%': { opacity: '0.4' },
                            '50%': { opacity: '0.6' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #F8FAFC 0%, #E6F3F8 50%, #F8FAFC 100%);
            min-height: 100vh;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .medical-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
        }

        .sidebar-gradient {
            background: linear-gradient(135deg, #0B4D6B 0%, #2196F3 100%);
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(230, 243, 248, 0.4) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(33, 150, 243, 0.1);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(33, 150, 243, 0.2);
            background: linear-gradient(135deg, rgba(255, 255, 255, 1) 0%, rgba(230, 243, 248, 0.6) 100%);
        }

        .nav-item {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .nav-item:hover::before {
            left: 100%;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: inset 4px 0 0 rgba(255, 255, 255, 0.8);
        }

        .calendar-cell {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .calendar-cell:hover {
            background: rgba(33, 150, 243, 0.1);
            transform: scale(1.05);
        }

        .appointment-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin: 1px;
        }

        .medical-button {
            background: linear-gradient(135deg, #2196F3 0%, #0B4D6B 100%);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .medical-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .medical-button:hover::before {
            left: 100%;
        }

        .medical-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(33, 150, 243, 0.4);
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .editor-shell {
            display: grid;
            grid-template-columns: 340px 1fr;
            gap: 20px;
        }

        .editor-toolbar {
            position: sticky;
            top: 0;
            z-index: 20;
            background: #fff;
            border-bottom: 1px solid #e5e7eb;
        }

        .editor-page-wrap {
            display: flex;
            justify-content: center;
            padding: 20px 0;
            background: linear-gradient(180deg, #fafafa, #f3f4f6);
        }

        .editor-page {
            position: relative;
            width: 794px;
            min-height: 1123px;
            background: #fff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .08);
            border-radius: 12px;
            overflow: hidden;
        }

        .editor-template-overlay {
            position: absolute;
            inset: 0;
            background-position: center top;
            background-repeat: no-repeat;
            background-size: contain;
            opacity: .18;
            pointer-events: none;
        }

        .editor-content {
            position: relative;
            padding: 48px 56px;
        }

        .ql-toolbar.ql-snow {
            border: none;
            border-bottom: 1px solid #e5e7eb;
        }

        .ql-container.ql-snow {
            border: none;
            font-size: 15px;
            line-height: 1.7;
        }

        .floating-elements::before {
            content: '';
            position: absolute;
            top: -50px;
            right: -50px;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(33, 150, 243, 0.05) 0%, transparent 70%);
            border-radius: 50%;
            animation: pulse-gentle 3s infinite;
        }

        .table-row {
            transition: all 0.2s ease;
        }

        .table-row:hover {
            background: rgba(33, 150, 243, 0.05);
            transform: scale(1.01);
        }

        .scroll-custom::-webkit-scrollbar {
            width: 6px;
        }

        .scroll-custom::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }

        .scroll-custom::-webkit-scrollbar-thumb {
            background: #2196F3;
            border-radius: 3px;
        }

        .scroll-custom::-webkit-scrollbar-thumb:hover {
            background: #0B4D6B;
        }

        .custom-select {
            background: #ffffff url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e") no-repeat right 12px center/16px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px 40px 12px 16px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            width: 100%;
            color: #374151;
            appearance: none;
        }

        .custom-select:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
            background-color: #fafbfc;
        }

        .custom-select:hover {
            border-color: #d1d5db;
        }

        .custom-textarea {
            background: #ffffff;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            width: 100%;
            color: #374151;
            resize: vertical;
            min-height: 100px;
        }

        .custom-textarea:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
            background: #fafbfc;
        }

        .custom-textarea:hover {
            border-color: #d1d5db;
        }

        .custom-textarea::placeholder {
            color: #9ca3af;
            font-size: 14px;
        }

        .custom-datetime {
            background: #ffffff;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            width: 100%;
            color: #374151;
        }

        .custom-datetime:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
            background: #fafbfc;
        }

        .custom-datetime:hover {
            border-color: #d1d5db;
        }

        .custom-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid #e5e7eb;
            border-radius: 4px;
            background: #ffffff;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .custom-checkbox:checked {
            background: #2196F3;
            border-color: #2196F3;
        }

        .custom-checkbox:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .custom-checkbox:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .custom-file {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .custom-file input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .custom-file-label {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: #ffffff;
            border: 2px dashed #e5e7eb;
            border-radius: 12px;
            font-size: 14px;
            color: #6b7280;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .custom-file:hover .custom-file-label {
            border-color: #2196F3;
            color: #2196F3;
        }

        .custom-file input[type=file]:focus+.custom-file-label {
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .custom-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
            font-family: 'Inter', sans-serif;
        }

        .custom-label.required::after {
            content: '*';
            color: #ef4444;
            margin-left: 4px;
        }

        .custom-input.error,
        .custom-select.error,
        .custom-textarea.error,
        .custom-datetime.error {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .custom-input.error:focus,
        .custom-select.error:focus,
        .custom-textarea.error:focus,
        .custom-datetime.error:focus {
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }

        .error-message {
            color: #ef4444;
            font-size: 12px;
            margin-top: 4px;
            font-family: 'Inter', sans-serif;
        }
    </style>

</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const API_BASE_URL = 'http://127.0.0.1:8000';

        const api = async (url, options = {}) => {
            const token = sessionStorage.getItem('accessToken');
            if (!token) {
                window.location.href = './admin_login.html';
                return;
            }

            const config = {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    ...options.headers
                }
            };

            try {
                const res = await fetch(API_BASE_URL + url, config);
                if (res.status === 401) {
                    sessionStorage.clear();
                    window.location.href = './admin_login.html';
                    return;
                }
                const text = await res.text();
                let data = null;
                try { data = text ? JSON.parse(text) : null; } catch { }
                if (!res.ok) {

                    let errorString = 'Request failed';
                    if (data) {
                        if (data.detail) {

                            if (Array.isArray(data.detail)) {

                                errorString = data.detail.map(err => {
                                    const loc = err.loc?.join('->') || 'field';
                                    const msg = (typeof err.msg === 'string') ? err.msg : JSON.stringify(err.msg);
                                    return `${loc}: ${msg}`;
                                }).join(', ');
                            } else if (typeof data.detail === 'string') {

                                errorString = data.detail;
                            } else {

                                errorString = JSON.stringify(data.detail);
                            }
                        } else if (Array.isArray(data)) {

                            errorString = data.map(err => (typeof err === 'string') ? err : JSON.stringify(err)).join(', ');
                        } else if (data.message) {

                            errorString = data.message;
                        } else {

                            errorString = JSON.stringify(data);
                        }
                    } else {

                        errorString = text;
                    }
                    throw new Error(errorString);

                }
                return data;
            } catch (error) {

                console.error('API Error (parsed):', error.message);
                console.error('Full Error Object:', error);

                throw error;
            }
        };

        const LoadingSpinner = () => (
            <div className="flex items-center justify-center p-8">
                <div className="w-8 h-8 border-4 border-medical-accent border-t-transparent rounded-full animate-spin"></div>
            </div>
        );

        const StatCard = ({ icon, title, value, subtitle, color = "medical-accent" }) => (
            <div className="stat-card p-6 rounded-2xl medical-card animate-slide-up">
                <div className="flex items-center justify-between mb-4">
                    <div className={`w-12 h-12 bg-${color}/10 rounded-xl flex items-center justify-center`}>
                        <i className={`${icon} text-${color} text-xl`}></i>
                    </div>
                    <div className={`px-3 py-1 bg-${color}/10 text-${color} text-sm font-medium rounded-full`}>
                        {subtitle}
                    </div>
                </div>
                <div className="text-xl sm:text-2xl lg:text-3xl font-bold text-medical-dark mb-1">{value}</div>
                <div className="text-medical-gray font-secondary">{title}</div>
            </div>
        );

        const Modal = ({ isOpen, onClose, title, children, width = "max-w-2xl" }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
                    <div className={`bg-white rounded-2xl shadow-2xl ${width} max-h-[90vh] overflow-hidden animate-bounce-gentle flex flex-col`}>
                        <div className="flex items-center justify-between p-6 border-b border-gray-200 flex-shrink-0">
                            <h2 className="text-xl font-bold text-medical-dark font-primary">{title}</h2>
                            <button onClick={onClose} className="text-medical-gray hover:text-medical-dark">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div className="p-6 overflow-y-auto scroll-custom flex-grow">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const EmergencyBlockModal = ({ onClose }) => {
            const [blockDate, setBlockDate] = React.useState(new Date().toISOString().split('T')[0]);
            const [reason, setReason] = React.useState('');
            const [error, setError] = React.useState('');
            const [successMessage, setSuccessMessage] = React.useState('');

    React.useEffect(() => {

                if (window.flatpickr) {
                    window.flatpickr("#emergency-block-date-picker", {
                        dateFormat: "Y-m-d",
                        allowInput: true,
                        defaultDate: blockDate,

                        onChange: function (selectedDates, dateStr, instance) {
                            setBlockDate(dateStr);
                        }
                    });
                }

            }, []); 

            const handleSubmit = async () => {
                setError('');
                setSuccessMessage('');
                if (!blockDate || !reason) {
                    setError('Both date and reason are required.');
                    return;
                }

                const payload = {
                    block_date: blockDate,
                    reason: reason,
                };

                try {
                    const result = await api('/api/v1/unavailable-periods/emergency-block', {
                        method: 'POST',
                        body: JSON.stringify(payload),
                    });
                    setSuccessMessage(`Successfully cancelled ${result.length} appointment(s) and blocked the day.`);

                    setTimeout(() => onClose(), 3000);
                } catch (err) {

                    setError(err.message || 'An unexpected error occurred.');
                    console.error('Emergency block error:', err.message);
                }
            };

            return (
                <div className="space-y-6">
                    {}
                    {error && (
                        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4">
                            <p className="font-bold">Error:</p>
                            <p>{error}</p>
                        </div>
                    )}
                    {successMessage && <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg">{successMessage}</div>}
                    <div>
                        <label className="block text-sm font-medium text-medical-gray mb-2">Emergency Block</label>
                        <p className="text-sm text-medical-gray">This action will cancel all appointments for the selected day and notify patients via WhatsApp.</p>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-medical-gray mb-2">Date to Block</label>
                        <input type="date" id="emergency-block-date-picker" value={blockDate} onChange={(e) => setBlockDate(e.target.value)} className="form-input-themed" />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-medical-gray mb-2">Reason for Emergency</label>
                        <input type="text" value={reason} onChange={(e) => setReason(e.target.value)} className="form-input-themed" placeholder="e.g., Unforeseen personal matter" />
                    </div>
                    <div className="flex justify-end space-x-3">
                        <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                        <button onClick={handleSubmit} className="bg-red-600 hover:bg-red-700 px-4 py-2 text-white rounded-lg relative z-10">
                            Confirm Emergency Block
                        </button>
                    </div>
                </div>
            );
        };

        const Sidebar = ({ currentView, setCurrentView, user, isMobileMenuOpen, setIsMobileMenuOpen }) => {
            const menuItems = [
                { id: 'dashboard', label: 'Dashboard', icon: 'fas fa-home' },
                { id: 'appointments', label: 'Appointments', icon: 'fas fa-calendar-alt' },
                { id: 'schedule', label: 'Doctor Schedule', icon: 'fas fa-clock' },
                { id: 'patients', label: 'Patients', icon: 'fas fa-users' },

                { id: 'consultation', label: 'Consultation', icon: 'fas fa-notes-medical' }, 
                { id: 'users', label: 'Users', icon: 'fas fa-user-cog', adminOnly: true },
                { id: 'logs', label: 'Audit Logs', icon: 'fas fa-clipboard-list', adminOnly: true }
            ];

            const handleLogout = () => {
                sessionStorage.clear();
                window.location.href = './admin_login.html';
            };

            return (
                <>
                    {}
                    {
                        isMobileMenuOpen && (
                            <div
                                className="fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden"
                                onClick={() => setIsMobileMenuOpen(false)}
                            />
                        )
                    }

                    <div className={`w-64 sidebar-gradient text-white flex flex-col h-full overflow-y-auto fixed md:relative z-50 transition-transform duration-300 ${isMobileMenuOpen ? "translate-x-0" : "-translate-x-full md:translate-x-0"}`}>
                        <div className="p-6 border-b border-white/20">
                            <div className="flex items-center mb-4">
                                <div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center mr-3">
                                    <i className="fas fa-stethoscope text-white text-xl"></i>
                                </div>
                                <div>
                                    <h1 className="text-xl font-bold font-primary">Medical Portal</h1>
                                    <p className="text-blue-200 font-secondary text-sm">Dr. Dhingra's Clinic</p>
                                </div>
                            </div>
                            <div className="bg-white/10 p-3 rounded-xl">
                                <div className="flex items-center">
                                    <div className="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center mr-2">
                                        <i className="fas fa-user text-white text-sm"></i>
                                    </div>
                                    <div>
                                        <div className="font-semibold text-sm">{user?.username}</div>
                                        <div className="text-blue-200 text-xs capitalize">{user?.role}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <nav className="flex-1 p-4 space-y-2">
                            {menuItems.map(item => {
                                if (item.adminOnly && user?.role !== 'admin') return null;
                                return (
                                    <button
                                        key={item.id}
                                        onClick={() => setCurrentView(item.id)}
                                        className={`nav-item w-full text-left px-3 sm:px-4 py-3 sm:py-3 rounded-xl flex items-center space-x-3 font-secondary ${currentView === item.id ? 'active' : ''
                                            }`}
                                    >
                                        <i className={item.icon}></i>
                                        <span>{item.label}</span>
                                    </button>
                                );
                            })}
                        </nav>

                        <div className="p-4 border-t border-white/20">
                            <button
                                onClick={handleLogout}
                                className="nav-item w-full text-left px-3 sm:px-4 py-3 sm:py-3 rounded-xl flex items-center space-x-3 font-secondary text-red-200 hover:bg-red-500/10"
                            >
                                <i className="fas fa-sign-out-alt"></i>
                                <span>Logout</span>
                            </button>
                            </div>
                            </div>
                </>
            );
        };

        const Dashboard = ({ openModal, closeModal }) => {
            const [stats, setStats] = React.useState(null);
            const [recentPresc, setRecentPresc] = React.useState([]);
            const [loading, setLoading] = React.useState(true);

            React.useEffect(() => {
                const fetchStats = async () => {
                    try {
                        const data = await api('/api/v1/dashboard/stats');
                        setStats(data);
                    } catch (error) {
                        console.error('Error fetching stats:', error);
                    } finally {
                        setLoading(false);
                    }
                };
                const fetchRecent = async () => {
                    try {
                        const data = await api('/api/v1/prescriptions/recent?limit=5');
                        setRecentPresc(Array.isArray(data) ? data : []);
                    } catch { }
                };
                fetchStats();
                fetchRecent();
            }, []);

            if (loading) return <LoadingSpinner />;

            return (
                <div className="space-y-8">
                    <div className="flex items-center justify-between">
                        <h2 className="text-lg sm:text-xl lg:text-2xl font-bold text-medical-dark font-primary">Dashboard Overview</h2>
                        <div className="text-medical-gray font-secondary">
                            <i className="fas fa-calendar-day mr-2"></i>
                            {new Date().toLocaleDateString('en-US', {
                                weekday: 'long',
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            })}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <StatCard
                            icon="fas fa-users"
                            title="Total Patients"
                            value={stats?.total_patients || 0}
                            subtitle="All Time"
                            color="medical-success"
                        />
                        <StatCard
                            icon="fas fa-calendar-check"
                            title="Today's Appointments"
                            value={stats?.appointments_today || 0}
                            subtitle="Today"
                            color="medical-accent"
                        />
                        <StatCard
                            icon="fas fa-clock"
                            title="Pending Appointments"
                            value={stats?.pending_appointments || 0}
                            subtitle="Waiting"
                            color="medical-warning"
                        />
                        <StatCard
                            icon="fas fa-chart-line"
                            title="This Week"
                            value={stats?.appointments_week || 0}
                            subtitle="7 Days"
                            color="medical-blue"
                        />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div className="medical-card p-6 rounded-2xl">
                            <h3 className="text-lg font-bold text-medical-dark mb-4 font-primary">Quick Actions</h3>
                            <div className="space-y-3">
                                <button onClick={() => openModal('Create New Appointment', <AppointmentEditor onClose={closeModal} user={user} />)} className="medical-button w-full p-3 text-white rounded-xl font-secondary flex items-center justify-center space-x-2 relative z-10">
                                    <i className="fas fa-plus"></i>
                                    <span>New Appointment</span>
                                </button>
                                <button onClick={() => openModal('Add New Patient', <PatientEditor onClose={closeModal} />)} className="medical-button w-full p-3 text-white rounded-xl font-secondary flex items-center justify-center space-x-2 relative z-10">
                                    <i className="fas fa-user-plus"></i>
                                    <span>Add Patient</span>
                                </button>
                                {}
                            </div>
                        </div>

                        <div className="medical-card p-6 rounded-2xl">
                            <h3 className="text-lg font-bold text-medical-dark mb-4 font-primary">System Status</h3>
                            <div className="space-y-3">
                                <DashboardServices />
                            </div>
                        </div>
                    </div>

                    <div className="medical-card p-6 rounded-2xl mt-6">
                        <h3 className="text-lg font-bold text-medical-dark mb-4 font-primary">Recent Prescriptions</h3>
                        {recentPresc.length === 0 ? (
                            <div className="text-medical-gray text-sm">No recent prescriptions.</div>
                        ) : (
                            <div className="space-y-2">
                                {recentPresc.map(p => (
                                    <div key={p.id} className="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                                        <div>
                                            <div className="font-medium text-medical-dark">{p.medication_name}</div>
                                            <div className="text-sm text-medical-gray">Patient ID: {p.patient_id} • {new Date(p.prescribed_date).toLocaleDateString()}</div>
                                        </div>
                                        <div className="flex flex-wrap items-center gap-2">
                                            <button onClick={() => window.open(`/api/v1/prescriptions/editor/pdf/${p.document_id || ''}`, '_blank')} className="px-2 py-1 bg-gray-100 rounded text-sm">PDF</button>
                                            <button onClick={() => window.open(`/api/v1/prescriptions/editor/html/${p.document_id || ''}`, '_blank')} className="px-2 py-1 bg-gray-100 rounded text-sm">HTML</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const Calendar = ({ appointments, onDateClick, onAppointmentClick, currentDate, setCurrentDate }) => {

            const getDaysInMonth = (date) => {
                return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            };

            const getFirstDayOfMonth = (date) => {
                return new Date(date.getFullYear(), date.getMonth(), 1).getDay();
            };

            const getAppointmentsForDate = (date) => {
                if (!appointments) return [];
                return appointments.filter(apt => {
                    const aptDate = new Date(apt.start_time);
                    return aptDate.toDateString() === date.toDateString();
                });
            };

            const renderCalendarDays = () => {
                const daysInMonth = getDaysInMonth(currentDate);
                const firstDayOfMonth = getFirstDayOfMonth(currentDate);
                const days = [];

                for (let i = 0; i < firstDayOfMonth; i++) {
                    days.push(<div key={`empty-${i}`} className="p-2"></div>);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                    const dayAppointments = getAppointmentsForDate(date);
                    const isToday = date.toDateString() === new Date().toDateString();

                    days.push(
                        <div
                            key={day}
                            className={`calendar-cell p-2 border border-gray-200 rounded-lg min-h-[80px] ${isToday ? 'bg-medical-accent/10 border-medical-accent' : ''
                                }`}
                            onClick={() => onDateClick(date)}
                        >
                            <div className={`font-semibold mb-1 ${isToday ? 'text-medical-accent' : 'text-medical-dark'}`}>
                                {day}
                            </div>
                            <div className="space-y-1">
                                {dayAppointments.slice(0, 3).map(apt => (
                                    <div
                                        key={apt.id}
                                        className="text-xs p-1 bg-medical-accent/20 text-medical-accent rounded cursor-pointer hover:bg-medical-accent/30"
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            onAppointmentClick(apt);
                                        }}
                                    >
                                        {new Date(apt.start_time).toLocaleTimeString('en-US', {
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        })}
                                    </div>
                                ))}
                                {dayAppointments.length > 3 && (
                                    <div className="text-xs text-medical-gray">
                                        +{dayAppointments.length - 3} more
                                    </div>
                                )}
                            </div>
                        </div>
                    );
                }

                return days;
            };

            const navigateMonth = (direction) => {
                const newDate = new Date(currentDate);
                newDate.setMonth(currentDate.getMonth() + direction);
                setCurrentDate(newDate); 
            };

            return (
                <div className="medical-card p-6 rounded-2xl">
                    <div className="flex items-center justify-between mb-6">
                        <h3 className="text-xl font-bold text-medical-dark font-primary">
                            {currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                        </h3>
                        <div className="flex space-x-2">
                            <button
                                onClick={() => navigateMonth(-1)}
                                className="p-2 text-medical-accent hover:bg-medical-accent/10 rounded-lg"
                            >
                                <i className="fas fa-chevron-left"></i>
                            </button>
                            <button
                                onClick={() => navigateMonth(1)}
                                className="p-2 text-medical-accent hover:bg-medical-accent/10 rounded-lg"
                            >
                                <i className="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-7 gap-1 sm:gap-2">
                        {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                            <div key={day} className="p-2 text-center font-semibold text-medical-gray">
                                {day}
                            </div>
                        ))}
                        {renderCalendarDays()}
                    </div>
                </div>
            );
        };

        const Appointments = ({ openModal, closeModal, user }) => { 
            const [appointments, setAppointments] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [selectedAppointment, setSelectedAppointment] = React.useState(null);
            const [selectedDate, setSelectedDate] = React.useState(null);
            const [showModal, setShowModal] = React.useState(false);
            const [currentDate, setCurrentDate] = React.useState(new Date()); 

            const fetchAppointments = React.useCallback(async () => {
                setLoading(true);
                try {

                    const firstDay = new Date(Date.UTC(currentDate.getFullYear(), currentDate.getMonth(), 1)); 
                    const lastDay = new Date(Date.UTC(currentDate.getFullYear(), currentDate.getMonth() + 1, 0)); 

                    const toISODate = (d) => {
                        const year = d.getUTCFullYear();
                        const month = String(d.getUTCMonth() + 1).padStart(2, '0'); 
                        const day = String(d.getUTCDate()).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    };

                    const startDate = toISODate(firstDay);
                    const endDate = toISODate(lastDay);

                    console.log(`[Appointments] Fetching data for ${startDate} to ${endDate}`);
                    const data = await api(`/api/v1/appointments?start_date=${startDate}&end_date=${endDate}`);

                    setAppointments(Array.isArray(data) ? data : data.appointments || []);
                } catch (error) {
                    console.error("--- FAILED TO FETCH APPOINTMENTS ---");
                    console.error("The API returned an error:", error.message);
                    console.error("Full error object:", error);
                } finally {
                    setLoading(false);
                }
            }, [currentDate]); 

            React.useEffect(() => {
                fetchAppointments();
            }, [fetchAppointments]); 

            const handleDateClick = (date) => { 
                console.log("[Appointments] handleDateClick received:", date); 
                setSelectedDate(date);
                setShowModal(true);
            };

            const handleAppointmentClick = (appointment) => {
                setSelectedAppointment(appointment);
                setShowModal(true);
            };

            if (loading) return <LoadingSpinner />;

            return (
                <div className="space-y-8">
                    <div className="flex items-center justify-between">
                        <h2 className="text-lg sm:text-xl lg:text-2xl font-bold text-medical-dark font-primary">Appointments</h2>
                        {}
                        <button onClick={() => openModal('Create New Appointment', <AppointmentEditor onClose={closeModal} user={user} refreshAppointments={fetchAppointments} />)} className="medical-button px-6 py-3 text-white rounded-xl font-secondary flex flex-wrap items-center gap-2 relative z-10">
                            <i className="fas fa-plus"></i>
                            <span>New Appointment</span>
                        </button>
                    </div>

                    {}
                    <Calendar
                        appointments={appointments}
                        onDateClick={handleDateClick}
                        onAppointmentClick={handleAppointmentClick}
                        currentDate={currentDate}
                        setCurrentDate={setCurrentDate}
                    />

                    <Modal
                        isOpen={showModal}
                        onClose={() => {
                            setShowModal(false);
                            setSelectedAppointment(null);
                            setSelectedDate(null);
                        }}
                        title={selectedAppointment ? "Appointment Details" : "Daily View"} 
                        width="max-w-4xl"
                    >
                        {selectedAppointment ? (
                            <AppointmentDetails appointment={selectedAppointment} />
                        ) : selectedDate ? (

                            <DailyViewModalContent 
                                date={selectedDate} 
                                appointmentsForDate={appointments.filter(apt => 
                                    new Date(apt.start_time).toDateString() === selectedDate.toDateString()
                                )}
                            />
                        ) : null}
                    </Modal>
                </div>
            );
        };

        const DashboardServices = () => {
            const [status, setStatus] = React.useState(null);
            React.useEffect(() => { (async () => { try { const s = await api('/api/v1/services/status'); setStatus(s); } catch { setStatus(null); } })(); }, []);
            const pill = (label, ok) => (
                <div className="flex items-center justify-between p-3 rounded-xl border" style={{ backgroundColor: ok ? 'rgba(16,185,129,0.1)' : 'rgba(239,68,68,0.1)', borderColor: ok ? 'rgba(16,185,129,0.2)' : 'rgba(239,68,68,0.2)' }}>
                    <div className="flex items-center space-x-3">
                        <div className={`w-3 h-3 rounded-full ${ok ? 'bg-medical-success' : 'bg-medical-error'}`}></div>
                        <span className="font-secondary">{label}</span>
                    </div>
                    <span className={`text-sm font-medium ${ok ? 'text-medical-success' : 'text-medical-error'}`}>{ok ? 'Online' : 'Disabled'}</span>
                </div>
            );
            if (!status) return <LoadingSpinner />;
            return (
                <div className="space-y-2">
                    {pill('WhatsApp', !!status.whatsapp?.enabled)}
                    {pill('Email', !!status.email?.enabled)}
                    {pill('Google Calendar', !!status.calendar?.enabled)}
                </div>
            );
        };

const DaySlotsViewer = ({ date }) => {

     const [selectedLocationId, setSelectedLocationId] = React.useState(1); 
    const [slots, setSlots] = React.useState([]);
    const [loadingSlots, setLoadingSlots] = React.useState(false); 
    const [slotError, setSlotError] = React.useState(''); 

    const [weeklySchedule, setWeeklySchedule] = React.useState(null);
    const [scheduleLoading, setScheduleLoading] = React.useState(true);
    const [scheduleError, setScheduleError] = React.useState('');
    const [displayStatus, setDisplayStatus] = React.useState('loading-schedule'); 

                    React.useEffect(() => {
                        const fetchWeeklySchedules = async () => {
                            setScheduleLoading(true);
                            setScheduleError('');
                            try {

                                const [clinicScheduleData, hospitalScheduleData] = await Promise.all([
                                    api(`/api/v1/schedules/by-location/1`),
                                    api(`/api/v1/schedules/by-location/2`)
                                ]);

                                const clinicScheduleMap = (clinicScheduleData || []).reduce((acc, item) => {
                                    acc[item.day_of_week] = item;
                                    return acc;
                                }, {});
                                const hospitalScheduleMap = (hospitalScheduleData || []).reduce((acc, item) => {
                                    acc[item.day_of_week] = item;
                                    return acc;
                                }, {});

                                setWeeklySchedule({
                                    1: clinicScheduleMap, 
                                    2: hospitalScheduleMap
                                });
                                console.log("[DaySlotsViewer] Fetched weekly schedules:", { 1: clinicScheduleMap, 2: hospitalScheduleMap });

                            } catch (err) {
                                console.error("[DaySlotsViewer] Error fetching weekly schedules:", err);
                                setScheduleError(`Failed to load doctor's schedule: ${err.message}`);
                                setDisplayStatus('error');
                            } finally {
                                setScheduleLoading(false);
                            }
                        };

                        fetchWeeklySchedules();
                    }, []); 

    const toISODate = (d) => {
        if (!d) return '';
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0'); 
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    React.useEffect(() => {
        const checkAvailabilityAndFetchSlots = async () => {

            if (!date || scheduleLoading || !weeklySchedule) {
                if (scheduleError) setDisplayStatus('error');
                else if (scheduleLoading) setDisplayStatus('loading-schedule');
                return; 
            }

            setLoadingSlots(true);
            setSlotError('');
            setSlots([]);
            setDisplayStatus('loading-slots'); 
            const formattedDate = toISODate(date);
            const dayOfWeek = (date.getDay() + 6) % 7; 

            const locationSchedule = weeklySchedule[selectedLocationId];
            const daySchedule = locationSchedule ? locationSchedule[dayOfWeek] : null; 

            console.log(`[DaySlotsViewer] Checking schedule for Loc ${selectedLocationId}, Date ${formattedDate}, DayOfWeek ${dayOfWeek}:`, daySchedule);

            if (daySchedule && daySchedule.is_available === false) {
                console.log(`[DaySlotsViewer] Doctor marked as unavailable for Loc ${selectedLocationId} on Day ${dayOfWeek}.`);
                setSlotError('Doctor is unavailable on this day.');
                setDisplayStatus('unavailable');
                setLoadingSlots(false);
                return; 
            }

            try {
                console.log(`[DaySlotsViewer] Fetching slots for Loc ${selectedLocationId} on ${formattedDate}`);
                const fetchedSlots = await api(`/api/v1/slots/${selectedLocationId}/${formattedDate}`);
                console.log(`[DaySlotsViewer] Received raw data for Loc ${selectedLocationId}, Date ${formattedDate}:`, JSON.stringify(fetchedSlots));

                const validSlots = Array.isArray(fetchedSlots) ? fetchedSlots : [];
                setSlots(validSlots);

                if (validSlots.length === 0) {

                    if (!slotError) setSlotError('No slots generated or found for this day and location.');
                    setDisplayStatus('no-slots'); 
                } else {
                    setDisplayStatus('ready'); 
                }

            } catch (err) {
                console.error(`Error fetching slots for ${formattedDate}:`, err);
                setSlotError(`Failed to load slots: ${err.message}`);
                setSlots([]);
                setDisplayStatus('error'); 
            } finally {
                setLoadingSlots(false); 
            }
        };

        checkAvailabilityAndFetchSlots();
    }, [date, selectedLocationId, weeklySchedule, scheduleLoading, scheduleError]); 

    const getStatusColor = (status) => {
        switch (status) {
            case 'available': return 'bg-green-100 text-green-700 border-green-200';
            case 'booked': return 'bg-blue-100 text-blue-700 border-blue-200';
            case 'unavailable': return 'bg-gray-100 text-gray-500 border-gray-200';
            default: return 'bg-gray-100 text-gray-700 border-gray-200';
        }
    };

    return (
        <div className="space-y-4">
            {}
            <div className="flex space-x-1 bg-gray-100 p-1 rounded-xl mb-4">
                <button
                    onClick={() => setSelectedLocationId(1)}
                    className={`flex-1 py-2 px-4 rounded-lg font-medium transition-all text-sm ${selectedLocationId === 1 ? 'bg-white text-medical-accent shadow-sm' : 'text-medical-gray hover:text-medical-dark'}`}
                >
                <i className="fas fa-clinic-medical mr-1"></i> Home Clinic
                </button>
                <button
                    onClick={() => setSelectedLocationId(2)}
                    className={`flex-1 py-2 px-4 rounded-lg font-medium transition-all text-sm ${selectedLocationId === 2 ? 'bg-white text-medical-accent shadow-sm' : 'text-medical-gray hover:text-medical-dark'}`}
                >
                <i className="fas fa-hospital mr-1"></i> Hospital
                </button>
            </div>

            {}
            {displayStatus === 'loading-schedule' || displayStatus === 'loading-slots' ? (
                <LoadingSpinner />
            ) : displayStatus === 'error' || displayStatus === 'unavailable' ? (
                <div className="text-center py-6 text-red-600 bg-red-50 p-4 rounded-lg border border-red-200">
                    <i className={`fas ${displayStatus === 'unavailable' ? 'fa-calendar-times' : 'fa-exclamation-triangle'} text-2xl mb-2`}></i>
                     {}
                    <p className="text-sm">{slotError || scheduleError || 'An error occurred.'}</p>
                </div>
            ) : displayStatus === 'no-slots' || slots.length === 0 ? ( 
                <div className="text-center py-6 text-medical-gray bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <i className="fas fa-clock text-2xl mb-2"></i>
                    <p className="text-sm">No available appointment times found.</p>
                </div>
            ) : (
                <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-2">
                    {slots.map(slot => (
                        <div key={slot.id} className={`p-2 border rounded-lg text-center ${getStatusColor(slot.status)}`}>
                            <div className="font-semibold text-xs sm:text-sm">
                                {new Date(slot.start_time).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false })} {}
                            </div>
                            <div className="text-xs capitalize mt-1 opacity-80">
                                {slot.status}
                                {}
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
};

const DailyViewModalContent = ({ date, appointmentsForDate }) => {
    const [activeTab, setActiveTab] = React.useState('appointments'); 

    return (
        <div className="space-y-4">
             <h4 className="font-semibold text-medical-dark mb-0"> {}
                 {date.toLocaleDateString('en-US', {
                     weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                 })}
             </h4>
            {}
            <div className="flex space-x-1 bg-gray-100 p-1 rounded-xl">
                <button
                    onClick={() => setActiveTab('appointments')}
                    className={`flex-1 py-2 px-4 rounded-lg font-medium transition-all text-sm ${activeTab === 'appointments' ? 'bg-white text-medical-accent shadow-sm' : 'text-medical-gray hover:text-medical-dark'}`}
                >
                   <i className="fas fa-calendar-check mr-1"></i> Appointments ({appointmentsForDate.length})
                </button>
                <button
                    onClick={() => setActiveTab('slots')}
                    className={`flex-1 py-2 px-4 rounded-lg font-medium transition-all text-sm ${activeTab === 'slots' ? 'bg-white text-medical-accent shadow-sm' : 'text-medical-gray hover:text-medical-dark'}`}
                >
                    <i className="fas fa-clock mr-1"></i> All Slots
                </button>
            </div>

            {}
            <div className="mt-4">
                {activeTab === 'appointments' && (
                    <DateAppointments date={date} appointments={appointmentsForDate} />
                )}
                {activeTab === 'slots' && (
                    <DaySlotsViewer date={date} />
                )}
            </div>
        </div>
    );
};

        const AppointmentDetails = ({ appointment }) => (
            <div className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 className="font-semibold text-medical-dark mb-3">Appointment Information</h4>
                        <div className="space-y-2 text-sm">
                            <div><span className="font-medium">Date:</span> {new Date(appointment.start_time).toLocaleDateString()}</div>
                            <div><span className="font-medium">Time:</span> {new Date(appointment.start_time).toLocaleTimeString()}</div>
                            <div><span className="font-medium">Status:</span>
                                <span className="ml-2 px-2 py-1 bg-medical-accent/10 text-medical-accent rounded-full text-xs">
                                    {appointment.status}
                                </span>
                            </div>
                            <div><span className="font-medium">Type:</span> {appointment.appointment_type}</div>
                        </div>
                    </div>
                    <div>
                        <h4 className="font-semibold text-medical-dark mb-3">Patient Information</h4>
                        <div className="space-y-2 text-sm">
                            <div><span className="font-medium">Name:</span> {`${appointment.patient?.first_name || ''} ${appointment.patient?.last_name || ''}`.trim() || 'N/A'}</div>
                            <div><span className="font-medium">Phone:</span> {appointment.patient?.phone_number || 'N/A'}</div>
                            <div><span className="font-medium">Email:</span> {appointment.patient?.email || 'N/A'}</div>
                        </div>
                    </div>
                </div>

                <div>
                    <h4 className="font-semibold text-medical-dark mb-3">Notes</h4>
                    <div className="bg-gray-50 p-3 rounded-lg text-sm">
                        {appointment.notes || appointment.reason || 'No notes available'}
                    </div>
                </div>

                <div className="flex space-x-3">
                    <button className="medical-button px-4 py-2 text-white rounded-lg text-sm relative z-10">
                        <i className="fas fa-edit mr-2"></i>Edit
                    </button>
                    <button className="px-4 py-2 bg-medical-error text-white rounded-lg text-sm hover:bg-medical-error/90">
                        <i className="fas fa-times mr-2"></i>Cancel
                    </button>
                    <button className="px-4 py-2 bg-medical-success text-white rounded-lg text-sm hover:bg-medical-success/90">
                        <i className="fas fa-check mr-2"></i>Complete
                    </button>
                </div>
            </div>
        );

        const DateAppointments = ({ date, appointments }) => (
            <div className="space-y-4">
                <h4 className="font-semibold text-medical-dark">
                    Appointments for {date.toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    })}
                </h4>
                {appointments.length === 0 ? (
                    <div className="text-center py-8 text-medical-gray">
                        <i className="fas fa-calendar-times text-4xl mb-4"></i>
                        <p>No appointments scheduled for this date</p>
                    </div>
                ) : (
                    <div className="space-y-3">
                        {appointments.map(apt => (
                            <div key={apt.id} className="table-row p-4 border border-gray-200 rounded-lg">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <div className="font-semibold">{`${apt.patient?.first_name || ''} ${apt.patient?.last_name || ''}`.trim() || 'Unknown Patient'}</div>
                                        <div className="text-sm text-medical-gray">
                                            {new Date(apt.start_time).toLocaleTimeString()} - {apt.appointment_type}
                                        </div>
                                    </div>
                                    <div className="flex flex-wrap items-center gap-2">
                                        <span className="px-2 py-1 bg-medical-accent/10 text-medical-accent rounded-full text-xs">
                                            {apt.status}
                                        </span>
                                        <button className="text-medical-accent hover:text-medical-dark">
                                            <i className="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );

        const ScheduleCalendar = ({ homeClinicSchedule, hospitalSchedule, onDateClick, currentDate, setCurrentDate, unavailablePeriods }) => {

            const getDaysInMonth = (date) => new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            const getFirstDayOfMonth = (date) => new Date(date.getFullYear(), date.getMonth(), 1).getDay();

            const isDateBlocked = (date, locationId) => {
                if (!unavailablePeriods || !unavailablePeriods[locationId]) {
                    return null; 
                }

                const checkDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

                for (const period of unavailablePeriods[locationId]) {

                    const periodStartDate = new Date(period.start_datetime);
                    const periodEndDate = new Date(period.end_datetime);

                    const startDateOnly = new Date(periodStartDate.getFullYear(), periodStartDate.getMonth(), periodStartDate.getDate());
                    const endDateOnly = new Date(periodEndDate.getFullYear(), periodEndDate.getMonth(), periodEndDate.getDate());

                    if (checkDate >= startDateOnly && checkDate <= endDateOnly) {
                        return period; 
                    }
                }
                return null; 
            };

            const getScheduleForDate = (date, schedule) => {
                if (!schedule) return null;
                const dayOfWeek = (date.getDay() + 6) % 7; 
                return schedule[dayOfWeek];
            };

            const renderCalendarDays = () => {
                const daysInMonth = getDaysInMonth(currentDate);
                const firstDayOfMonth = getFirstDayOfMonth(currentDate);
                const days = [];

                for (let i = 0; i < firstDayOfMonth; i++) {
                    days.push(<div key={`empty-${i}`} className="p-2"></div>);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                    const clinicSchedule = getScheduleForDate(date, homeClinicSchedule);
                    const hospitalScheduleData = getScheduleForDate(date, hospitalSchedule);
                    const isToday = date.toDateString() === new Date().toDateString();

                    const clinicBlock = isDateBlocked(date, 1);
                    const hospitalBlock = isDateBlocked(date, 2);

                    days.push(
                        <div
                            key={day}
                            className={`calendar-cell p-2 border border-gray-200 rounded-lg min-h-[90px] ${isToday ? 'bg-medical-accent/10 border-medical-accent' : ''}`}
                            onClick={() => onDateClick(date, { clinicSchedule, hospitalSchedule: hospitalScheduleData })}
                        >
                            <div className={`font-semibold mb-1 ${isToday ? 'text-medical-accent' : 'text-medical-dark'}`}>{day}</div>
                            <div className="text-xs space-y-1">
                                {clinicBlock ? (
                                    <div className="text-red-600 font-bold p-1 bg-red-100 rounded">
                                        <strong>C:</strong> BLOCKED
                                    </div>
                                ) : clinicSchedule && clinicSchedule.is_available ? (
                                    <div className="text-blue-600"><strong>C:</strong> {clinicSchedule.start_time.substring(0, 5)} - {clinicSchedule.end_time.substring(0, 5)}</div>
                                ) : (
                                    <div className="text-gray-400"><strong>C:</strong> Off</div>
                                )}

                                {hospitalBlock ? (
                                    <div className="text-red-600 font-bold p-1 bg-red-100 rounded mt-1">
                                        <strong>H:</strong> BLOCKED
                                    </div>
                                ) : hospitalScheduleData && hospitalScheduleData.is_available ? (
                                    <div className="text-green-700"><strong>H:</strong> {hospitalScheduleData.start_time.substring(0, 5)} - {hospitalScheduleData.end_time.substring(0, 5)}</div>
                                ) : (
                                    <div className="text-gray-400"><strong>H:</strong> Off</div>
                                )}
                            </div>
                        </div>
                    );
                }
                return days;
            };

            const navigateMonth = (direction) => {
                const newDate = new Date(currentDate);
                newDate.setMonth(currentDate.getMonth() + direction);
                setCurrentDate(newDate);
            };

            return (
                <div className="medical-card p-6 rounded-2xl">
                    <div className="flex items-center justify-between mb-6">
                        <h3 className="text-xl font-bold text-medical-dark font-primary">
                            {currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                        </h3>
                        <div className="flex space-x-2">
                            <button onClick={() => navigateMonth(-1)} className="p-2 text-medical-accent hover:bg-medical-accent/10 rounded-lg">
                                <i className="fas fa-chevron-left"></i>
                            </button>
                            <button onClick={() => navigateMonth(1)} className="p-2 text-medical-accent hover:bg-medical-accent/10 rounded-lg">
                                <i className="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div className="grid grid-cols-7 gap-1 sm:gap-2">
                        {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                            <div key={day} className="p-2 text-center font-semibold text-medical-gray">{day}</div>
                        ))}
                        {renderCalendarDays()}
                    </div>
                </div>
            );
        };

        const DoctorSchedule = ({ openModal, closeModal, user }) => { 
            const [schedules, setSchedules] = React.useState({ 1: {}, 2: {} });
            const [locations, setLocations] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [showModal, setShowModal] = React.useState(false);
            const [modalContent, setModalContent] = React.useState(null);
            const [isMobileMenuOpen, setIsMobileMenuOpen] = React.useState(false);
            const [currentDate, setCurrentDate] = React.useState(new Date()); 
            const [unavailablePeriods, setUnavailablePeriods] = React.useState({ 1: [], 2: [] }); 

            React.useEffect(() => {
                const initPickers = () => {
                    if (window.flatpickr) {

                        window.flatpickr("input[type='datetime-local'].form-input-themed", { enableTime: true, dateFormat: "Y-m-d H:i", allowInput: true });
                    }
                };

                initPickers();

                const observer = new MutationObserver(() => initPickers());
                observer.observe(document.body, { childList: true, subtree: true });

                return () => observer.disconnect();
            }, []);
            const [modalTitle, setModalTitle] = React.useState('');

            const fetchSchedulesAndLocations = async () => {
                setLoading(true);
                try {
                    const fetchedLocations = [
                        { id: 1, name: "Home Clinic" },
                        { id: 2, name: "Hospital" }
                    ];
                    setLocations(fetchedLocations);

                    const newSchedules = { 1: {}, 2: {} };
                    for (const loc of fetchedLocations) {
                        const data = await api(`/api/v1/schedules/by-location/${loc.id}`);
                        const scheduleMap = (data || []).reduce((acc, item) => {
                            acc[item.day_of_week] = item;
                            return acc;
                        }, {});
                        newSchedules[loc.id] = scheduleMap;
                    }
                    setSchedules(newSchedules);

                } catch (error) {
                    console.error("Error fetching schedules:", error);
                } finally {
                    setLoading(false);
                }
            };

            React.useEffect(() => {
                fetchSchedulesAndLocations();
            }, []);

            React.useEffect(() => {
                const fetchUnavailablePeriods = async () => {
                    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                    const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);

                    const toISODate = (d) => d.toISOString().split('T')[0];
                    const startDate = toISODate(firstDay);
                    const endDate = toISODate(lastDay);

                    try {
                        const [clinicPeriods, hospitalPeriods] = await Promise.all([
                            api(`/api/v1/unavailable-periods/1?start_date=${startDate}&end_date=${endDate}`),
                            api(`/api/v1/unavailable-periods/2?start_date=${startDate}&end_date=${endDate}`)
                        ]);

                        setUnavailablePeriods({
                            1: Array.isArray(clinicPeriods) ? clinicPeriods : [],
                            2: Array.isArray(hospitalPeriods) ? hospitalPeriods : []
                        });
                    } catch (error) {
                        console.error("Error fetching unavailable periods:", error);
                        setUnavailablePeriods({ 1: [], 2: [] }); 
                    }
                };

                fetchUnavailablePeriods();
            }, [currentDate]); 

            const handleSave = async (updatedSchedules) => {
                try {
                    for (const locationId in updatedSchedules) {
                        const schedulePayload = Object.values(updatedSchedules[locationId]).map(daySchedule => ({
                            ...daySchedule,
                            location_id: parseInt(locationId),

                            start_time: typeof daySchedule.start_time === 'string' && daySchedule.start_time.length === 5 ? `${daySchedule.start_time}:00` : daySchedule.start_time,
                            end_time: typeof daySchedule.end_time === 'string' && daySchedule.end_time.length === 5 ? `${daySchedule.end_time}:00` : daySchedule.end_time
                        }));

                        console.log(`Payload for Location ID ${locationId}:`, JSON.stringify(schedulePayload, null, 2));
                        await api(`/api/v1/schedules/by-location/${locationId}`, {
                            method: 'POST',
                            body: JSON.stringify(schedulePayload)
                        });
                    }
                    setShowModal(false);
                    fetchSchedulesAndLocations(); 
                } catch (error) {
                    console.error("Error saving schedules:", error);

                }
            };

            const handleModalCloseAndRefresh = () => {
                setShowModal(false);

                setCurrentDate(new Date(currentDate.getTime()));

                fetchSchedulesAndLocations();
            };

            const handleDateClick = (date, scheduleForDay) => {
                setModalTitle(`Edit Day: ${date.toLocaleDateString()}`);

                const findBlockForDate = (periods, clickedDate) => {
                    if (!periods) return null;
                    const checkDate = new Date(clickedDate.getFullYear(), clickedDate.getMonth(), clickedDate.getDate());

                    for (const period of periods) {
                        const periodStartDate = new Date(period.start_datetime);
                        const periodEndDate = new Date(period.end_datetime);
                        const startDateOnly = new Date(periodStartDate.getFullYear(), periodStartDate.getMonth(), periodStartDate.getDate());
                        const endDateOnly = new Date(periodEndDate.getFullYear(), periodEndDate.getMonth(), periodEndDate.getDate());

                        if (checkDate >= startDateOnly && checkDate <= endDateOnly) {
                            return period; 
                        }
                    }
                    return null;
                };

                const existingClinicBlock = findBlockForDate(unavailablePeriods[1], date);
                const existingHospitalBlock = findBlockForDate(unavailablePeriods[2], date);

                setModalContent(
                    <DayEditorModal
                        date={date}
                        scheduleForDay={scheduleForDay}
                        onClose={handleModalCloseAndRefresh}
                        refreshSchedules={fetchSchedulesAndLocations}
                        existingClinicBlock={existingClinicBlock}
                        existingHospitalBlock={existingHospitalBlock}
                    />
                );
                setShowModal(true);
            };

            if (loading) return <LoadingSpinner />;

            return (
                <div className="space-y-8">
                    <div className="flex items-center justify-between">
                        <h2 className="text-lg sm:text-xl lg:text-2xl font-bold text-medical-dark font-primary">Doctor Schedule</h2>
                        <div className="flex space-x-2 sm:space-x-4">
                            <button
                                onClick={() => {
                                    setModalTitle('Emergency Day Block');
                                    setModalContent(<EmergencyBlockModal onClose={handleModalCloseAndRefresh} />);
                                    setShowModal(true);
                                }}
                                className="bg-red-600 hover:bg-red-700 px-6 py-3 text-white rounded-xl font-secondary flex flex-wrap items-center gap-2 relative z-10 transition-all duration-300 transform hover:scale-105"
                            >
                                <i className="fas fa-exclamation-triangle"></i>
                                <span>Emergency Block</span>
                            </button>
                            <button
                                onClick={() => {
                                    setModalTitle('Edit Weekly Schedule');
                                    setModalContent(<ScheduleEditor schedules={schedules} locations={locations} onSaveSuccess={fetchSchedulesAndLocations} onClose={handleModalCloseAndRefresh} />); 
                                    setShowModal(true);
                                }}
                                className="medical-button px-6 py-3 text-white rounded-xl font-secondary flex flex-wrap items-center gap-2 relative z-10"
                            >
                                <i className="fas fa-edit"></i>
                                <span>Edit Weekly Schedule</span>
                            </button>
                        </div>
                    </div>

                    <ScheduleCalendar
                        homeClinicSchedule={schedules[1]}
                        hospitalSchedule={schedules[2]}
                        onDateClick={handleDateClick}
                        currentDate={currentDate}
                        setCurrentDate={setCurrentDate}
                        unavailablePeriods={unavailablePeriods}
                    />

                    <Modal
                        isOpen={showModal}
                        onClose={handleModalCloseAndRefresh}
                        title={modalTitle}
                        width="max-w-4xl"
                    >
                        {modalContent}
                    </Modal>
                </div>
            );
        };

        const ScheduleEditor = ({ schedules, locations, onSaveSuccess, onClose }) => { 
            const [localSchedules, setLocalSchedules] = React.useState({}); 
            const scheduleContainerRef = React.useRef(null); 
            const [saveError, setSaveError] = React.useState(''); 
            const [isSaving, setIsSaving] = React.useState(false); 

            React.useEffect(() => {

                if (schedules && Object.keys(schedules).length > 0) {
                    console.log("useEffect: Setting localSchedules from prop:", JSON.stringify(schedules, null, 2));

                    const newLocalSchedules = JSON.parse(JSON.stringify(schedules));
                    if (!newLocalSchedules[1]) newLocalSchedules[1] = {};
                    if (!newLocalSchedules[2]) newLocalSchedules[2] = {};
                    setLocalSchedules(newLocalSchedules);
                } else {
                    console.log("useEffect: Schedules prop is empty, setting empty local state.");
                    setLocalSchedules({ 1: {}, 2: {} });
                }
            }, [schedules]); 

            const [activeLocationId, setActiveLocationId] = React.useState(locations[0]?.id || 1);

            const handleTimeChange = (locationId, dayIndex, field, value) => {
                console.log(`handleTimeChange: locId=${locationId}, day=${dayIndex}, field=${field}, value=${value}`); 
                setSaveError(''); 
                setLocalSchedules(prev => {
                    const newState = JSON.parse(JSON.stringify(prev));
                    if (!newState[locationId]) {
                        newState[locationId] = {};
                    }
                    const currentDayData = newState[locationId][dayIndex] || {
                        day_of_week: dayIndex,
                        start_time: '09:00:00',
                        end_time: '17:00:00',
                        is_available: false,
                        appointment_duration: 30,
                        max_appointments: null
                    };
                    currentDayData[field] = value;
                    newState[locationId][dayIndex] = currentDayData;
                    return newState;
                });
            };

            const handleNumericChange = (locationId, dayIndex, field, value) => {
                setSaveError(''); 
                const numValue = value === '' ? null : parseInt(value, 10); 

                const finalValue = (numValue !== null && !isNaN(numValue) && numValue >= 0) ? numValue : null;

                console.log(`handleNumericChange: locId=${locationId}, day=${dayIndex}, field=${field}, value=${finalValue}`);
                setLocalSchedules(prev => {
                    const newState = JSON.parse(JSON.stringify(prev));
                    if (!newState[locationId]) newState[locationId] = {};
                    const currentDayData = newState[locationId][dayIndex] || {
                        day_of_week: dayIndex,
                        start_time: '09:00:00',
                        end_time: '17:00:00',
                        is_available: false,
                        appointment_duration: 30, 
                        max_appointments: null 
                    };
                    currentDayData[field] = finalValue;
                    newState[locationId][dayIndex] = currentDayData;
                    return newState;
                });
            };

            const handleAvailabilityChange = (locationId, dayIndex, isAvailable) => {
                setSaveError(''); 
                setLocalSchedules(prev => {

                    let defaults = {
                        start_time: '09:00:00',
                        end_time: '17:00:00',
                        appointment_duration: 30,
                        max_appointments: null
                    };

                    if (prev[locationId]) {

                        const otherAvailableDays = Object.values(prev[locationId]).filter(day => day.is_available && day.day_of_week !== dayIndex);
                        if (otherAvailableDays.length > 0) {
                            defaults.start_time = otherAvailableDays[0].start_time;
                            defaults.end_time = otherAvailableDays[0].end_time;
                            defaults.appointment_duration = otherAvailableDays[0].appointment_duration;
                            defaults.max_appointments = otherAvailableDays[0].max_appointments;
                        }
                    }

                    const newSchedules = JSON.parse(JSON.stringify(prev));
                    const currentLocationSchedule = newSchedules[locationId];

                    if (!currentLocationSchedule[dayIndex]) {
                        currentLocationSchedule[dayIndex] = {
                            day_of_week: dayIndex,
                            ...defaults, 
                            is_available: isAvailable 
                        };
                    } else {

                        currentLocationSchedule[dayIndex].is_available = isAvailable;
                    }

                    if (isAvailable) {
                        currentLocationSchedule[dayIndex].start_time = defaults.start_time;
                        currentLocationSchedule[dayIndex].end_time = defaults.end_time;
                        currentLocationSchedule[dayIndex].appointment_duration = defaults.appointment_duration;
                        currentLocationSchedule[dayIndex].max_appointments = defaults.max_appointments;
                    }

                    return newSchedules; 
                });
            };

            const activeSchedule = localSchedules[activeLocationId] || {};

            console.log("[ScheduleEditor Render] localSchedules:", JSON.stringify(localSchedules, null, 2));

            const handleSaveClick = async () => {
                setIsSaving(true);
                setSaveError('');
                try {

                    const locationIdToSave = activeLocationId; 
                    const schedulePayload = Object.values(localSchedules[locationIdToSave] || {}).map(daySchedule => ({
                        ...daySchedule,
                        location_id: parseInt(locationIdToSave),

                        start_time: typeof daySchedule.start_time === 'string' && daySchedule.start_time.length === 5 ? `${daySchedule.start_time}:00` : daySchedule.start_time,
                        end_time: typeof daySchedule.end_time === 'string' && daySchedule.end_time.length === 5 ? `${daySchedule.end_time}:00` : daySchedule.end_time
                    }));
                    console.log(`Payload for Location ID ${locationIdToSave}:`, JSON.stringify(schedulePayload, null, 2));
                    await api(`/api/v1/schedules/by-location/${locationIdToSave}`, {
                        method: 'POST',
                        body: JSON.stringify(schedulePayload)
                    });

                    setIsSaving(false);
                    if (onSaveSuccess) onSaveSuccess(); 
                    onClose(); 
                } catch (error) {
                    console.error("Error saving schedules:", error);

                    let errorMessage = 'An unexpected error occurred while saving.';
                    try {

                        if (error instanceof Error && error.message.includes('HTTP status code')) {
                            errorMessage = error.message; 
                        } else if (typeof error.json === 'function') { 
                            const errorData = await error.json();
                            if (errorData && errorData.detail) {
                                errorMessage = errorData.detail;
                            }
                        } else if (error.message) { 
                            errorMessage = error.message;
                        }
                    } catch (parseError) {

                        console.error("Could not parse error details:", parseError);
                    }
                    setSaveError(errorMessage); 
                    setIsSaving(false);
                }
            };

            return (
                <div className="space-y-6">
                    {}
                    {saveError && (
                        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4">
                            <p className="font-bold">Save Failed:</p>
                            <p className="text-sm">{saveError}</p>
                        </div>
                    )}
                    <div className="flex space-x-1 bg-gray-100 p-1 rounded-xl">
                        {locations.map(loc => (
                            <button
                                key={loc.id}
                                onClick={() => setActiveLocationId(loc.id)}
                                className={`flex-1 py-2 px-4 rounded-lg font-medium transition-all ${activeLocationId === loc.id ? 'bg-white text-medical-accent shadow-sm' : 'text-medical-gray hover:text-medical-dark'}`}
                            >
                                {loc.name}
                            </button>
                        ))}
                    </div>

                    {[...Array(7).keys()].map(dayIndex => {
                        const dayName = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'][dayIndex];

                        const dayData = activeSchedule[dayIndex] || {};

                        return (
                            <div key={dayIndex} className="grid grid-cols-6 gap-4 items-center p-3 border-b">
                                <h4 className="font-semibold text-medical-dark">{dayName}</h4>
                                <div>
                                    <label className="block text-xs font-medium text-medical-gray mb-1">Start Time</label>
                                    <input
                                        type="time"
                                        value={dayData?.start_time?.substring(0, 5) || ''}
                                        onChange={(e) => handleTimeChange(activeLocationId, dayIndex, 'start_time', e.target.value)}
                                        className="form-input-themed"
                                        disabled={!dayData?.is_available}
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-medium text-medical-gray mb-1">End Time</label>
                                    <input
                                        type="time"
                                        value={dayData?.end_time?.substring(0, 5) || ''}
                                        onChange={(e) => handleTimeChange(activeLocationId, dayIndex, 'end_time', e.target.value)}
                                        className="form-input-themed"
                                        disabled={!dayData?.is_available}
                                    />
                                </div>
                                <div className="flex items-center justify-center">
                                    <label className="flex flex-wrap items-center gap-2 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={!!dayData?.is_available} 
                                            onChange={(e) => handleAvailabilityChange(activeLocationId, dayIndex, e.target.checked)}
                                            className="w-4 h-4 text-medical-accent rounded"
                                        />
                                        <span>Available</span>
                                    </label>
                                </div>
                                {}
                                <div>
                                    <label className="block text-xs font-medium text-medical-gray mb-1">Duration (min)</label>
                                    <input
                                        type="number"
                                        value={dayData?.appointment_duration ?? ''} 
                                        onChange={(e) => handleNumericChange(activeLocationId, dayIndex, 'appointment_duration', e.target.value)}
                                        className="form-input-themed w-20" 
                                        min="5"
                                        max="60"
                                        step="5"
                                        placeholder="e.g., 30"
                                        disabled={!dayData?.is_available}
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-medium text-medical-gray mb-1">Max Appts</label>
                                    <input
                                        type="number"
                                        value={dayData?.max_appointments ?? ''} 
                                        onChange={(e) => handleNumericChange(activeLocationId, dayIndex, 'max_appointments', e.target.value)}
                                        className="form-input-themed w-20" 
                                        min="0"
                                        placeholder="None" 
                                        disabled={!dayData?.is_available}
                                    />
                                </div>
                                {}
                            </div>
                        )
                    })}

                    <div className="flex justify-end space-x-3">
                        <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300" disabled={isSaving}>
                            Cancel
                        </button>
                        <button onClick={handleSaveClick} className="medical-button px-4 py-2 text-white rounded-lg relative z-10" disabled={isSaving}>
                            {isSaving ? 'Saving...' : 'Save Schedule'}
                        </button>
                    </div>
                </div>
            )
        };

        const Patients = () => {
            const [patients, setPatients] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [searchTerm, setSearchTerm] = React.useState('');
            const [selectedPatient, setSelectedPatient] = React.useState(null);
            const [showModal, setShowModal] = React.useState(false);

            React.useEffect(() => {
                const fetchPatients = async () => {
                    try {
                        const data = await api(`/api/v1/patients?search=${searchTerm}`);
                        setPatients(Array.isArray(data) ? data : data.patients || []);
                    } catch (error) {
                        console.error('Error fetching patients:', error);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchPatients();
            }, [searchTerm]);

            const handlePatientClick = (patient) => {
                setSelectedPatient(patient);
                setShowModal(true);
            };

            if (loading) return <LoadingSpinner />;

            return (
                <div className="space-y-6">
                    <div className="flex items-center justify-between">
                        <h2 className="text-lg sm:text-xl lg:text-2xl font-bold text-medical-dark font-primary">Patients</h2>
                        <div className="flex space-x-2 sm:space-x-4">
                            <div className="relative">
                                <input
                                    type="text"
                                    placeholder="Search patients..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="form-input-themed pl-10"
                                />
                                <i className="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-medical-gray"></i>
                            </div>
                            <button className="medical-button px-6 py-3 text-white rounded-xl font-secondary flex flex-wrap items-center gap-2 relative z-10">
                                <i className="fas fa-user-plus"></i>
                                <span>Add Patient</span>
                            </button>
                        </div>
                    </div>

                    <div className="medical-card rounded-2xl overflow-hidden">
                        <div className="overflow-x-auto">
                            <div className="overflow-x-auto -mx-4 sm:mx-0"><table className="w-full">
                                <thead className="bg-medical-light">
                                    <tr>
                                        <th className="text-left p-4 font-semibold text-medical-dark">Name</th>
                                        <th className="text-left p-4 font-semibold text-medical-dark">Phone</th>
                                        <th className="text-left p-4 font-semibold text-medical-dark">Email</th>
                                        <th className="text-left p-4 font-semibold text-medical-dark">Last Visit</th>
                                        <th className="text-left p-4 font-semibold text-medical-dark">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {patients.map(patient => (
                                        <tr key={patient.id} className="table-row border-b border-gray-100">
                                            <td className="p-4">
                                                <div className="flex items-center space-x-3">
                                                    <div className="w-10 h-10 bg-medical-accent/10 rounded-full flex items-center justify-center">
                                                        <span className="text-medical-accent font-semibold">
                                                            {patient.first_name?.charAt(0) || 'P'}
                                                        </span>
                                                    </div>
                                                    <div>
                                                        <div className="font-semibold text-medical-dark">{`${patient.first_name} ${patient.last_name || ''}`}</div>
                                                        <div className="text-sm text-medical-gray">ID: {patient.id}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td className="p-4 text-medical-gray">{patient.phone_number || 'N/A'}</td>
                                            <td className="p-4 text-medical-gray">{patient.email || 'N/A'}</td>
                                            <td className="p-4 text-medical-gray">
                                                {patient.last_visit_date ?
                                                    new Date(patient.last_visit_date).toLocaleDateString() :
                                                    'Never'
                                                }
                                            </td>
                                            <td className="p-4">
                                                <div className="flex space-x-2">
                                                    <button
                                                        onClick={() => handlePatientClick(patient)}
                                                        className="text-medical-accent hover:text-medical-dark"
                                                    >
                                                        <i className="fas fa-eye"></i>
                                                    </button>
                                                    <button className="text-medical-success hover:text-green-700">
                                                        <i className="fas fa-edit"></i>
                                                    </button>
                                                    <button className="text-medical-error hover:text-red-700">
                                                        <i className="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table></div>
                        </div>

                        {patients.length === 0 && (
                            <div className="text-center py-12">
                                <i className="fas fa-users text-4xl text-medical-gray mb-4"></i>
                                <p className="text-medical-gray">No patients found</p>
                            </div>
                        )}
                    </div>

                    <Modal
                        isOpen={showModal}
                        onClose={() => setShowModal(false)}
                        title="Patient Details"
                        width="max-w-6xl"
                    >
                        {selectedPatient && <PatientDetails patient={selectedPatient} />}
                    </Modal>
                </div >
            );
        };

        const PatientDetails = ({ patient }) => {
            const [activeTab, setActiveTab] = React.useState('overview');
            const [patientAppointments, setPatientAppointments] = React.useState([]);
            const [patientPrescriptions, setPatientPrescriptions] = React.useState([]);
            const [patientRemarks, setPatientRemarks] = React.useState([]);
            const [newRemark, setNewRemark] = React.useState('');

            React.useEffect(() => {
                const fetchPatientData = async () => {
                    if (!patient) return;

                    try {
                        const prescriptionData = await api(`/api/v1/patients/${patient.id}/prescriptions`);
                        setPatientPrescriptions(prescriptionData || []);
                    } catch (error) {
                        console.error('Error fetching patient prescriptions:', error);
                    }

                    try {
                        const remarksData = await api(`/api/v1/patients/${patient.id}/remarks/`);
                        setPatientRemarks(remarksData || []);
                    } catch (error) {
                        console.error('Error fetching patient remarks:', error);
                    }

                    setPatientAppointments([
                        {
                            id: 1,
                            start_time: '2024-01-15T10:00:00',
                            appointment_type: 'Consultation',
                            status: 'completed',
                            notes: 'Regular checkup, patient doing well'
                        },
                        {
                            id: 2,
                            start_time: '2024-01-20T14:30:00',
                            appointment_type: 'Follow-up',
                            status: 'scheduled',
                            notes: 'Follow-up for blood pressure monitoring'
                        }
                    ]);
                };

                fetchPatientData();
            }, [patient]);

            const handleAddRemark = async () => {
                if (!newRemark.trim()) return;
                try {
                    const addedRemark = await api(`/api/v1/patients/${patient.id}/remarks/`, {
                        method: 'POST',
                        body: JSON.stringify({ text: newRemark }),
                    });
                    setPatientRemarks([addedRemark, ...patientRemarks]);
                    setNewRemark('');
                } catch (error) {
                    console.error('Error adding remark:', error);
                }
            };

            const tabs = [
                { id: 'overview', label: 'Overview', icon: 'fas fa-user' },
                { id: 'appointments', label: 'Appointments', icon: 'fas fa-calendar' },
                { id: 'prescriptions', label: 'Prescriptions', icon: 'fas fa-prescription' },
                { id: 'remarks', label: 'Remarks', icon: 'fas fa-comment-medical' }
            ];

            return (
                <div className="space-y-6">
                    <div className="flex flex-wrap items-center gap-2 sm:space-x-4 pb-4 border-b border-gray-200">
                        <div className="w-16 h-16 bg-medical-accent/10 rounded-full flex items-center justify-center">
                            <span className="text-medical-accent text-xl font-bold">
                                {patient.name?.charAt(0) || 'P'}
                            </span>
                        </div>
                        <div>
                            <h3 className="text-lg sm:text-xl lg:text-2xl font-bold text-medical-dark">{`${patient.first_name || ''} ${patient.last_name || ''}`.trim() || 'Unknown Patient'}</h3>
                            <p className="text-medical-gray">Patient ID: {patient.id}</p>
                        </div>
                    </div>

                    <div className="flex space-x-1 bg-gray-100 p-1 rounded-xl">
                        {tabs.map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => setActiveTab(tab.id)}
                                className={`flex-1 flex items-center justify-center space-x-2 py-2 px-4 rounded-lg font-medium transition-all ${activeTab === tab.id
                                    ? 'bg-white text-medical-accent shadow-sm'
                                    : 'text-medical-gray hover:text-medical-dark'
                                    }`}
                            >
                                <i className={tab.icon}></i>
                                <span>{tab.label}</span>
                            </button>
                        ))}
                    </div>

                    <div className="min-h-[400px]">
                        {activeTab === 'overview' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h4 className="font-semibold text-medical-dark mb-4">Personal Information</h4>
                                    <div className="space-y-3 text-sm">
                                        <div className="flex justify-between">
                                            <span className="text-medical-gray">Phone:</span>
                                            <span>{patient.phone_number || 'N/A'}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-medical-gray">Email:</span>
                                            <span>{patient.email || 'N/A'}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-medical-gray">Date of Birth:</span>
                                            <span>{patient.date_of_birth || 'N/A'}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-medical-gray">Gender:</span>
                                            <span>{patient.gender || 'N/A'}</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 className="font-semibold text-medical-dark mb-4">Medical Information</h4>
                                    <div className="space-y-3 text-sm">
                                        <div className="flex justify-between">
                                            <span className="text-medical-gray">Blood Type:</span>
                                            <span>{patient.blood_type || 'Unknown'}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-medical-gray">Allergies:</span>
                                            <span>{patient.allergies || 'None known'}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-medical-gray">Last Visit:</span>
                                            <span>
                                                {patient.last_visit_date ?
                                                    new Date(patient.last_visit_date).toLocaleDateString() :
                                                    'Never'
                                                }
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'appointments' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center">
                                    <h4 className="font-semibold text-medical-dark">Appointment History</h4>
                                    <button className="medical-button px-4 py-2 text-white rounded-lg text-sm relative z-10">
                                        <i className="fas fa-plus mr-2"></i>New Appointment
                                    </button>
                                </div>
                                <div className="space-y-3">
                                    {patientAppointments.map(apt => (
                                        <div key={apt.id} className="table-row p-4 border border-gray-200 rounded-lg">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <div className="font-semibold">
                                                        {new Date(apt.start_time).toLocaleDateString()} - {apt.appointment_type}
                                                    </div>
                                                    <div className="text-sm text-medical-gray mt-1">{apt.notes}</div>
                                                </div>
                                                <span className={`px-2 py-1 rounded-full text-xs ${apt.status === 'completed'
                                                    ? 'bg-medical-success/10 text-medical-success'
                                                    : 'bg-medical-accent/10 text-medical-accent'
                                                    }`}>
                                                    {apt.status}
                                                </span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'prescriptions' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center">
                                    <h4 className="font-semibold text-medical-dark">Prescription History</h4>
                                    <button className="medical-button px-4 py-2 text-white rounded-lg text-sm relative z-10">
                                        <i className="fas fa-plus mr-2"></i>New Prescription
                                    </button>
                                </div>
                                <div className="space-y-3">
                                    {patientPrescriptions.map(prescription => (
                                        <div key={prescription.id} className="table-row p-4 border border-gray-200 rounded-lg">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <div className="font-semibold">{prescription.medication_name}</div>
                                                    <div className="text-sm text-medical-gray">
                                                        {prescription.dosage} - {prescription.frequency}
                                                    </div>
                                                    <div className="text-xs text-medical-gray mt-1">
                                                        Prescribed: {new Date(prescription.prescribed_date).toLocaleDateString()}
                                                    </div>
                                                </div>
                                                <div className="flex flex-wrap items-center gap-2">
                                                    <button title="View PDF" onClick={() => window.open(`/api/v1/prescriptions/editor/pdf/${prescription.document_id || ''}`, '_blank')} className="px-2 py-1 bg-gray-100 rounded text-sm">PDF</button>
                                                    <button title="View HTML" onClick={() => window.open(`/api/v1/prescriptions/editor/html/${prescription.document_id || ''}`, '_blank')} className="px-2 py-1 bg-gray-100 rounded text-sm">HTML</button>
                                                    <button title="Send WhatsApp" onClick={async () => { try { await api('/api/v1/prescriptions/share', { method: 'POST', body: JSON.stringify({ patient_id: prescription.patient_id || patient.id, document_id: prescription.document_id, method: 'whatsapp' }) }); toast('Sent via WhatsApp'); } catch { toast('Send failed'); } }} className="px-2 py-1 bg-green-600 text-white rounded text-sm">WA</button>
                                                    <button title="Send Email" onClick={async () => { try { await api('/api/v1/prescriptions/share', { method: 'POST', body: JSON.stringify({ patient_id: prescription.patient_id || patient.id, document_id: prescription.document_id, method: 'email' }) }); toast('Sent via Email'); } catch { toast('Send failed'); } }} className="px-2 py-1 bg-blue-600 text-white rounded text-sm">Email</button>
                                                    <span className={`px-2 py-1 rounded-full text-xs ${prescription.is_active
                                                        ? 'bg-medical-success/10 text-medical-success'
                                                        : 'bg-medical-gray/10 text-medical-gray'
                                                        }`}>
                                                        {prescription.is_active ? 'Active' : 'Inactive'}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'remarks' && (
                            <div className="space-y-4 animate-fade-in">
                                <h4 className="font-semibold text-medical-dark">Patient Remarks</h4>
                                <div className="space-y-4">
                                    <div className="bg-gray-50 p-4 rounded-lg">
                                        <textarea
                                            value={newRemark}
                                            onChange={(e) => setNewRemark(e.target.value)}
                                            className="form-input-themed"
                                            rows="3"
                                            placeholder="Add a new remark..."
                                        ></textarea>
                                        <div className="flex justify-end mt-2">
                                            <button
                                                onClick={handleAddRemark}
                                                className="medical-button px-4 py-2 text-white rounded-lg text-sm relative z-10"
                                            >
                                                Add Remark
                                            </button>
                                        </div>
                                    </div>

                                    <div className="space-y-3">
                                        {patientRemarks.length > 0 ? (
                                            patientRemarks.map(remark => (
                                                <div key={remark.id} className="table-row p-4 border border-gray-200 rounded-lg">
                                                    <p className="text-sm text-medical-dark">{remark.text}</p>
                                                    <div className="text-xs text-medical-gray mt-2">
                                                        <span>By {remark.author?.username || 'Unknown'} on </span>
                                                        <span>{new Date(remark.created_at).toLocaleString()}</span>
                                                    </div>
                                                </div>
                                            ))
                                        ) : (
                                            <p className="text-sm text-medical-gray text-center py-4">No remarks for this patient yet.</p>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const VitalsForm = ({ vitalsData, setVitalsData }) => {

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                const newData = { ...vitalsData, [name]: value };

                if ((name === 'weight' || name === 'height') && newData.weight && newData.height) {
                    const weightKg = parseFloat(newData.weight);
                    const heightCm = parseFloat(newData.height);
                    if (weightKg > 0 && heightCm > 0) {
                        const heightM = heightCm / 100;
                        newData.bmi = (weightKg / (heightM * heightM)).toFixed(2);
                    } else {
                        newData.bmi = '';
                    }
                }
                setVitalsData(newData);
            };

            const handleDateChange = (name, dateStr) => {
                setVitalsData(prev => ({ ...prev, [name]: dateStr }));
            };

            React.useEffect(() => {
                if (window.flatpickr) {
                    window.flatpickr(".vitals-date-picker", {
                        dateFormat: "Y-m-d",
                        allowInput: true,
                        onChange: function (selectedDates, dateStr, instance) {

                            const inputElement = instance.element;
                            if (inputElement && inputElement.name) {
                                handleDateChange(inputElement.name, dateStr);
                            }
                        }
                    });
                }
            }, []);

            return (
                <div className="medical-card p-6 rounded-2xl">
                    <h3 className="text-lg font-semibold text-medical-dark mb-4 border-b pb-2">Vitals</h3>
                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 text-sm">
                        {}
                        <div className="col-span-2 md:col-span-1">
                            <label className="custom-label">BP (mmHg)</label>
                            <div className="flex items-center space-x-2">
                                <input type="number" name="bp_systolic" placeholder="Systolic" value={vitalsData.bp_systolic || ''} onChange={handleInputChange} className="form-input-themed w-1/2" />
                                <span>/</span>
                                <input type="number" name="bp_diastolic" placeholder="Diastolic" value={vitalsData.bp_diastolic || ''} onChange={handleInputChange} className="form-input-themed w-1/2" />
                            </div>
                        </div>
                        {}
                        <div>
                            <label className="custom-label">Pulse (bpm)</label>
                            <input type="number" name="pulse" value={vitalsData.pulse || ''} onChange={handleInputChange} className="form-input-themed" />
                        </div>
                        {}
                        <div>
                            <label className="custom-label">Height (cm)</label>
                            <input type="number" step="0.1" name="height" value={vitalsData.height || ''} onChange={handleInputChange} className="form-input-themed" />
                        </div>
                        {}
                        <div>
                            <label className="custom-label">Weight (kg)</label>
                            <input type="number" step="0.1" name="weight" value={vitalsData.weight || ''} onChange={handleInputChange} className="form-input-themed" />
                        </div>
                        {}
                        <div>
                            <label className="custom-label">BMI (kg/m²)</label>
                            <input type="number" step="0.01" name="bmi" value={vitalsData.bmi || ''} onChange={handleInputChange} className="form-input-themed bg-gray-100" readOnly />
                        </div>
                        {}
                        <div>
                            <label className="custom-label">Waist (cm)</label>
                            <input type="number" step="0.1" name="waist" value={vitalsData.waist || ''} onChange={handleInputChange} className="form-input-themed" />
                        </div>
                        {}
                        <div>
                            <label className="custom-label">Hip (cm)</label>
                            <input type="number" step="0.1" name="hip" value={vitalsData.hip || ''} onChange={handleInputChange} className="form-input-themed" />
                        </div>
                        {}
                        <div>
                            <label className="custom-label">Temp (°F)</label>
                            <input type="number" step="0.1" name="temperature" value={vitalsData.temperature || ''} onChange={handleInputChange} className="form-input-themed" />
                        </div>
                        {}
                        <div>
                            <label className="custom-label">SPO2 (%)</label>
                            <input type="number" name="spo2" value={vitalsData.spo2 || ''} onChange={handleInputChange} className="form-input-themed" />
                        </div>
                        {}
                        <div className="relative">
                            <label className="custom-label">LMP</label>
                            <input type="date" name="lmp" value={vitalsData.lmp || ''} className="form-input-themed vitals-date-picker pr-8" placeholder="Select date" />
                            <i className="fas fa-calendar-alt absolute right-3 top-[34px] text-medical-gray pointer-events-none"></i>
                        </div>
                        {}
                        <div className="relative">
                            <label className="custom-label">EDD</label>
                            <input type="date" name="edd" value={vitalsData.edd || ''} className="form-input-themed vitals-date-picker pr-8" placeholder="Select date" />
                            <i className="fas fa-calendar-alt absolute right-3 top-[34px] text-medical-gray pointer-events-none"></i>
                        </div>
                        {}
                        <div className="col-span-2 lg:col-span-1">
                            <label className="custom-label">Gestational Age</label>
                            <div className="flex items-center space-x-2">
                                <input type="number" name="gestational_age_weeks" placeholder="Weeks" value={vitalsData.gestational_age_weeks || ''} onChange={handleInputChange} className="form-input-themed w-1/2" />
                                <input type="number" name="gestational_age_days" placeholder="Days" value={vitalsData.gestational_age_days || ''} onChange={handleInputChange} className="form-input-themed w-1/2" />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ConsultationNotesForm = ({ notesData, setNotesData }) => {
            const quickNotesRef = React.useRef(null);
            const examNotesRef = React.useRef(null);
            const quillInstances = React.useRef({}); 
            const [diagnosisInput, setDiagnosisInput] = React.useState('');

            React.useEffect(() => {
                const Quill = window.Quill;
                if (!Quill) return;

                const initQuill = (ref, key) => {
                    if (ref.current && !quillInstances.current[key]) {

                        if (ref.current.querySelector('.ql-editor')) return; 

                        const quill = new Quill(ref.current, {
                            theme: 'snow',
                            modules: {
                                toolbar: [
                                    ['bold', 'italic', 'underline'],
                                    [{ 'list': 'ordered' }, { 'list': 'bullet' }]
                                ]
                            },
                            placeholder: `Enter ${key === 'quickNotes' ? 'quick notes' : 'systemic examination'}...`
                        });
                        quill.on('text-change', () => {
                            setNotesData(prev => ({ ...prev, [key]: JSON.stringify(quill.getContents().ops) }));
                        });
                        quillInstances.current[key] = quill;
                    }
                };

                initQuill(quickNotesRef, 'quick_notes');
                initQuill(examNotesRef, 'systemic_examination');

                return () => {
                    Object.values(quillInstances.current).forEach(q => q && q.off('text-change'));

                };
            }, []); 

            const handleTextAreaChange = (e) => {
                const { name, value } = e.target;
                setNotesData(prev => ({ ...prev, [name]: value }));
            };

            const handleAddDiagnosis = () => {
                const newDiagnosis = diagnosisInput.trim();
                if (newDiagnosis && !notesData.diagnoses?.some(d => d.diagnosis_name === newDiagnosis)) {
                    setNotesData(prev => ({
                        ...prev,
                        diagnoses: [...(prev.diagnoses || []), { diagnosis_name: newDiagnosis }]
                    }));
                    setDiagnosisInput('');
                }
            };

            const handleDiagnosisKeyDown = (e) => {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    handleAddDiagnosis();
                }
            };

            const handleRemoveDiagnosis = (indexToRemove) => {
                setNotesData(prev => ({
                    ...prev,
                    diagnoses: prev.diagnoses.filter((_, index) => index !== indexToRemove)
                }));
            };

            React.useEffect(() => {
                if (quillInstances.current.quick_notes && notesData.quick_notes) {
                    try {
                        quillInstances.current.quick_notes.setContents(JSON.parse(notesData.quick_notes));
                    } catch {  }
                }
                if (quillInstances.current.systemic_examination && notesData.systemic_examination) {
                    try {
                        quillInstances.current.systemic_examination.setContents(JSON.parse(notesData.systemic_examination));
                    } catch {  }
                }
            }, [notesData.quick_notes, notesData.systemic_examination]); 

            return (
                <div className="medical-card p-6 rounded-2xl space-y-4">
                    {}
                    <div>
                        <label className="custom-label">Quick Notes</label>
                        <div ref={quickNotesRef} style={{ height: '100px' }}></div>
                    </div>
                    {}
                    <div>
                        <label className="custom-label">Complaints</label>
                        <textarea
                            name="complaints"
                            value={notesData.complaints || ''}
                            onChange={handleTextAreaChange}
                            className="custom-textarea"
                            rows="3"
                            placeholder="Enter patient complaints..."
                        ></textarea>
                    </div>
                    {}
                    <div>
                        <label className="custom-label">Diagnosis</label>
                        <div className="flex flex-wrap items-center gap-2 mb-2 p-2 border border-gray-200 rounded-lg min-h-[40px]">
                            {(notesData.diagnoses || []).map((diag, index) => (
                                <span key={index} className="inline-flex items-center bg-medical-accent/10 text-medical-accent text-sm font-medium px-2.5 py-0.5 rounded-full">
                                    {diag.diagnosis_name}
                                    <button
                                        type="button"
                                        onClick={() => handleRemoveDiagnosis(index)}
                                        className="ml-1.5 text-medical-accent hover:text-red-500"
                                    >
                                        <i className="fas fa-times-circle text-xs"></i>
                                    </button>
                                </span>
                            ))}
                            <input
                                type="text"
                                value={diagnosisInput}
                                onChange={(e) => setDiagnosisInput(e.target.value)}
                                onKeyDown={handleDiagnosisKeyDown}
                                onBlur={handleAddDiagnosis} 
                                className="flex-grow p-1 border-none focus:ring-0 text-sm"
                                placeholder="Add diagnosis (press Enter)..."
                            />
                        </div>
                    </div>
                    {}
                    {/* --- REMOVED: Systemic Examination div --- */}
                    {/* This field is now handled by the PhysicalExaminationForm component */}
                </div>
            );
        };

        const MedicationForm = ({ medicationsData, setMedicationsData }) => {
            const handleAddMedication = () => {
                setMedicationsData(prev => [
                    ...prev,
                    { type: 'TAB', medicine_name: '', dosage: '', when: '', frequency: 'daily', duration: '', notes: '' }
                ]);
            };

            const handleRemoveMedication = (indexToRemove) => {
                setMedicationsData(prev => prev.filter((_, index) => index !== indexToRemove));
            };

            const handleMedicationChange = (index, field, value) => {
                setMedicationsData(prev =>
                    prev.map((med, i) =>
                        i === index ? { ...med, [field]: value } : med
                    )
                );
            };

            return (
                <div className="medical-card p-6 rounded-2xl">
                    <div className="flex items-center justify-between mb-4 border-b pb-2">
                        <h3 className="text-lg font-semibold text-medical-dark">Medications (Rx)</h3>
                        {}
                        <div>
                            <button onClick={() => setMedicationsData([])} className="text-sm text-red-600 hover:underline mr-4">Clear All</button>
                            <button onClick={handleAddMedication} className="medical-button px-3 py-1 text-white rounded-lg text-sm">
                                <i className="fas fa-plus mr-1"></i> Add Medicine
                            </button>
                        </div>
                    </div>

                    <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                            <thead>
                                <tr className="text-left text-medical-gray">
                                    <th className="p-2 w-12">#</th>
                                    <th className="p-2 w-20">Type</th>
                                    <th className="p-2 min-w-[200px]">Medicine</th>
                                    <th className="p-2 w-28">Dosage</th>
                                    <th className="p-2 w-28">When</th>
                                    <th className="p-2 w-24">Freq.</th>
                                    <th className="p-2 w-28">Duration</th>
                                    <th className="p-2 min-w-[150px]">Notes</th>
                                    <th className="p-2 w-10"></th> { }
                                </tr>
                            </thead>
                            <tbody>
                                {medicationsData.map((med, index) => (
                                    <tr key={index} className="border-b last:border-b-0">
                                        <td className="p-2 text-center text-medical-gray">{index + 1}</td>
                                        <td className="p-1">
                                            <select value={med.type} onChange={(e) => handleMedicationChange(index, 'type', e.target.value)} className="form-input-themed p-1 text-xs">
                                                <option value="TAB">TAB</option>
                                                <option value="CAP">CAP</option>
                                                <option value="SYP">SYP</option>
                                                <option value="INJ">INJ</option>
                                                <option value="CRM">CRM</option>
                                                <option value="OTH">OTH</option>
                                            </select>
                                        </td>
                                        <td className="p-1"><input type="text" placeholder="Medicine Name" value={med.medicine_name} onChange={(e) => handleMedicationChange(index, 'medicine_name', e.target.value)} className="form-input-themed p-1" /></td>
                                        <td className="p-1"><input type="text" placeholder="e.g., 1-0-1" value={med.dosage} onChange={(e) => handleMedicationChange(index, 'dosage', e.target.value)} className="form-input-themed p-1" /></td>
                                        <td className="p-1">
                                            <select value={med.when} onChange={(e) => handleMedicationChange(index, 'when', e.target.value)} className="form-input-themed p-1 text-xs">
                                                <option value="">Select</option>
                                                <option value="Before Food">Before Food</option>
                                                <option value="After Food">After Food</option>
                                                <option value="With Food">With Food</option>
                                                <option value="Bed Time">Bed Time</option>
                                            </select>
                                        </td>
                                        <td className="p-1"><input type="text" placeholder="daily" value={med.frequency} onChange={(e) => handleMedicationChange(index, 'frequency', e.target.value)} className="form-input-themed p-1" /></td>
                                        <td className="p-1"><input type="text" placeholder="e.g., 20 days" value={med.duration} onChange={(e) => handleMedicationChange(index, 'duration', e.target.value)} className="form-input-themed p-1" /></td>
                                        <td className="p-1"><input type="text" placeholder="Notes" value={med.notes} onChange={(e) => handleMedicationChange(index, 'notes', e.target.value)} className="form-input-themed p-1" /></td>
                                        <td className="p-1 text-center">
                                            <button onClick={() => handleRemoveMedication(index)} className="text-red-500 hover:text-red-700">
                                                <i className="fas fa-trash-alt"></i>
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                                {medicationsData.length === 0 && (
                                    <tr><td colSpan="9" className="text-center p-4 text-medical-gray">No medications added.</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const AdviceForm = ({ adviceData, setAdviceData }) => {
            const adviceEditorRef = React.useRef(null);
            const quillInstance = React.useRef(null);

            React.useEffect(() => {
                const Quill = window.Quill;
                if (Quill && adviceEditorRef.current && !quillInstance.current) {

                    if (adviceEditorRef.current.querySelector('.ql-editor')) return;

                    const quill = new Quill(adviceEditorRef.current, {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                ['bold', 'italic', 'underline'],
                                [{ 'list': 'ordered' }, { 'list': 'bullet' }]
                            ]
                        },
                        placeholder: 'Enter advice for the patient...'
                    });
                    quill.on('text-change', () => {
                        setAdviceData(prev => ({ ...prev, advice: JSON.stringify(quill.getContents().ops) }));
                    });
                    quillInstance.current = quill;
                }

                return () => {
                    quillInstance.current?.off('text-change');

                };
            }, []);

            React.useEffect(() => {
                if (quillInstance.current && adviceData.advice) {
                    try {

                        const currentContent = JSON.stringify(quillInstance.current.getContents().ops);
                        if (currentContent !== adviceData.advice) {
                            quillInstance.current.setContents(JSON.parse(adviceData.advice));
                        }
                    } catch {  }
                } else if (quillInstance.current && !adviceData.advice) {
                    quillInstance.current.setContents([]); 
                }
            }, [adviceData.advice]);

            return (
                <div className="medical-card p-6 rounded-2xl">
                    <h3 className="text-lg font-semibold text-medical-dark mb-4 border-b pb-2">Advice</h3>
                    <div ref={adviceEditorRef} style={{ height: '150px' }}></div>
                </div>
            );
        };

        const InvestigationFollowUpForm = ({ formData, setFormData }) => {
            const usgFindingsRef = React.useRef(null);
            const labTestsRef = React.useRef(null);
            const quillInstances = React.useRef({});
            const [nextVisitType, setNextVisitType] = React.useState('duration'); 
            const [nextVisitValue, setNextVisitValue] = React.useState('');
            const [nextVisitUnit, setNextVisitUnit] = React.useState('Days');

            React.useEffect(() => {
                const Quill = window.Quill;
                if (!Quill) return;
                const initQuill = (ref, key, placeholder) => {
                    if (ref.current && !quillInstances.current[key]) {
                        if (ref.current.querySelector('.ql-editor')) return; 
                        const quill = new Quill(ref.current, {
                            theme: 'snow',
                            modules: { toolbar: [['bold', 'italic'], [{ 'list': 'ordered' }, { 'list': 'bullet' }]] },
                            placeholder: placeholder
                        });
                        quill.on('text-change', () => {
                            setFormData(prev => ({ ...prev, [key]: JSON.stringify(quill.getContents().ops) }));
                        });
                        quillInstances.current[key] = quill;
                    }
                };
                initQuill(usgFindingsRef, 'usg_findings', 'Enter USG findings...');
                initQuill(labTestsRef, 'lab_tests_imaging', 'Enter lab tests and imaging details...');
                return () => {
                    Object.values(quillInstances.current).forEach(q => q && q.off('text-change'));
                };
            }, []);

            React.useEffect(() => {
                if (window.flatpickr) {
                    window.flatpickr("#next-visit-date-picker", {
                        dateFormat: "Y-m-d",
                        allowInput: true,
                        onChange: function (selectedDates, dateStr, instance) {
                            handleInputChange({ target: { name: 'next_visit_date', value: dateStr } });
                        }
                    });
                }
            }, []);

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));

                if (name === 'nextVisitValue' || name === 'nextVisitUnit') {
                    let instruction = '';
                    const currentVal = name === 'nextVisitValue' ? value : nextVisitValue;
                    const currentUnit = name === 'nextVisitUnit' ? value : nextVisitUnit;
                    if (currentVal && currentUnit) {
                        instruction = `${currentVal} ${currentUnit}`;
                    }
                    setFormData(prev => ({ ...prev, next_visit_instructions: instruction }));
                }
            };

            React.useEffect(() => {
                if (formData.next_visit_instructions) {
                    const parts = formData.next_visit_instructions.split(' ');
                    if (parts.length === 2 && !isNaN(parts[0])) {
                        setNextVisitValue(parts[0]);
                        setNextVisitUnit(parts[1]);
                        setNextVisitType('duration');
                    }
                } else if (formData.next_visit_date) {
                    setNextVisitType('date');
                } else {

                    setNextVisitType('duration');
                    setNextVisitValue('');
                    setNextVisitUnit('Days');
                }
            }, [formData.next_visit_instructions, formData.next_visit_date]);

            React.useEffect(() => {
                const setQuillContent = (key, content) => {
                    if (quillInstances.current[key] && content) {
                        try {
                            const currentContent = JSON.stringify(quillInstances.current[key].getContents().ops);
                            if (currentContent !== content) {
                                quillInstances.current[key].setContents(JSON.parse(content));
                            }
                        } catch {  }
                    } else if (quillInstances.current[key] && !content) {
                        quillInstances.current[key].setContents([]);
                    }
                }
                setQuillContent('usg_findings', formData.usg_findings);
                setQuillContent('lab_tests_imaging', formData.lab_tests_imaging);
            }, [formData.usg_findings, formData.lab_tests_imaging]);

            return (
                <div className="medical-card p-6 rounded-2xl space-y-4">
                    {}
                    <div>
                        <label className="custom-label">Tests Requested</label>
                        <textarea
                            name="tests_requested"
                            value={formData.tests_requested || ''}
                            onChange={handleInputChange}
                            className="custom-textarea"
                            rows="2"
                            placeholder="List any tests requested..."
                        ></textarea>
                    </div>

                    {}
                    <div>
                        <label className="custom-label">Next Visit</label>
                        <div className="flex items-center space-x-2">
                            <input
                                type="radio"
                                name="nextVisitType"
                                value="duration"
                                checked={nextVisitType === 'duration'}
                                onChange={() => { setNextVisitType('duration'); handleInputChange({ target: { name: 'next_visit_date', value: null } }); }}
                                className="mr-1"
                            />
                            <input
                                type="number"
                                name="nextVisitValue"
                                value={nextVisitValue}
                                onChange={(e) => { setNextVisitValue(e.target.value); handleInputChange(e); }}
                                className="form-input-themed w-20"
                                placeholder="No of"
                                disabled={nextVisitType !== 'duration'}
                            />
                            <select
                                name="nextVisitUnit"
                                value={nextVisitUnit}
                                onChange={(e) => { setNextVisitUnit(e.target.value); handleInputChange(e); }}
                                className="custom-select w-28"
                                disabled={nextVisitType !== 'duration'}
                            >
                                <option>Days</option>
                                <option>Weeks</option>
                                <option>Months</option>
                            </select>
                            <span className="text-medical-gray">Or</span>
                            <input
                                type="radio"
                                name="nextVisitType"
                                value="date"
                                checked={nextVisitType === 'date'}
                                onChange={() => { setNextVisitType('date'); handleInputChange({ target: { name: 'next_visit_instructions', value: null } }); setNextVisitValue(''); setNextVisitUnit('Days'); }}
                                className="ml-2 mr-1"
                            />
                            <input
                                type="date"
                                id="next-visit-date-picker"
                                name="next_visit_date"
                                value={formData.next_visit_date || ''}
                                className="form-input-themed custom-datetime flex-grow"
                                placeholder="Select date"
                                disabled={nextVisitType !== 'date'}
                            />
                        </div>
                    </div>

                    {}
                    <div>
                        <label className="custom-label">Referred To</label>
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-2 border p-3 rounded-lg bg-gray-50">
                            <input type="text" name="referral_doctor_name" value={formData.referral_doctor_name || ''} onChange={handleInputChange} className="form-input-themed" placeholder="Doctor Name" />
                            <input type="text" name="referral_speciality" value={formData.referral_speciality || ''} onChange={handleInputChange} className="form-input-themed" placeholder="Speciality" />
                            <input type="tel" name="referral_phone" value={formData.referral_phone || ''} onChange={handleInputChange} className="form-input-themed" placeholder="Phone No" />
                            <input type="email" name="referral_email" value={formData.referral_email || ''} onChange={handleInputChange} className="form-input-themed" placeholder="Email" />
                            {}
                        </div>
                    </div>

                    {}
                    <div>
                        <label className="custom-label">USG Findings</label>
                        <div ref={usgFindingsRef} style={{ height: '100px' }}></div>
                    </div>

                    {}
                    <div>
                        <label className="custom-label">Lab Tests and Imaging</label>
                        <div ref={labTestsRef} style={{ height: '100px' }}></div>
                    </div>
                </div>
            );
        };

        const PatientMenstrualHistoryForm = ({ patientId }) => {
            const [history, setHistory] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState('');

            React.useEffect(() => {
                if (!patientId) return;
                const fetchHistory = async () => {
                    setLoading(true);
                    setError('');
                    try {
                        const data = await api(`/api/v1/patients/${patientId}/menstrual-history`);
                        setHistory(data);
                    } catch (err) {
                        setError(`Failed to load history: ${err.message}`);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchHistory();
            }, [patientId]);

            const handleSave = async () => {
                setError('');
                setLoading(true);
                try {
                    const dataToSave = { ...history };
                    // Clean up fields that API might not expect in an update
                    delete dataToSave.id;
                    delete dataToSave.patient_id;
                    // Ensure empty numbers are null
                    if (dataToSave.age_at_menarche === '') dataToSave.age_at_menarche = null;

                    const savedData = await api(`/api/v1/patients/${patientId}/menstrual-history`, {
                        method: 'POST',
                        body: JSON.stringify(dataToSave),
                    });
                    setHistory(savedData); // Update state with saved data (which may include new ID)
                    toast('Menstrual history saved.');
                } catch (err) {
                    setError(`Failed to save history: ${err.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                setHistory(prev => ({ ...prev, [name]: value }));
            };
            
            const handleDateChange = (name, dateStr) => {
                setHistory(prev => ({ ...prev, [name]: dateStr }));
            };

            React.useEffect(() => {
                if (history && window.flatpickr) {
                    window.flatpickr(".menstrual-lmp-picker", {
                        dateFormat: "Y-m-d",
                        allowInput: true,
                        defaultDate: history.lmp || null,
                        onChange: (selectedDates, dateStr) => handleDateChange('lmp', dateStr)
                    });
                }
            }, [history]); // Re-run if history loads

            if (loading) return <div className="p-4"><LoadingSpinner /></div>;
            if (error) return <div className="p-4 text-red-500">{error}</div>;
            if (!history) return null; // Should be handled by loading, but as a fallback

            return (
                <div className="medical-card p-6 rounded-2xl">
                    <h3 className="text-lg font-semibold text-medical-dark mb-4 border-b pb-2">Menstrual Info</h3>
                    <div className="space-y-4 text-sm">
                        <div className="grid grid-cols-3 items-center gap-4">
                            <label className="custom-label col-span-1">Age at Menarche</label>
                            <input type="number" name="age_at_menarche" value={history.age_at_menarche || ''} onChange={handleChange} className="form-input-themed col-span-2" placeholder="Enter age" />
                        </div>
                        <div className="grid grid-cols-3 items-center gap-4">
                            <label className="custom-label col-span-1">LMP</label>
                            <input type="date" name="lmp" value={history.lmp || ''} className="form-input-themed custom-datetime menstrual-lmp-picker col-span-2" placeholder="Select date" />
                        </div>
                        <div className="grid grid-cols-3 items-center gap-4">
                            <label className="custom-label col-span-1">Regularity of Cycle</label>
                            <select name="regularity" value={history.regularity || ''} onChange={handleChange} className="custom-select col-span-2">
                                <option value="">Select...</option>
                                <option value="Regular">Regular</option>
                                <option value="Irregular">Irregular</option>
                            </select>
                        </div>
                        <div className="grid grid-cols-3 items-center gap-4">
                            <label className="custom-label col-span-1">Duration for Bleeding</label>
                            <input type="text" name="duration_of_bleeding" value={history.duration_of_bleeding || ''} onChange={handleChange} className="form-input-themed col-span-2" placeholder="e.g., 4-5 days" />
                        </div>
                        <div className="grid grid-cols-3 items-center gap-4">
                            <label className="custom-label col-span-1">Period of Menstrual Cycle</label>
                            <input type="text" name="period_of_cycle" value={history.period_of_cycle || ''} onChange={handleChange} className="form-input-themed col-span-2" placeholder="e.g., 28 days" />
                        </div>
                        <div className="grid grid-cols-3 items-start gap-4">
                            <label className="custom-label col-span-1 mt-3">Details of Issues</label>
                            <textarea name="details_of_issues" value={history.details_of_issues || ''} onChange={handleChange} className="custom-textarea col-span-2" rows="3" placeholder="Enter details..."></textarea>
                        </div>
                    </div>
                    <div className="flex justify-end mt-4">
                        <button onClick={handleSave} className="medical-button px-4 py-2 text-white rounded-lg text-sm relative z-10">
                            Save History
                        </button>
                    </div>
                </div>
            );
        };

        const PhysicalExaminationForm = ({ notesData, setNotesData }) => {
            const systemicRef = React.useRef(null);
            const breastRef = React.useRef(null);
            const speculumRef = React.useRef(null);
            const quillInstances = React.useRef({});

            const initQuill = (ref, key, placeholder) => {
                const Quill = window.Quill;
                if (!Quill || !ref.current || quillInstances.current[key]) {
                    // If Quill isn't loaded, ref not ready, or instance exists, bail.
                    if (ref.current && ref.current.querySelector('.ql-editor')) {
                         // Quill is already initialized, just ensure content is set
                         setQuillContent(key, notesData[key]);
                    }
                    return;
                }

                const quill = new Quill(ref.current, {
                    theme: 'snow',
                    modules: { toolbar: [['bold', 'italic'], [{ 'list': 'ordered' }, { 'list': 'bullet' }]] },
                    placeholder: placeholder
                });

                quill.on('text-change', () => {
                    setNotesData(prev => ({ ...prev, [key]: JSON.stringify(quill.getContents().ops) }));
                });
                quillInstances.current[key] = quill;
                setQuillContent(key, notesData[key]);
            };

            const setQuillContent = (key, content) => {
                const quill = quillInstances.current[key];
                if (quill && content) {
                    try {
                        const currentContent = JSON.stringify(quill.getContents().ops);
                        if (currentContent !== content) {
                            quill.setContents(JSON.parse(content));
                        }
                    } catch (e) { console.error('Failed to set Quill content for', key, e); }
                } else if (quill && !content) {
                    quill.setContents([]);
                }
            };

            // Initialize all editors on mount
            React.useEffect(() => {
                initQuill(systemicRef, 'systemic_examination', 'Enter systemic examination notes...');
                initQuill(breastRef, 'breast_examination_notes', 'Enter breast examination notes...');
                initQuill(speculumRef, 'per_speculum_notes', 'Enter per speculum notes...');
            }, []);

            // Sync content if notesData is reset from parent
            React.useEffect(() => {
                setQuillContent('systemic_examination', notesData.systemic_examination);
                setQuillContent('breast_examination_notes', notesData.breast_examination_notes);
                setQuillContent('per_speculum_notes', notesData.per_speculum_notes);
            }, [notesData.systemic_examination, notesData.breast_examination_notes, notesData.per_speculum_notes]);

            return (
                <div className="medical-card p-6 rounded-2xl space-y-4">
                    <h3 className="text-lg font-semibold text-medical-dark mb-4 border-b pb-2">Physical Examination</h3>
                    <div>
                        <label className="custom-label">Systemic Examination</label>
                        <div ref={systemicRef} style={{ height: '100px' }}></div>
                    </div>
                    <div>
                        <label className="custom-label">Breast Examination</label>
                        <div ref={breastRef} style={{ height: '100px' }}></div>
                    </div>
                    <div>
                        <label className="custom-label">Per Speculum</label>
                        <div ref={speculumRef} style={{ height: '100px' }}></div>
                    </div>
                </div>
            );
        };

                // ============================================================================
        // PRODUCTION-GRADE EMR CONSULTATION MODULE
        // Based on HIPAA standards, EMR best practices, and HealthPlix architecture
        // Research Sources: AHRQ, CMS, HealthPlix technical documentation
        // ============================================================================

        // ============================================================================
        // PATIENT DATA MODELS (Compliant with HIPAA PHI standards)
        // ============================================================================

        // Sample patient appointments data structure
        const samplePatientData = [
            {
                id: 17927,
                name: "Sonam Watts",
                age: 50,
                gender: "F",
                phone: "9501103553",
                email: "[email protected]",
                recentVisit: "Today",
                totalVisits: 1,
                time: "11:18 AM",
                wait: "3h 45m",
                status: "ON-GOING",
                purpose: "First Consultation",
                medicalHistory: {
                    allergies: [],
                    chronicConditions: [],
                    currentMedications: []
                }
            },
            {
                id: 17931,
                name: "Krishna",
                age: 27,
                gender: "F",
                phone: "9501103554",
                email: "[email protected]",
                recentVisit: "Today",
                totalVisits: 1,
                time: "12:05 PM",
                wait: "2h 58m",
                status: "ON-GOING",
                purpose: "First Consultation",
                medicalHistory: {
                    allergies: [],
                    chronicConditions: [],
                    currentMedications: []
                }
            },
            {
                id: 13801,
                name: "Manjeet Kaur",
                age: 35,
                gender: "F",
                phone: "9501103555",
                email: "[email protected]",
                recentVisit: "Today",
                totalVisits: 2,
                time: "1:51 PM",
                wait: "1h 12m",
                status: "ON-GOING",
                purpose: "Follow Up",
                medicalHistory: {
                    allergies: ["Penicillin"],
                    chronicConditions: ["Diabetes Type 2", "Hypothyroidism"],
                    currentMedications: ["Metformin 500mg", "Levothyroxine 75mcg"]
                },
                previousVisits: [
                    {
                        date: "2025-10-15",
                        complaints: ["Fatigue", "Weight gain"],
                        diagnosis: ["E11.9 - Type 2 diabetes mellitus"],
                        prescriptions: [
                            {
                                medicine: "Metformin",
                                dosage: "500mg",
                                frequency: "Twice Daily",
                                duration: "30 days"
                            }
                        ]
                    }
                ]
            },
            {
                id: 2233,
                name: "JASVEER KAUR",
                age: 62,
                gender: "F",
                phone: "9414298220",
                email: "[email protected]",
                recentVisit: "Today",
                totalVisits: 3,
                time: "1:58 PM",
                wait: "1h 5m",
                status: "ON-GOING",
                purpose: "Follow Up",
                medicalHistory: {
                    allergies: [],
                    chronicConditions: ["Hypertension"],
                    currentMedications: ["Amlodipine 5mg"]
                }
            },
            {
                id: 17935,
                name: "Shakuntla",
                age: 65,
                gender: "F",
                phone: "9928922365",
                email: "[email protected]",
                recentVisit: "Today",
                totalVisits: 1,
                time: "2:03 PM",
                wait: "1h",
                status: "ON-GOING",
                purpose: "Follow Up",
                medicalHistory: {
                    allergies: [],
                    chronicConditions: [],
                    currentMedications: []
                }
            },
            {
                id: 17934,
                name: "Om Prakash",
                age: 28,
                gender: "M",
                phone: "9799622217",
                email: "[email protected]",
                recentVisit: "--",
                totalVisits: 0,
                time: "1:54 PM",
                wait: "1h 9m",
                status: "BOOKED",
                purpose: "Follow Up",
                medicalHistory: {
                    allergies: [],
                    chronicConditions: [],
                    currentMedications: []
                }
            }
        ];

        // ============================================================================
        // MAIN CONSULTATION VIEW COMPONENT
        // Implements dual-view architecture: List View and Visit Pad
        // ============================================================================

        const ConsultationView = () => {
            const [view, setView] = React.useState('list');
            const [selectedPatient, setSelectedPatient] = React.useState(null);
            const [patients, setPatients] = React.useState(samplePatientData);
            const [searchQuery, setSearchQuery] = React.useState('');
            const [filterDate, setFilterDate] = React.useState(
                new Date().toISOString().split('T')[0]
            );
            const [isLoading, setIsLoading] = React.useState(false);

            // Load patients from backend (placeholder for API integration)
            React.useEffect(() => {
                // In production: fetch from API
                // fetchPatients(filterDate).then(data => setPatients(data));
            }, [filterDate]);

            const handleOpenVisitPad = (patient) => {
                setSelectedPatient(patient);
                setView('visitpad');
            };

            const handleBackToList = () => {
                setView('list');
                setSelectedPatient(null);
            };

            // Search filtering with debounce for performance
            const filteredPatients = React.useMemo(() => {
                return patients.filter(patient => 
                    patient.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    patient.id.toString().includes(searchQuery) ||
                    patient.phone.includes(searchQuery)
                );
            }, [patients, searchQuery]);

            return (
                <div className="h-full overflow-hidden">
                    {view === 'list' ? (
                        <PatientListView 
                            patients={filteredPatients}
                            allPatients={patients}
                            searchQuery={searchQuery}
                            setSearchQuery={setSearchQuery}
                            filterDate={filterDate}
                            setFilterDate={setFilterDate}
                            onOpenVisitPad={handleOpenVisitPad}
                            isLoading={isLoading}
                        />
                    ) : (
                        <VisitPadView 
                            patient={selectedPatient}
                            onBack={handleBackToList}
                        />
                    )}
                </div>
            );
        };

        // ============================================================================
        // PATIENT LIST VIEW COMPONENT
        // Displays appointment dashboard with search and filtering
        // Follows HealthPlix dashboard design patterns
        // ============================================================================

        const PatientListView = ({ 
            patients, 
            allPatients, 
            searchQuery, 
            setSearchQuery, 
            filterDate, 
            setFilterDate, 
            onOpenVisitPad,
            isLoading 
        }) => {
            // Calculate statistics
            const stats = React.useMemo(() => ({
                pending: allPatients.filter(p => p.status === 'BOOKED').length,
                ongoing: allPatients.filter(p => p.status === 'ON-GOING').length,
                completed: allPatients.filter(p => p.status === 'REVIEWED').length
            }), [allPatients]);

            return (
                <div className="h-full flex flex-col bg-white rounded-xl shadow-lg overflow-hidden animate-fade-in">
                    {/* Header Section with Gradient */}
                    <div className="bg-gradient-to-r from-medical-blue via-[#1565C0] to-medical-accent p-6 text-white">
                        <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                            <div className="flex-1">
                                <h2 className="text-2xl font-bold font-primary flex items-center gap-3">
                                    <i className="fas fa-calendar-day"></i>
                                    Today's Consultations
                                </h2>
                                <p className="text-blue-100 text-sm mt-1">
                                    {new Date(filterDate).toLocaleDateString('en-IN', { 
                                        weekday: 'long', 
                                        year: 'numeric', 
                                        month: 'long', 
                                        day: 'numeric' 
                                    })}
                                </p>
                            </div>

                            {/* Statistics Cards */}
                            <div className="flex items-center gap-3 flex-wrap">
                                <div className="bg-white/20 backdrop-blur-md px-4 py-3 rounded-xl border border-white/30 hover:bg-white/30 transition-all">
                                    <div className="text-xs text-blue-100 font-medium">Pending</div>
                                    <div className="text-2xl font-bold">{stats.pending}</div>
                                </div>
                                <div className="bg-white/20 backdrop-blur-md px-4 py-3 rounded-xl border border-white/30 hover:bg-white/30 transition-all">
                                    <div className="text-xs text-blue-100 font-medium">On-Going</div>
                                    <div className="text-2xl font-bold">{stats.ongoing}</div>
                                </div>
                                <div className="bg-white/20 backdrop-blur-md px-4 py-3 rounded-xl border border-white/30 hover:bg-white/30 transition-all">
                                    <div className="text-xs text-blue-100 font-medium">Completed</div>
                                    <div className="text-2xl font-bold">{stats.completed}</div>
                                </div>
                            </div>
                        </div>

                        {/* Search and Filter Bar */}
                        <div className="mt-4 flex flex-col md:flex-row gap-3">
                            <div className="flex-1 relative">
                                <input
                                    type="text"
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    placeholder="Search by patient name, ID, or phone number..."
                                    className="w-full px-4 py-3 pl-12 rounded-lg bg-white/20 backdrop-blur-sm text-white placeholder-blue-200 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 focus:bg-white/30 transition-all"
                                />
                                <i className="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-blue-200"></i>
                                {searchQuery && (
                                    <button
                                        onClick={() => setSearchQuery('')}
                                        className="absolute right-4 top-1/2 transform -translate-y-1/2 text-blue-200 hover:text-white"
                                    >
                                        <i className="fas fa-times"></i>
                                    </button>
                                )}
                            </div>
                            <input
                                type="date"
                                value={filterDate}
                                onChange={(e) => setFilterDate(e.target.value)}
                                className="px-4 py-3 rounded-lg bg-white/20 backdrop-blur-sm text-white border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50"
                            />
                            <button className="px-6 py-3 bg-white text-medical-blue rounded-lg font-semibold hover:bg-blue-50 hover:shadow-lg transition-all flex items-center gap-2">
                                <i className="fas fa-plus"></i>
                                New Patient
                            </button>
                        </div>
                    </div>

                    {/* Patient Table */}
                    <div className="flex-1 overflow-auto">
                        {isLoading ? (
                            <div className="flex items-center justify-center h-64">
                                <div className="text-center">
                                    <i className="fas fa-spinner fa-spin text-4xl text-medical-accent mb-4"></i>
                                    <p className="text-gray-600">Loading patients...</p>
                                </div>
                            </div>
                        ) : patients.length === 0 ? (
                            <div className="flex items-center justify-center h-64">
                                <div className="text-center">
                                    <i className="fas fa-users text-6xl text-gray-300 mb-4"></i>
                                    <h3 className="text-xl font-semibold text-gray-700 mb-2">No Patients Found</h3>
                                    <p className="text-gray-500">
                                        {searchQuery ? 'Try adjusting your search criteria' : 'No appointments for this date'}
                                    </p>
                                </div>
                            </div>
                        ) : (
                            <table className="w-full">
                                <thead className="sticky top-0 bg-gradient-to-r from-gray-50 to-blue-50 z-10 border-b-2 border-medical-accent/20">
                                    <tr className="text-left text-sm text-gray-700">
                                        <th className="px-6 py-4 font-semibold">ID</th>
                                        <th className="px-6 py-4 font-semibold">Patient Name</th>
                                        <th className="px-6 py-4 font-semibold">Phone</th>
                                        <th className="px-6 py-4 font-semibold">Recent Visit</th>
                                        <th className="px-6 py-4 font-semibold">#Visits</th>
                                        <th className="px-6 py-4 font-semibold">Time</th>
                                        <th className="px-6 py-4 font-semibold">Wait</th>
                                        <th className="px-6 py-4 font-semibold">Status</th>
                                        <th className="px-6 py-4 font-semibold">Purpose</th>
                                        <th className="px-6 py-4 font-semibold">Action</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {patients.map((patient, index) => (
                                        <tr 
                                            key={patient.id} 
                                            className="hover:bg-gradient-to-r hover:from-blue-50/50 hover:to-transparent transition-all duration-200 animate-fade-in"
                                            style={{ animationDelay: `${index * 50}ms` }}
                                        >
                                            <td className="px-6 py-4 text-sm font-medium text-gray-900">{patient.id}</td>
                                            <td className="px-6 py-4">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-10 h-10 bg-gradient-to-br from-medical-blue to-medical-accent rounded-full flex items-center justify-center text-white font-semibold text-sm shadow-md">
                                                        {patient.name.charAt(0)}
                                                    </div>
                                                    <div>
                                                        <div className="font-semibold text-gray-900">{patient.name}</div>
                                                        <div className="text-xs text-gray-500 flex items-center gap-2">
                                                            <span>{patient.age}Y, {patient.gender}</span>
                                                            {patient.medicalHistory?.allergies?.length > 0 && (
                                                                <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                                    <i className="fas fa-exclamation-triangle mr-1"></i>
                                                                    Allergies
                                                                </span>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td className="px-6 py-4 text-sm text-gray-600">
                                                <div className="flex items-center gap-2">
                                                    <i className="fas fa-phone-alt text-gray-400 text-xs"></i>
                                                    {patient.phone}
                                                </div>
                                            </td>
                                            <td className="px-6 py-4 text-sm text-gray-600">{patient.recentVisit}</td>
                                            <td className="px-6 py-4">
                                                <span className="inline-flex items-center justify-center w-8 h-8 rounded-full bg-medical-accent/10 text-medical-accent font-semibold text-sm">
                                                    {patient.totalVisits}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 text-sm text-gray-600 font-medium">{patient.time}</td>
                                            <td className="px-6 py-4">
                                                <span className="text-sm font-semibold text-orange-600 flex items-center gap-1">
                                                    <i className="far fa-clock text-xs"></i>
                                                    {patient.wait}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4">
                                                <span className={`px-3 py-1 rounded-full text-xs font-semibold inline-flex items-center gap-1 ${
                                                    patient.status === 'ON-GOING' 
                                                        ? 'bg-green-100 text-green-700 border border-green-200' :
                                                    patient.status === 'BOOKED' 
                                                        ? 'bg-blue-100 text-blue-700 border border-blue-200' :
                                                        'bg-gray-100 text-gray-700 border border-gray-200'
                                                }`}>
                                                    <span className={`w-2 h-2 rounded-full ${
                                                        patient.status === 'ON-GOING' ? 'bg-green-500 animate-pulse' :
                                                        patient.status === 'BOOKED' ? 'bg-blue-500' :
                                                        'bg-gray-500'
                                                    }`}></span>
                                                    {patient.status}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 text-sm text-gray-600">{patient.purpose}</td>
                                            <td className="px-6 py-4">
                                                <button
                                                    onClick={() => onOpenVisitPad(patient)}
                                                    className="px-4 py-2 bg-gradient-to-r from-medical-blue to-medical-accent text-white rounded-lg font-medium hover:shadow-lg hover:scale-105 transition-all duration-200 text-sm flex items-center gap-2"
                                                >
                                                    <i className="fas fa-notes-medical"></i>
                                                    Visit Pad
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        )}
                    </div>

                    {/* Footer with Total Count */}
                    <div className="px-6 py-3 bg-gray-50 border-t border-gray-200">
                        <p className="text-sm text-gray-600">
                            Showing <span className="font-semibold">{patients.length}</span> of <span className="font-semibold">{allPatients.length}</span> patients
                        </p>
                    </div>
                </div>
            );
        };

        // ============================================================================
        // VISIT PAD VIEW COMPONENT
        // Comprehensive EMR form following HealthPlix design patterns
        // Implements all required clinical documentation sections
        // ============================================================================

        const VisitPadView = ({ patient, onBack }) => {
            // ============================================================================
            // STATE MANAGEMENT
            // ============================================================================

            const [activeTab, setActiveTab] = React.useState('vitals');
            const [isSaving, setIsSaving] = React.useState(false);
            const [lastSaved, setLastSaved] = React.useState(null);

            // Form data state
            const [formData, setFormData] = React.useState({
                vitals: {
                    bp_systolic: '',
                    bp_diastolic: '',
                    pulse: '',
                    height: '',
                    weight: '',
                    temp: '',
                    spo2: '',
                    bmi: '',
                    respiratoryRate: ''
                },
                complaints: [],
                diagnosis: [],
                history: {
                    past: '',
                    family: '',
                    surgical: '',
                    allergies: patient.medicalHistory?.allergies?.join(', ') || '',
                    currentMedications: patient.medicalHistory?.currentMedications?.join(', ') || ''
                },
                examination: '',
                investigations: [],
                prescriptions: [],
                advice: '',
                followUp: '',
                nextVisitDate: ''
            });

            // Quill editor references
            const examinationEditorRef = React.useRef(null);
            const adviceEditorRef = React.useRef(null);
            const historyEditorRef = React.useRef(null);

            // ============================================================================
            // EFFECTS
            // ============================================================================

            // Initialize Quill editors
            React.useEffect(() => {
                if (typeof Quill !== 'undefined') {
                    const toolbarOptions = [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'header': [1, 2, 3, false] }],
                        ['clean']
                    ];

                    if (!examinationEditorRef.current) {
                        examinationEditorRef.current = new Quill('#examination-editor', {
                            theme: 'snow',
                            placeholder: 'Enter clinical examination findings...',
                            modules: { toolbar: toolbarOptions }
                        });
                    }

                    if (!adviceEditorRef.current) {
                        adviceEditorRef.current = new Quill('#advice-editor', {
                            theme: 'snow',
                            placeholder: 'Enter advice, diet recommendations, lifestyle modifications...',
                            modules: { toolbar: toolbarOptions }
                        });
                    }

                    if (!historyEditorRef.current) {
                        historyEditorRef.current = new Quill('#history-editor', {
                            theme: 'snow',
                            placeholder: 'Enter detailed medical history...',
                            modules: { toolbar: toolbarOptions }
                        });
                    }
                }
            }, []);

            // Auto-calculate BMI
            React.useEffect(() => {
                const { height, weight } = formData.vitals;
                if (height && weight && height > 0) {
                    const heightInMeters = height / 100;
                    const bmi = (weight / (heightInMeters * heightInMeters)).toFixed(1);
                    setFormData(prev => ({
                        ...prev,
                        vitals: { ...prev.vitals, bmi }
                    }));
                }
            }, [formData.vitals.height, formData.vitals.weight]);

            // Auto-save functionality (every 30 seconds)
            React.useEffect(() => {
                const autoSaveInterval = setInterval(() => {
                    handleAutoSave();
                }, 30000);

                return () => clearInterval(autoSaveInterval);
            }, [formData]);

            // ============================================================================
            // HANDLERS
            // ============================================================================

            const handleVitalsChange = (field, value) => {
                setFormData(prev => ({
                    ...prev,
                    vitals: { ...prev.vitals, [field]: value }
                }));
            };

            const addComplaint = () => {
                setFormData(prev => ({
                    ...prev,
                    complaints: [...prev.complaints, { 
                        complaint: '', 
                        duration: '', 
                        severity: 'moderate' 
                    }]
                }));
            };

            const updateComplaint = (index, field, value) => {
                setFormData(prev => ({
                    ...prev,
                    complaints: prev.complaints.map((item, i) => 
                        i === index ? { ...item, [field]: value } : item
                    )
                }));
            };

            const removeComplaint = (index) => {
                setFormData(prev => ({
                    ...prev,
                    complaints: prev.complaints.filter((_, i) => i !== index)
                }));
            };

            const addDiagnosis = () => {
                setFormData(prev => ({
                    ...prev,
                    diagnosis: [...prev.diagnosis, { 
                        code: '', 
                        description: '', 
                        type: 'provisional',
                        notes: ''
                    }]
                }));
            };

            const updateDiagnosis = (index, field, value) => {
                setFormData(prev => ({
                    ...prev,
                    diagnosis: prev.diagnosis.map((item, i) => 
                        i === index ? { ...item, [field]: value } : item
                    )
                }));
            };

            const removeDiagnosis = (index) => {
                setFormData(prev => ({
                    ...prev,
                    diagnosis: prev.diagnosis.filter((_, i) => i !== index)
                }));
            };

            const addInvestigation = () => {
                setFormData(prev => ({
                    ...prev,
                    investigations: [...prev.investigations, {
                        testName: '',
                        category: '',
                        urgency: 'routine',
                        notes: ''
                    }]
                }));
            };

            const updateInvestigation = (index, field, value) => {
                setFormData(prev => ({
                    ...prev,
                    investigations: prev.investigations.map((item, i) => 
                        i === index ? { ...item, [field]: value } : item
                    )
                }));
            };

            const removeInvestigation = (index) => {
                setFormData(prev => ({
                    ...prev,
                    investigations: prev.investigations.filter((_, i) => i !== index)
                }));
            };

            const addPrescription = () => {
                setFormData(prev => ({
                    ...prev,
                    prescriptions: [...prev.prescriptions, {
                        medicine: '',
                        type: 'branded', // branded or generic
                        dosage: '',
                        frequency: '',
                        duration: '',
                        instructions: '',
                        route: 'oral'
                    }]
                }));
            };

            const updatePrescription = (index, field, value) => {
                setFormData(prev => ({
                    ...prev,
                    prescriptions: prev.prescriptions.map((item, i) => 
                        i === index ? { ...item, [field]: value } : item
                    )
                }));
            };

            const removePrescription = (index) => {
                setFormData(prev => ({
                    ...prev,
                    prescriptions: prev.prescriptions.filter((_, i) => i !== index)
                }));
            };

            const handleAutoSave = () => {
                // In production: Save to backend
                console.log('Auto-saving...', formData);
                setLastSaved(new Date());
            };

            const handleSaveAndPrint = async () => {
                setIsSaving(true);

                // Collect data from Quill editors
                const visitData = {
                    ...formData,
                    examination: examinationEditorRef.current?.root.innerHTML || '',
                    advice: adviceEditorRef.current?.root.innerHTML || '',
                    medicalHistory: historyEditorRef.current?.root.innerHTML || '',
                    patientId: patient.id,
                    visitDate: new Date().toISOString(),
                    doctorId: sessionStorage.getItem('userId')
                };

                try {
                    // In production: API call to save data
                    // await saveVisitData(visitData);

                    console.log('Saving visit data:', visitData);

                    // Simulate save delay
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    alert('Prescription saved successfully! Ready to print.');
                    setLastSaved(new Date());
                } catch (error) {
                    console.error('Error saving visit data:', error);
                    alert('Error saving data. Please try again.');
                } finally {
                    setIsSaving(false);
                }
            };

            const handleEndConsultation = () => {
                if (confirm('Are you sure you want to end this consultation?')) {
                    handleSaveAndPrint();
                    // Navigate back to list after a short delay
                    setTimeout(() => onBack(), 1500);
                }
            };

            // ============================================================================
            // RENDER
            // ============================================================================

            return (
                <div className="h-full flex flex-col bg-white rounded-xl shadow-lg overflow-hidden">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-medical-blue via-[#1565C0] to-medical-accent p-4 text-white shadow-lg">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <button
                                    onClick={onBack}
                                    className="p-2 hover:bg-white/20 rounded-lg transition-colors"
                                    title="Back to patient list"
                                >
                                    <i className="fas fa-arrow-left text-xl"></i>
                                </button>
                                <div className="flex items-center gap-3">
                                    <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center text-2xl font-bold border-2 border-white/30">
                                        {patient.name.charAt(0)}
                                    </div>
                                    <div>
                                        <h2 className="text-xl font-bold flex items-center gap-2">
                                            {patient.name}
                                            {patient.medicalHistory?.allergies?.length > 0 && (
                                                <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-red-500 text-white">
                                                    <i className="fas fa-exclamation-triangle mr-1"></i>
                                                    Allergies
                                                </span>
                                            )}
                                        </h2>
                                        <p className="text-sm text-blue-100">
                                            ID: {patient.id} | {patient.age}Y/{patient.gender} | {patient.phone}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div className="flex gap-2 items-center">
                                {lastSaved && (
                                    <span className="text-xs text-blue-100 mr-2">
                                        <i className="fas fa-check-circle mr-1"></i>
                                        Last saved: {lastSaved.toLocaleTimeString()}
                                    </span>
                                )}
                                <button
                                    onClick={handleSaveAndPrint}
                                    disabled={isSaving}
                                    className="px-4 py-2 bg-white text-medical-blue hover:bg-blue-50 rounded-lg flex items-center gap-2 transition-all font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {isSaving ? (
                                        <><i className="fas fa-spinner fa-spin"></i> Saving...</>
                                    ) : (
                                        <><i className="fas fa-save"></i> Save & Print</>
                                    )}
                                </button>
                                <button
                                    onClick={handleEndConsultation}
                                    className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg flex items-center gap-2 transition-colors font-semibold"
                                >
                                    <i className="fas fa-check-double"></i>
                                    End Consultation
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Main Content Area */}
                    <div className="flex-1 overflow-y-auto p-6 bg-gradient-to-br from-gray-50 to-blue-50/30">
                        <div className="max-w-7xl mx-auto space-y-6">

                            {/* Vitals Section */}
                            <div className="bg-white p-6 rounded-xl border border-blue-100 shadow-sm hover:shadow-md transition-shadow">
                                <h3 className="text-lg font-bold text-medical-dark mb-4 flex items-center gap-2 pb-3 border-b-2 border-blue-100">
                                    <div className="w-10 h-10 bg-gradient-to-br from-red-500 to-pink-500 rounded-lg flex items-center justify-center">
                                        <i className="fas fa-heartbeat text-white"></i>
                                    </div>
                                    <span>Vitals</span>
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    {/* Blood Pressure */}
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            <i className="fas fa-tachometer-alt text-red-500 mr-1"></i>
                                            Blood Pressure (mmHg)
                                        </label>
                                        <div className="flex gap-2">
                                            <input
                                                type="number"
                                                placeholder="Sys"
                                                className="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-red-400 focus:border-transparent transition-all"
                                                value={formData.vitals.bp_systolic}
                                                onChange={(e) => handleVitalsChange('bp_systolic', e.target.value)}
                                            />
                                            <span className="text-gray-400 self-center">/</span>
                                            <input
                                                type="number"
                                                placeholder="Dia"
                                                className="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-red-400 focus:border-transparent transition-all"
                                                value={formData.vitals.bp_diastolic}
                                                onChange={(e) => handleVitalsChange('bp_diastolic', e.target.value)}
                                            />
                                        </div>
                                    </div>

                                    {/* Pulse */}
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            <i className="fas fa-heart text-pink-500 mr-1"></i>
                                            Pulse (bpm)
                                        </label>
                                        <input
                                            type="number"
                                            placeholder="e.g., 72"
                                            className="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-pink-400 focus:border-transparent transition-all"
                                            value={formData.vitals.pulse}
                                            onChange={(e) => handleVitalsChange('pulse', e.target.value)}
                                        />
                                    </div>

                                    {/* Height */}
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            <i className="fas fa-arrows-alt-v text-blue-500 mr-1"></i>
                                            Height (cm)
                                        </label>
                                        <input
                                            type="number"
                                            placeholder="e.g., 170"
                                            className="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition-all"
                                            value={formData.vitals.height}
                                            onChange={(e) => handleVitalsChange('height', e.target.value)}
                                        />
                                    </div>

                                    {/* Weight */}
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            <i className="fas fa-weight text-purple-500 mr-1"></i>
                                            Weight (kg)
                                        </label>
                                        <input
                                            type="number"
                                            placeholder="e.g., 65"
                                            className="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent transition-all"
                                            value={formData.vitals.weight}
                                            onChange={(e) => handleVitalsChange('weight', e.target.value)}
                                        />
                                    </div>

                                    {/* Temperature */}
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            <i className="fas fa-thermometer-half text-orange-500 mr-1"></i>
                                            Temperature (°F)
                                        </label>
                                        <input
                                            type="number"
                                            step="0.1"
                                            placeholder="e.g., 98.6"
                                            className="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-orange-400 focus:border-transparent transition-all"
                                            value={formData.vitals.temp}
                                            onChange={(e) => handleVitalsChange('temp', e.target.value)}
                                        />
                                    </div>

                                    {/* SPO2 */}
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            <i className="fas fa-lungs text-cyan-500 mr-1"></i>
                                            SPO2 (%)
                                        </label>
                                        <input
                                            type="number"
                                            placeholder="e.g., 98"
                                            min="0"
                                            max="100"
                                            className="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-transparent transition-all"
                                            value={formData.vitals.spo2}
                                            onChange={(e) => handleVitalsChange('spo2', e.target.value)}
                                        />
                                    </div>

                                    {/* Respiratory Rate */}
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            <i className="fas fa-wind text-teal-500 mr-1"></i>
                                            Resp. Rate (/min)
                                        </label>
                                        <input
                                            type="number"
                                            placeholder="e.g., 16"
                                            className="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-400 focus:border-transparent transition-all"
                                            value={formData.vitals.respiratoryRate}
                                            onChange={(e) => handleVitalsChange('respiratoryRate', e.target.value)}
                                        />
                                    </div>

                                    {/* BMI (Auto-calculated) */}
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            <i className="fas fa-calculator text-indigo-500 mr-1"></i>
                                            BMI
                                        </label>
                                        <input
                                            type="text"
                                            placeholder="Auto-calculated"
                                            className="w-full px-3 py-2 border-2 border-gray-200 rounded-lg bg-gray-50 font-semibold text-indigo-600"
                                            value={formData.vitals.bmi}
                                            readOnly
                                        />
                                    </div>
                                </div>
                            </div>

                            {/* Medical History Section */}
                            <div className="bg-white p-6 rounded-xl border border-amber-100 shadow-sm hover:shadow-md transition-shadow">
                                <h3 className="text-lg font-bold text-medical-dark mb-4 flex items-center gap-2 pb-3 border-b-2 border-amber-100">
                                    <div className="w-10 h-10 bg-gradient-to-br from-amber-500 to-orange-500 rounded-lg flex items-center justify-center">
                                        <i className="fas fa-history text-white"></i>
                                    </div>
                                    <span>Medical History</span>
                                </h3>
                                <div className="space-y-4">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                <i className="fas fa-allergies text-red-500 mr-1"></i>
                                                Known Allergies
                                            </label>
                                            <input
                                                type="text"
                                                placeholder="e.g., Penicillin, Peanuts"
                                                className="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-red-400 focus:border-transparent"
                                                value={formData.history.allergies}
                                                onChange={(e) => setFormData(prev => ({
                                                    ...prev,
                                                    history: { ...prev.history, allergies: e.target.value }
                                                }))}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                <i className="fas fa-pills text-green-500 mr-1"></i>
                                                Current Medications
                                            </label>
                                            <input
                                                type="text"
                                                placeholder="e.g., Metformin, Aspirin"
                                                className="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-transparent"
                                                value={formData.history.currentMedications}
                                                onChange={(e) => setFormData(prev => ({
                                                    ...prev,
                                                    history: { ...prev.history, currentMedications: e.target.value }
                                                }))}
                                            />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            <i className="fas fa-file-medical text-amber-500 mr-1"></i>
                                            Detailed Medical History
                                        </label>
                                        <div id="history-editor" className="border-2 border-gray-200 rounded-lg" style={{minHeight: '150px'}}></div>
                                    </div>
                                </div>
                            </div>

                            {/* Chief Complaints Section */}
                            <div className="bg-white p-6 rounded-xl border border-purple-100 shadow-sm hover:shadow-md transition-shadow">
                                <div className="flex items-center justify-between mb-4 pb-3 border-b-2 border-purple-100">
                                    <h3 className="text-lg font-bold text-medical-dark flex items-center gap-2">
                                        <div className="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center">
                                            <i className="fas fa-notes-medical text-white"></i>
                                        </div>
                                        <span>Chief Complaints</span>
                                    </h3>
                                    <button
                                        onClick={addComplaint}
                                        className="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:shadow-lg transition-all text-sm flex items-center gap-2 font-semibold"
                                    >
                                        <i className="fas fa-plus"></i>
                                        Add Complaint
                                    </button>
                                </div>
                                {formData.complaints.length === 0 ? (
                                    <div className="text-center py-12 bg-purple-50 rounded-lg border-2 border-dashed border-purple-200">
                                        <i className="fas fa-clipboard-list text-5xl text-purple-300 mb-3"></i>
                                        <p className="text-gray-600 font-medium">No complaints added yet</p>
                                        <p className="text-sm text-gray-500 mt-1">Click "Add Complaint" to record patient's chief complaints</p>
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        {formData.complaints.map((complaint, index) => (
                                            <div key={index} className="p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border border-purple-200 hover:shadow-md transition-shadow">
                                                <div className="flex items-start gap-3">
                                                    <div className="flex-1 grid grid-cols-1 md:grid-cols-3 gap-3">
                                                        <input
                                                            type="text"
                                                            placeholder="Complaint description"
                                                            className="px-3 py-2 border-2 border-purple-200 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent"
                                                            value={complaint.complaint}
                                                            onChange={(e) => updateComplaint(index, 'complaint', e.target.value)}
                                                        />
                                                        <input
                                                            type="text"
                                                            placeholder="Duration (e.g., 2 days)"
                                                            className="px-3 py-2 border-2 border-purple-200 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent"
                                                            value={complaint.duration}
                                                            onChange={(e) => updateComplaint(index, 'duration', e.target.value)}
                                                        />
                                                        <select
                                                            className="px-3 py-2 border-2 border-purple-200 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent"
                                                            value={complaint.severity}
                                                            onChange={(e) => updateComplaint(index, 'severity', e.target.value)}
                                                        >
                                                            <option value="mild">Mild</option>
                                                            <option value="moderate">Moderate</option>
                                                            <option value="severe">Severe</option>
                                                        </select>
                                                    </div>
                                                    <button
                                                        onClick={() => removeComplaint(index)}
                                                        className="p-2 text-red-500 hover:bg-red-100 rounded-lg transition-colors"
                                                        title="Remove complaint"
                                                    >
                                                        <i className="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* Clinical Examination Section */}
                            <div className="bg-white p-6 rounded-xl border border-teal-100 shadow-sm hover:shadow-md transition-shadow">
                                <h3 className="text-lg font-bold text-medical-dark mb-4 flex items-center gap-2 pb-3 border-b-2 border-teal-100">
                                    <div className="w-10 h-10 bg-gradient-to-br from-teal-500 to-cyan-500 rounded-lg flex items-center justify-center">
                                        <i className="fas fa-user-md text-white"></i>
                                    </div>
                                    <span>Clinical Examination</span>
                                </h3>
                                <div id="examination-editor" className="border-2 border-gray-200 rounded-lg" style={{minHeight: '200px'}}></div>
                            </div>

                            {/* Diagnosis Section */}
                            <div className="bg-white p-6 rounded-xl border border-indigo-100 shadow-sm hover:shadow-md transition-shadow">
                                <div className="flex items-center justify-between mb-4 pb-3 border-b-2 border-indigo-100">
                                    <h3 className="text-lg font-bold text-medical-dark flex items-center gap-2">
                                        <div className="w-10 h-10 bg-gradient-to-br from-indigo-500 to-blue-500 rounded-lg flex items-center justify-center">
                                            <i className="fas fa-stethoscope text-white"></i>
                                        </div>
                                        <span>Diagnosis</span>
                                    </h3>
                                    <button
                                        onClick={addDiagnosis}
                                        className="px-4 py-2 bg-gradient-to-r from-indigo-500 to-blue-500 text-white rounded-lg hover:shadow-lg transition-all text-sm flex items-center gap-2 font-semibold"
                                    >
                                        <i className="fas fa-plus"></i>
                                        Add Diagnosis
                                    </button>
                                </div>
                                {formData.diagnosis.length === 0 ? (
                                    <div className="text-center py-12 bg-indigo-50 rounded-lg border-2 border-dashed border-indigo-200">
                                        <i className="fas fa-diagnoses text-5xl text-indigo-300 mb-3"></i>
                                        <p className="text-gray-600 font-medium">No diagnosis added yet</p>
                                        <p className="text-sm text-gray-500 mt-1">Click "Add Diagnosis" to record provisional or final diagnosis</p>
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        {formData.diagnosis.map((diag, index) => (
                                            <div key={index} className="p-4 bg-gradient-to-r from-indigo-50 to-blue-50 rounded-lg border border-indigo-200 hover:shadow-md transition-shadow">
                                                <div className="flex items-start gap-3">
                                                    <div className="flex-1 space-y-3">
                                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                                            <input
                                                                type="text"
                                                                placeholder="ICD Code (e.g., J00)"
                                                                className="px-3 py-2 border-2 border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-transparent"
                                                                value={diag.code}
                                                                onChange={(e) => updateDiagnosis(index, 'code', e.target.value)}
                                                            />
                                                            <input
                                                                type="text"
                                                                placeholder="Diagnosis description"
                                                                className="px-3 py-2 border-2 border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-transparent md:col-span-2"
                                                                value={diag.description}
                                                                onChange={(e) => updateDiagnosis(index, 'description', e.target.value)}
                                                            />
                                                        </div>
                                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                            <select
                                                                className="px-3 py-2 border-2 border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-transparent"
                                                                value={diag.type}
                                                                onChange={(e) => updateDiagnosis(index, 'type', e.target.value)}
                                                            >
                                                                <option value="provisional">Provisional Diagnosis</option>
                                                                <option value="final">Final Diagnosis</option>
                                                                <option value="differential">Differential Diagnosis</option>
                                                            </select>
                                                            <input
                                                                type="text"
                                                                placeholder="Additional notes"
                                                                className="px-3 py-2 border-2 border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-transparent"
                                                                value={diag.notes}
                                                                onChange={(e) => updateDiagnosis(index, 'notes', e.target.value)}
                                                            />
                                                        </div>
                                                    </div>
                                                    <button
                                                        onClick={() => removeDiagnosis(index)}
                                                        className="p-2 text-red-500 hover:bg-red-100 rounded-lg transition-colors"
                                                        title="Remove diagnosis"
                                                    >
                                                        <i className="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* Investigations Section */}
                            <div className="bg-white p-6 rounded-xl border border-cyan-100 shadow-sm hover:shadow-md transition-shadow">
                                <div className="flex items-center justify-between mb-4 pb-3 border-b-2 border-cyan-100">
                                    <h3 className="text-lg font-bold text-medical-dark flex items-center gap-2">
                                        <div className="w-10 h-10 bg-gradient-to-br from-cyan-500 to-teal-500 rounded-lg flex items-center justify-center">
                                            <i className="fas fa-flask text-white"></i>
                                        </div>
                                        <span>Investigations / Lab Tests</span>
                                    </h3>
                                    <button
                                        onClick={addInvestigation}
                                        className="px-4 py-2 bg-gradient-to-r from-cyan-500 to-teal-500 text-white rounded-lg hover:shadow-lg transition-all text-sm flex items-center gap-2 font-semibold"
                                    >
                                        <i className="fas fa-plus"></i>
                                        Add Investigation
                                    </button>
                                </div>
                                {formData.investigations.length === 0 ? (
                                    <div className="text-center py-12 bg-cyan-50 rounded-lg border-2 border-dashed border-cyan-200">
                                        <i className="fas fa-vials text-5xl text-cyan-300 mb-3"></i>
                                        <p className="text-gray-600 font-medium">No investigations ordered yet</p>
                                        <p className="text-sm text-gray-500 mt-1">Click "Add Investigation" to order lab tests or imaging</p>
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        {formData.investigations.map((inv, index) => (
                                            <div key={index} className="p-4 bg-gradient-to-r from-cyan-50 to-teal-50 rounded-lg border border-cyan-200 hover:shadow-md transition-shadow">
                                                <div className="flex items-start gap-3">
                                                    <div className="flex-1 grid grid-cols-1 md:grid-cols-4 gap-3">
                                                        <input
                                                            type="text"
                                                            placeholder="Test Name"
                                                            className="px-3 py-2 border-2 border-cyan-200 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-transparent"
                                                            value={inv.testName}
                                                            onChange={(e) => updateInvestigation(index, 'testName', e.target.value)}
                                                        />
                                                        <select
                                                            className="px-3 py-2 border-2 border-cyan-200 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-transparent"
                                                            value={inv.category}
                                                            onChange={(e) => updateInvestigation(index, 'category', e.target.value)}
                                                        >
                                                            <option value="">Category</option>
                                                            <option value="blood">Blood Test</option>
                                                            <option value="urine">Urine Test</option>
                                                            <option value="xray">X-Ray</option>
                                                            <option value="ultrasound">Ultrasound</option>
                                                            <option value="mri">MRI</option>
                                                            <option value="ct">CT Scan</option>
                                                            <option value="ecg">ECG</option>
                                                            <option value="other">Other</option>
                                                        </select>
                                                        <select
                                                            className="px-3 py-2 border-2 border-cyan-200 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-transparent"
                                                            value={inv.urgency}
                                                            onChange={(e) => updateInvestigation(index, 'urgency', e.target.value)}
                                                        >
                                                            <option value="routine">Routine</option>
                                                            <option value="urgent">Urgent</option>
                                                            <option value="stat">STAT</option>
                                                        </select>
                                                        <input
                                                            type="text"
                                                            placeholder="Notes"
                                                            className="px-3 py-2 border-2 border-cyan-200 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-transparent"
                                                            value={inv.notes}
                                                            onChange={(e) => updateInvestigation(index, 'notes', e.target.value)}
                                                        />
                                                    </div>
                                                    <button
                                                        onClick={() => removeInvestigation(index)}
                                                        className="p-2 text-red-500 hover:bg-red-100 rounded-lg transition-colors"
                                                        title="Remove investigation"
                                                    >
                                                        <i className="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* Prescription Section */}
                            <div className="bg-white p-6 rounded-xl border border-green-100 shadow-sm hover:shadow-md transition-shadow">
                                <div className="flex items-center justify-between mb-4 pb-3 border-b-2 border-green-100">
                                    <h3 className="text-lg font-bold text-medical-dark flex items-center gap-2">
                                        <div className="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-500 rounded-lg flex items-center justify-center">
                                            <i className="fas fa-prescription text-white"></i>
                                        </div>
                                        <span>Prescription</span>
                                    </h3>
                                    <button
                                        onClick={addPrescription}
                                        className="px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg hover:shadow-lg transition-all text-sm flex items-center gap-2 font-semibold"
                                    >
                                        <i className="fas fa-plus"></i>
                                        Add Medicine
                                    </button>
                                </div>
                                {formData.prescriptions.length === 0 ? (
                                    <div className="text-center py-12 bg-green-50 rounded-lg border-2 border-dashed border-green-200">
                                        <i className="fas fa-pills text-5xl text-green-300 mb-3"></i>
                                        <p className="text-gray-600 font-medium">No medicines prescribed yet</p>
                                        <p className="text-sm text-gray-500 mt-1">Click "Add Medicine" to prescribe medications</p>
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        {formData.prescriptions.map((prescription, index) => (
                                            <div key={index} className="p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border-2 border-green-200 hover:shadow-md transition-shadow">
                                                <div className="flex items-start gap-3">
                                                    <div className="flex-1 space-y-3">
                                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                            <input
                                                                type="text"
                                                                placeholder="Medicine name"
                                                                className="px-3 py-2 border-2 border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-transparent font-medium"
                                                                value={prescription.medicine}
                                                                onChange={(e) => updatePrescription(index, 'medicine', e.target.value)}
                                                            />
                                                            <select
                                                                className="px-3 py-2 border-2 border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-transparent"
                                                                value={prescription.type}
                                                                onChange={(e) => updatePrescription(index, 'type', e.target.value)}
                                                            >
                                                                <option value="branded">Branded</option>
                                                                <option value="generic">Generic</option>
                                                            </select>
                                                        </div>
                                                        <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                                                            <input
                                                                type="text"
                                                                placeholder="Dosage (e.g., 500mg)"
                                                                className="px-3 py-2 border-2 border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-transparent"
                                                                value={prescription.dosage}
                                                                onChange={(e) => updatePrescription(index, 'dosage', e.target.value)}
                                                            />
                                                            <select
                                                                className="px-3 py-2 border-2 border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-transparent"
                                                                value={prescription.frequency}
                                                                onChange={(e) => updatePrescription(index, 'frequency', e.target.value)}
                                                            >
                                                                <option value="">Select Frequency</option>
                                                                <option value="od">Once Daily (OD)</option>
                                                                <option value="bd">Twice Daily (BD)</option>
                                                                <option value="tds">Three Times Daily (TDS)</option>
                                                                <option value="qid">Four Times Daily (QID)</option>
                                                                <option value="sos">SOS (When Required)</option>
                                                                <option value="stat">STAT (Immediately)</option>
                                                            </select>
                                                            <select
                                                                className="px-3 py-2 border-2 border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-transparent"
                                                                value={prescription.route}
                                                                onChange={(e) => updatePrescription(index, 'route', e.target.value)}
                                                            >
                                                                <option value="oral">Oral</option>
                                                                <option value="topical">Topical</option>
                                                                <option value="iv">IV</option>
                                                                <option value="im">IM</option>
                                                                <option value="sc">SC</option>
                                                            </select>
                                                            <input
                                                                type="text"
                                                                placeholder="Duration (e.g., 7 days)"
                                                                className="px-3 py-2 border-2 border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-transparent"
                                                                value={prescription.duration}
                                                                onChange={(e) => updatePrescription(index, 'duration', e.target.value)}
                                                            />
                                                        </div>
                                                        <textarea
                                                            placeholder="Special instructions (e.g., Take after meals, Avoid alcohol)"
                                                            className="w-full px-3 py-2 border-2 border-green-200 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-transparent"
                                                            rows="2"
                                                            value={prescription.instructions}
                                                            onChange={(e) => updatePrescription(index, 'instructions', e.target.value)}
                                                        ></textarea>
                                                    </div>
                                                    <button
                                                        onClick={() => removePrescription(index)}
                                                        className="p-2 text-red-500 hover:bg-red-100 rounded-lg transition-colors"
                                                        title="Remove prescription"
                                                    >
                                                        <i className="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* Advice & Follow-up Section */}
                            <div className="bg-white p-6 rounded-xl border border-blue-100 shadow-sm hover:shadow-md transition-shadow">
                                <h3 className="text-lg font-bold text-medical-dark mb-4 flex items-center gap-2 pb-3 border-b-2 border-blue-100">
                                    <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-lg flex items-center justify-center">
                                        <i className="fas fa-clipboard-list text-white"></i>
                                    </div>
                                    <span>Advice & Follow-up Instructions</span>
                                </h3>
                                <div className="space-y-4">
                                    <div id="advice-editor" className="border-2 border-gray-200 rounded-lg" style={{minHeight: '200px'}}></div>
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            <i className="fas fa-calendar-check text-blue-500 mr-1"></i>
                                            Next Follow-up Date
                                        </label>
                                        <input
                                            type="date"
                                            className="px-4 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent"
                                            value={formData.nextVisitDate}
                                            onChange={(e) => setFormData(prev => ({
                                                ...prev,
                                                nextVisitDate: e.target.value
                                            }))}
                                            min={new Date().toISOString().split('T')[0]}
                                        />
                                    </div>
                                </div>
                            </div>

                            {/* Previous Prescriptions Section */}
                            {patient.previousVisits && patient.previousVisits.length > 0 && (
                                <div className="bg-white p-6 rounded-xl border border-violet-100 shadow-sm hover:shadow-md transition-shadow">
                                    <h3 className="text-lg font-bold text-medical-dark mb-4 flex items-center gap-2 pb-3 border-b-2 border-violet-100">
                                        <div className="w-10 h-10 bg-gradient-to-br from-violet-500 to-purple-500 rounded-lg flex items-center justify-center">
                                            <i className="fas fa-history text-white"></i>
                                        </div>
                                        <span>Previous Prescriptions</span>
                                    </h3>
                                    <div className="space-y-3">
                                        {patient.previousVisits.map((visit, index) => (
                                            <div key={index} className="p-4 bg-gradient-to-r from-violet-50 to-purple-50 rounded-lg border border-violet-200">
                                                <div className="flex justify-between items-start mb-3">
                                                    <div>
                                                        <h4 className="font-semibold text-gray-900">
                                                            Visit Date: {new Date(visit.date).toLocaleDateString('en-IN', {
                                                                year: 'numeric',
                                                                month: 'long',
                                                                day: 'numeric'
                                                            })}
                                                        </h4>
                                                        <p className="text-sm text-gray-600 mt-1">
                                                            <strong>Complaints:</strong> {visit.complaints.join(', ')}
                                                        </p>
                                                        <p className="text-sm text-gray-600">
                                                            <strong>Diagnosis:</strong> {visit.diagnosis.join(', ')}
                                                        </p>
                                                    </div>
                                                </div>
                                                <div className="mt-3 pt-3 border-t border-violet-200">
                                                    <p className="text-sm font-semibold text-gray-700 mb-2">Medications:</p>
                                                    <div className="space-y-2">
                                                        {visit.prescriptions.map((rx, rxIndex) => (
                                                            <div key={rxIndex} className="flex items-center gap-2 text-sm bg-white p-2 rounded-lg">
                                                                <i className="fas fa-pills text-violet-500"></i>
                                                                <span className="font-medium">{rx.medicine}</span>
                                                                <span className="text-gray-500">-</span>
                                                                <span>{rx.dosage}, {rx.frequency}, {rx.duration}</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                        </div>
                    </div>
                </div>
            );
        };

        // Set the main export
        const ConsultationEditor = ConsultationView;


        const Users = () => (
            <div className="medical-card p-6 rounded-2xl">
                <h2 className="text-xl font-bold text-medical-dark font-primary mb-4">Users Management</h2>
                <p className="text-medical-gray">User management component placeholder. This view is currently under construction.</p>
            </div>
        );

        const LogViewer = () => (
            <div className="medical-card p-6 rounded-2xl">
                <h2 className="text-xl font-bold text-medical-dark font-primary mb-4">Audit Logs</h2>
                <p className="text-medical-gray">Audit log viewer component placeholder. Functionality will be added soon.</p>
            </div>
        );



        const App = () => {
            const [isMobileMenuOpen, setIsMobileMenuOpen] = React.useState(false);
            const [user, setUser] = React.useState(() => {
                const userData = sessionStorage.getItem('user');
                return userData ? JSON.parse(userData) : null;
            });
            const [currentView, setCurrentView] = React.useState('dashboard');
            const [isModalOpen, setIsModalOpen] = React.useState(false);
            const [modalTitle, setModalTitle] = React.useState('');
            const [modalContent, setModalContent] = React.useState(null);

            const openModal = (title, content) => {
                setModalTitle(title);
                setModalContent(content);
                setIsModalOpen(true);
            };

            const closeModal = () => {
                setIsModalOpen(false);
                setModalTitle('');
                setModalContent(null);
            };

            React.useEffect(() => {
                const token = sessionStorage.getItem('accessToken');
                if (!token || !user) {
                    window.location.href = './admin_login.html';
                }
            }, [user]);

            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <LoadingSpinner />
                    </div>
                );
            }

            const renderCurrentView = () => {
                switch (currentView) {
                    case 'dashboard':
                        return <Dashboard openModal={openModal} closeModal={closeModal} />;
                    case 'appointments':
                        return <Appointments openModal={openModal} closeModal={closeModal} user={user} />; 
                    case 'schedule':

                        return <DoctorSchedule openModal={openModal} closeModal={closeModal} user={user} />;
                    case 'patients':
                        return <Patients />;
                    case 'consultation': 
                        return <ConsultationEditor />;

                    case 'users':
                        return user.role === 'admin' ? <Users /> : <Dashboard />;
                    case 'logs':
                        return user.role === 'admin' ? <LogViewer /> : <Dashboard />;
                    default:
                        return <Dashboard />;
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-medical-light-gray via-medical-light to-medical-light-gray">
                    <div className="flex flex-col md:flex-row h-screen overflow-hidden">
                        <Sidebar
                            currentView={currentView}
                            setCurrentView={setCurrentView}
                            user={user}
                            isMobileMenuOpen={isMobileMenuOpen}
                            setIsMobileMenuOpen={setIsMobileMenuOpen}
                        />
                        <main className="flex-1 overflow-auto relative ml-0 md:ml-0">
                            <div className="md:hidden flex items-center justify-between p-4 bg-white/80 backdrop-blur-sm sticky top-0 z-30 shadow-sm">
                                <button onClick={() => setIsMobileMenuOpen(true)} className="text-medical-dark">
                                    <i className="fas fa-bars text-xl"></i>
                                </button>
                                <div className="font-semibold text-medical-dark">{user?.username}</div>
                            </div>
                            <div className="p-8">
                                <div className="max-w-7xl mx-auto floating-elements relative">
                                    {renderCurrentView()}
                                    <Modal
                                        isOpen={isModalOpen}
                                        onClose={closeModal}
                                        title={modalTitle}
                                    >
                                        {modalContent}
                                    </Modal>
                                </div>
                            </div>
                        </main>
                    </div>
                </div>
            );
        };

        const QuickActions = () => {
            const [open, setOpen] = React.useState(false);
            const [services, setServices] = React.useState(null);
            const [config, setConfig] = React.useState({ appointment_interval_minutes: 15, appointment_daily_limit: 2 });
            const [loading, setLoading] = React.useState(false);
            const [error, setError] = React.useState("");

            const fetchServices = async () => {
                setLoading(true); setError("");
                try {
                    const data = await api('/api/v1/services/status');
                    setServices(data);
                } catch (e) { setError('Failed to load services status'); }
                finally { setLoading(false); }
            };

            const fetchConfig = async () => {
                try {
                    const data = await api('/api/v1/schedules/config');
                    setConfig(data);
                } catch (e) {  }
            };

            React.useEffect(() => { fetchConfig(); }, []);

            const saveConfig = async () => {
                setLoading(true); setError("");
                try {
                    await api(`/api/v1/schedules/config?appointment_interval_minutes=${config.appointment_interval_minutes}&appointment_daily_limit=${config.appointment_daily_limit}`, { method: 'POST' });
                    toast('Schedule config saved');
                } catch (e) { setError('Failed to save config'); }
                finally { setLoading(false); }
            };

            const onTemplateUpload = async (e) => {
                const file = e.target.files?.[0]; if (!file) return;
                const token = sessionStorage.getItem('accessToken');
                const form = new FormData(); form.append('template_file', file);
                try {
                    const res = await fetch(API_BASE_URL + '/api/v1/prescriptions/template/upload', {
                        method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: form
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data?.detail || 'Upload failed');
                    toast('Template uploaded');
                } catch (err) { toast('Template upload failed'); }
            };

            const onHandwrittenUpload = async (patientId, file) => {
                if (!file || !patientId) return toast('Select patient and file');
                const token = sessionStorage.getItem('accessToken');
                const form = new FormData(); form.append('patient_id', String(patientId)); form.append('file', file);
                try {
                    const res = await fetch(API_BASE_URL + '/api/v1/prescriptions/handwritten/upload', {
                        method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: form
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data?.detail || 'Upload failed');
                    toast('Handwritten prescription uploaded');
                } catch (err) { toast('Upload failed'); }
            };

            const [editorHtml, setEditorHtml] = React.useState('');
            const [editorPatientId, setEditorPatientId] = React.useState('');
            const saveEditor = async () => {
                if (!editorHtml || !editorPatientId) return toast('Enter patient and content');
                const token = sessionStorage.getItem('accessToken');
                const form = new FormData(); form.append('patient_id', editorPatientId); form.append('html_content', editorHtml);
                try {
                    const res = await fetch(API_BASE_URL + '/api/v1/prescriptions/editor/save', {
                        method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: form
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data?.detail || 'Save failed');
                    toast('Prescription saved');
                } catch (err) { toast('Save failed'); }
            };

            return (
                <>
                    <div className="fixed bottom-6 right-6 z-50 flex flex-col items-end space-y-3">
                        {open && (
                            <div className="medical-card p-4 rounded-xl w-96 shadow-xl">
                                <div className="flex items-center justify-between mb-3">
                                    <h3 className="font-semibold text-medical-dark">Quick Actions</h3>
                                    <button onClick={() => setOpen(false)} className="text-medical-gray"><i className="fas fa-times"></i></button>
                                </div>
                                {error && <div className="text-red-600 text-sm mb-2">{error}</div>}
                                <div className="space-y-4">
                                    <div className="border-b pb-3">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="font-medium">Services status</span>
                                            <button onClick={fetchServices} className="text-medical-accent text-sm">Refresh</button>
                                        </div>
                                        {loading && <LoadingSpinner />}
                                        {services && (
                                            <div className="grid grid-cols-3 gap-2 text-sm">
                                                {['whatsapp', 'email', 'calendar'].map(k => (
                                                    <div key={k} className="p-2 rounded bg-gray-50">
                                                        <div className="capitalize">{k}</div>
                                                        <div className={services[k]?.enabled ? 'text-green-600' : 'text-gray-500'}>
                                                            {services[k]?.status || (services[k]?.enabled ? 'healthy' : 'disabled')}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>

                                    <div className="border-b pb-3">
                                        <div className="font-medium mb-2">Schedule config</div>
                                        <div className="flex flex-wrap items-center gap-2 mb-2">
                                            <label className="text-sm w-40">Interval (min)</label>
                                            <input type="number" value={config.appointment_interval_minutes}
                                                onChange={e => setConfig({ ...config, appointment_interval_minutes: Number(e.target.value) })}
                                                className="form-input-themed" />
                                        </div>
                                        <div className="flex flex-wrap items-center gap-2 mb-2">
                                            <label className="text-sm w-40">Daily limit</label>
                                            <input type="number" value={config.appointment_daily_limit}
                                                onChange={e => setConfig({ ...config, appointment_daily_limit: Number(e.target.value) })}
                                                className="form-input-themed" />
                                        </div>
                                        <button onClick={saveConfig} className="medical-button text-white px-4 py-2 rounded">Save Config</button>
                                    </div>

                                    <div className="border-b pb-3">
                                        <div className="font-medium mb-2">Prescription template</div>
                                        <input type="file" accept="image/*,application/pdf" onChange={onTemplateUpload} className="custom-input " />
                                    </div>

                                    <div className="border-b pb-3">
                                        <div className="font-medium mb-2">Handwritten prescription upload</div>
                                        <div className="flex flex-wrap items-center gap-2 mb-2">
                                            <input type="number" placeholder="Patient ID" className="form-input-themed" id="handw_pid" />
                                        </div>
                                        <input type="file" accept="image/*,application/pdf" onChange={(e) => {
                                            const pid = document.getElementById('handw_pid').value;
                                            onHandwrittenUpload(pid, e.target.files?.[0]);
                                        }} className="w-full" />
                                    </div>

                                    <div>
                                        <div className="font-medium mb-2">Prescription editor save</div>
                                        <div className="flex flex-wrap items-center gap-2 mb-2">
                                            <input type="number" placeholder="Patient ID" value={editorPatientId} onChange={(e) => setEditorPatientId(e.target.value)} className="form-input-themed" />
                                        </div>
                                        <textarea rows="4" placeholder="Paste editor HTML here" value={editorHtml} onChange={(e) => setEditorHtml(e.target.value)} className="form-input-themed"></textarea>
                                        <div className="mt-2 flex justify-end">
                                            <button onClick={saveEditor} className="medical-button text-white px-4 py-2 rounded">Save</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        <button onClick={() => setOpen(!open)} className="medical-button text-white px-4 py-3 rounded-full shadow-lg">
                            <i className="fas fa-bolt mr-2"></i>Quick Actions
                        </button>
                    </div>
                </>
            );
        };

        const toast = (msg) => {
            const el = document.createElement('div');
            el.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 bg-medical-dark text-white px-4 py-2 rounded shadow z-[9999]';
            el.textContent = msg;
            document.body.appendChild(el);
            setTimeout(() => { el.remove(); }, 2500);
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<><App /><QuickActions /></>);
    </script>
</body>

</html>