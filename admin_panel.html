<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Clinic OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#272343', 'secondary': '#e3f6f5', 'accent': '#bae8e8', 'light': '#ffffff',
                        'text-dark': '#2d334a', 'text-light': '#5a5e74',
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e3f6f5;
        }

        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            transform: scale(0.95);
            opacity: 0;
            animation: zoomIn 0.3s forwards cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #272343;
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes zoomIn {
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, createContext, useContext } = React;

        // --- API Communication Helper ---
        const API_BASE_URL = 'http://127.0.0.1:8000';

        const api = {
            async request(endpoint, { body, ...customConfig } = {}) {
                const token = sessionStorage.getItem('accessToken');
                const headers = { 'Content-Type': 'application/json' };
                if (token) {
                    headers.Authorization = `Bearer ${token}`;
                }

                const config = {
                    method: body ? 'POST' : 'GET',
                    ...customConfig,
                    headers: { ...headers, ...customConfig.headers },
                };

                if (body) {
                    config.body = JSON.stringify(body);
                }

                const response = await fetch(`${API_BASE_URL}${endpoint}`, config);

                if (!response.ok) {
                    if (response.status === 401) {
                        alert("Session expired. Please log in again.");
                        sessionStorage.clear();
                        window.location.href = './admin_login.html';
                        return;
                    }
                    const error = await response.json();
                    return Promise.reject(error);
                }
                // Handle cases with no content in response
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    return response.json();
                }
                return {};
            },
            get: (endpoint, config) => api.request(endpoint, { ...config, method: 'GET' }),
            post: (endpoint, body, config) => api.request(endpoint, { ...config, body, method: 'POST' }),
            put: (endpoint, body, config) => api.request(endpoint, { ...config, body, method: 'PUT' }),
            patch: (endpoint, body, config) => api.request(endpoint, { ...config, body, method: 'PATCH' }),
            delete: (endpoint, config) => api.request(endpoint, { ...config, method: 'DELETE' }),
        };

        // --- Role-Based Access Control (RBAC) ---
        const AuthContext = createContext(null);
        const useAuth = () => useContext(AuthContext);

        // Mock schedule until a backend endpoint is created for it
        const MOCK_SCHEDULE = {
            1: [{ l: 1, s: '10:00', e: '15:30' }, { l: 2, s: '18:00', e: '19:30' }],
            2: [{ l: 1, s: '10:00', e: '15:30' }, { l: 2, s: '18:00', e: '19:30' }],
            3: [{ l: 1, s: '10:00', e: '15:30' }, { l: 2, s: '18:00', e: '19:30' }],
            4: [{ l: 1, s: '10:00', e: '15:30' }, { l: 2, s: '18:00', e: '19:30' }],
            5: [{ l: 1, s: '10:00', e: '15:30' }, { l: 2, s: '18:00', e: '19:30' }],
            6: [{ l: 1, s: '10:00', e: '15:30' }],
            0: [{ l: 2, s: '11:00', e: '14:30' }],
        };

        function App() {
            const [auth, setAuth] = useState({ user: null, token: sessionStorage.getItem('accessToken') });

            useEffect(() => {
                const token = sessionStorage.getItem('accessToken');
                const userRole = sessionStorage.getItem('userRole');

                if (!token) {
                    window.location.href = './admin_login.html';
                    return;
                }

                // Try to get user info from API, fallback to sessionStorage
                api.get('/users/me').then(user => {
                    setAuth({ user, token });
                }).catch(() => {
                    // Fallback to sessionStorage if API fails
                    if (userRole) {
                        setAuth({ user: { role: userRole, username: 'User' }, token });
                    } else {
                        sessionStorage.clear();
                        window.location.href = './admin_login.html';
                    }
                });
            }, []);

            if (!auth.user) {
                return (
                    <div className="flex h-screen items-center justify-center">
                        <div className="spinner"></div>
                    </div>
                );
            }

            return (
                <AuthContext.Provider value={auth.user}>
                    <AdminPanel />
                </AuthContext.Provider>
            );
        }

        function AdminPanel() {
            const currentUser = useAuth();
            const [activeView, setActiveView] = useState('dashboard');

            // --- STATE MANAGEMENT ---
            const [appointments, setAppointments] = useState([]);
            const [patients, setPatients] = useState([]);
            const [locations, setLocations] = useState([]);
            const [users, setUsers] = useState([]);
            const [logs, setLogs] = useState([]);
            const [schedule, setSchedule] = useState(MOCK_SCHEDULE);
            const [isLoading, setIsLoading] = useState(true);

            // --- DATA FETCHING (CORRECTED) ---
            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const today = new Date();
                        const startDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                        const endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];

                        // Fetch appointments for all users
                        const appointmentPromise = api.get(`/appointments/?start_date=${startDate}&end_date=${endDate}`);

                        // Fetch patients and locations
                        const patientsPromise = api.get('/patients/');
                        const locationsPromise = api.get('/locations/');

                        // Admin-specific data
                        const adminPromises = currentUser.role === 'admin'
                            ? [api.get('/users/'), api.get('/users/logs')]
                            : [Promise.resolve(null), Promise.resolve(null)];

                        const [
                            appointmentData,
                            patientsData,
                            locationsData,
                            usersData,
                            logsData
                        ] = await Promise.all([
                            appointmentPromise,
                            patientsPromise,
                            locationsPromise,
                            ...adminPromises,
                        ]);

                        setAppointments(appointmentData);
                        setPatients(patientsData);
                        setLocations(locationsData);
                        if (usersData) setUsers(usersData);
                        if (logsData) setLogs(logsData);

                    } catch (error) {
                        console.error("Failed to fetch data:", error);
                        if (error.detail === "Could not validate credentials") {
                            alert("Your session has expired. Please log in again.");
                            sessionStorage.clear();
                            window.location.href = './admin_login.html';
                        }
                    } finally {
                        setIsLoading(false);
                    }
                };
                fetchData();
            }, [currentUser]);

            // --- CRUD OPERATIONS (WITH IMPROVED ERROR LOGGING) ---

            // Appointment Operations
            const addOrUpdateAppointment = async (appointmentData) => {
                try {
                    if (appointmentData.id) {
                        const updatedAppointment = await api.patch(`/appointments/${appointmentData.id}/status`, {
                            status: appointmentData.status,
                            reason: appointmentData.reason
                        });
                        setAppointments(appointments.map(apt =>
                            apt.id === updatedAppointment.id ? { ...apt, ...updatedAppointment } : apt
                        ));
                    } else {
                        const newAppointment = await api.post('/appointments/', appointmentData);
                        setAppointments([...appointments, newAppointment]);
                    }
                } catch (error) {
                    console.error('Failed to save appointment:', error);
                    alert(`Error saving appointment. Check the console (F12) for details.`);
                }
            };

            const deleteAppointment = async (appointmentId) => {
                if (!window.confirm("Are you sure you want to delete this appointment?")) return;
                try {
                    // NOTE: The backend doesn't have a delete endpoint for appointments yet.
                    // This will fail until one is created.
                    await api.delete(`/appointments/${appointmentId}`);
                    setAppointments(appointments.filter(apt => apt.id !== appointmentId));
                } catch (error) {
                    console.error('Failed to delete appointment:', error);
                    alert('Could not delete appointment. (Endpoint may be missing)');
                }
            };

            // User Operations
            const handleUserSave = (userData) => {
                const request = userData.id
                    ? api.put(`/users/${userData.id}`, userData)
                    : api.post('/users/', userData);

                request.then(savedUser => {
                    if (userData.id) {
                        setUsers(prev => prev.map(u => u.id === savedUser.id ? savedUser : u));
                    } else {
                        setUsers(prev => [...prev, savedUser]);
                    }
                }).catch(err => {
                    console.error('User save error:', err);
                    alert('Error saving user. Check the console (F12) for details.');
                });
            };

            const handleUserDelete = (userId) => {
                if (!window.confirm("Are you sure you want to delete this user? This action cannot be undone.")) return;
                api.delete(`/users/${userId}`).then(() => {
                    setUsers(prev => prev.filter(u => u.id !== userId));
                }).catch(err => alert(`Error deleting user: ${err.detail}`));
            };

            // --- JSX (No changes below this line in this function) ---
            const NavLink = ({ view, label, icon }) => (
                <button
                    onClick={() => setActiveView(view)}
                    className={`flex items-center space-x-3 w-full p-3 rounded-lg font-semibold transition-colors ${activeView === view ? 'bg-primary text-light' : 'text-primary hover:bg-accent'
                        }`}>
                    {icon}<span>{label}</span>
                </button>
            );

            if (isLoading) {
                return (
                    <div className="flex h-screen items-center justify-center text-primary font-semibold">
                        <div className="spinner"></div>
                    </div>
                );
            }

            return (
                <div className="flex h-screen bg-secondary">
                    <aside className="w-64 bg-light shadow-lg p-4 flex flex-col">
                        <div className="mb-8 p-2">
                            <h1 className="text-2xl font-bold text-primary">Clinic OS</h1>
                            <p className="text-sm text-text-light">
                                Welcome, <span className="font-bold">{currentUser.username}</span>
                            </p>
                            <p className="text-xs text-text-light">
                                Role: <span className="font-bold capitalize">{currentUser.role}</span>
                            </p>
                        </div>
                        <nav className="flex-1 space-y-2">
                            <NavLink view="dashboard" label="Dashboard" icon={<span>📅</span>} />
                            <NavLink view="schedule" label="Schedule" icon={<span>🕒</span>} />
                            <NavLink view="patients" label="Patients" icon={<span>👥</span>} />
                            {currentUser.role === 'admin' && (
                                <>
                                    <NavLink view="users" label="Users" icon={<span>⚙️</span>} />
                                    <NavLink view="logs" label="Activity Log" icon={<span>📜</span>} />
                                </>
                            )}
                        </nav>
                        <div>
                            <button
                                onClick={() => {
                                    sessionStorage.clear();
                                    window.location.href = './admin_login.html';
                                }}
                                className="flex items-center space-x-3 p-3 rounded-lg w-full text-left font-semibold text-primary hover:bg-red-100 hover:text-red-600 transition-colors">
                                <span>🚪</span><span>Logout</span>
                            </button>
                        </div>
                    </aside>
                    <main className="flex-1 p-8 overflow-y-auto">
                        {activeView === 'dashboard' && (
                            <Dashboard
                                appointments={appointments}
                                patients={patients}
                                locations={locations}
                                schedule={schedule}
                                onSave={addOrUpdateAppointment}
                                onDelete={deleteAppointment}
                            />
                        )}
                        {activeView === 'schedule' && (
                            <AdvancedScheduleManager
                                schedule={schedule}
                                locations={locations}
                                setSchedule={setSchedule}
                            />
                        )}
                        {activeView === 'patients' && (<PatientManagement patients={patients} locations={locations} />)}
                        {activeView === 'users' && currentUser.role === 'admin' && (
                            <UserManagement
                                users={users}
                                onSave={handleUserSave}
                                onDelete={handleUserDelete}
                            />
                        )}
                        {activeView === 'logs' && currentUser.role === 'admin' && (
                            <ActivityLogView logs={logs} />
                        )}
                    </main>
                </div>
            );
        }

        function Dashboard({ appointments, patients, locations, schedule, onSave, onDelete }) {
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [selectedAppointment, setSelectedAppointment] = useState(null);

            const handleEdit = (apt) => {
                setSelectedAppointment(apt);
                setIsModalOpen(true);
            };

            const handleAddNew = () => {
                setSelectedAppointment(null);
                setIsModalOpen(true);
            };

            return (
                <div>
                    <AppointmentModal
                        isOpen={isModalOpen}
                        onClose={() => setIsModalOpen(false)}
                        appointment={selectedAppointment}
                        onSave={onSave}
                        onDelete={onDelete}
                        selectedDate={selectedDate}
                        appointments={appointments}
                        schedule={schedule}
                        patients={patients}
                        locations={locations}
                    />
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-2 bg-light p-6 rounded-xl shadow-lg">
                            <CalendarView
                                selectedDate={selectedDate}
                                onDateSelect={setSelectedDate}
                                appointments={appointments}
                            />
                        </div>
                        <div className="bg-light p-6 rounded-xl shadow-lg">
                            <AppointmentsForDay
                                selectedDate={selectedDate}
                                appointments={appointments}
                                locations={locations}
                                onEdit={handleEdit}
                                onAddNew={handleAddNew}
                            />
                        </div>
                    </div>
                </div>
            );
        }

        const CalendarView = ({ selectedDate, onDateSelect, appointments }) => {
            const [currentDate, setCurrentDate] = useState(new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1));
            const monthName = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(currentDate);
            const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const startDay = currentDate.getDay();
            const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();

            const changeMonth = (offset) => {
                const newDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + offset, 1);
                setCurrentDate(newDate);
            };

            return (
                <div>
                    <div className="flex justify-between items-center mb-4">
                        <button onClick={() => changeMonth(-1)} className="p-2 rounded-full hover:bg-secondary text-xl">‹</button>
                        <h3 className="text-xl font-bold text-primary">{monthName}</h3>
                        <button onClick={() => changeMonth(1)} className="p-2 rounded-full hover:bg-secondary text-xl">›</button>
                    </div>
                    <div className="grid grid-cols-7 text-center font-semibold text-text-light text-sm mb-2">
                        {daysOfWeek.map(day => <div key={day} className="p-2">{day}</div>)}
                    </div>
                    <div className="grid grid-cols-7 gap-1">
                        {Array.from({ length: startDay }).map((_, i) => (
                            <div key={`empty-${i}`} className="h-20"></div>
                        ))}
                        {Array.from({ length: daysInMonth }).map((_, i) => {
                            const day = i + 1;
                            const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                            const isSelected = date.toDateString() === selectedDate.toDateString();
                            const isToday = date.toDateString() === new Date().toDateString();
                            const aptsOnDay = appointments.filter(a =>
                                new Date(a.start_time).toDateString() === date.toDateString()
                            ).length;

                            return (
                                <div
                                    key={day}
                                    onClick={() => onDateSelect(date)}
                                    className={`p-2 h-20 flex flex-col items-center justify-center rounded-lg cursor-pointer transition-colors border-2 ${isSelected
                                        ? 'border-primary bg-secondary'
                                        : isToday
                                            ? 'border-accent bg-accent bg-opacity-30'
                                            : 'border-transparent hover:bg-secondary'
                                        }`}>
                                    <span className={`font-semibold ${isSelected ? 'text-primary' : isToday ? 'text-primary' : 'text-text-dark'
                                        }`}>
                                        {day}
                                    </span>
                                    {aptsOnDay > 0 && (
                                        <div className="flex space-x-1 mt-1">
                                            {Array.from({ length: Math.min(aptsOnDay, 3) }).map((_, i) => (
                                                <div key={i} className="w-1.5 h-1.5 bg-primary rounded-full"></div>
                                            ))}
                                            {aptsOnDay > 3 && (
                                                <span className="text-xs text-primary font-bold">+</span>
                                            )}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const AppointmentsForDay = ({ selectedDate, appointments, locations, onEdit, onAddNew }) => {
            const dayAppointments = appointments
                .filter(a => new Date(a.start_time).toDateString() === selectedDate.toDateString())
                .sort((a, b) => new Date(a.start_time) - new Date(b.start_time));

            const getStatusColor = (status) => {
                switch (status) {
                    case 'Confirmed': return 'bg-blue-100 text-blue-800';
                    case 'Completed': return 'bg-green-100 text-green-800';
                    case 'Cancelled': return 'bg-red-100 text-red-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };

            return (
                <div>
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-xl font-bold text-primary">Schedule</h3>
                        <button
                            onClick={onAddNew}
                            className="text-sm font-semibold bg-primary text-light px-3 py-1 rounded-md hover:bg-opacity-90 transition-colors">
                            + Add
                        </button>
                    </div>
                    <p className="text-sm text-text-light mb-4">{selectedDate.toDateString()}</p>
                    <div className="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                        {dayAppointments.length > 0 ? dayAppointments.map(apt => (
                            <div
                                key={apt.id}
                                onClick={() => onEdit(apt)}
                                className="p-3 bg-secondary rounded-lg cursor-pointer hover:shadow-md transition-shadow border-l-4 border-primary">
                                <div className="flex justify-between items-start mb-2">
                                    <p className="font-semibold text-text-dark">{apt.patient.name}</p>
                                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(apt.status)}`}>
                                        {apt.status}
                                    </span>
                                </div>
                                <div className="flex justify-between text-sm text-text-light">
                                    <span className="font-medium">
                                        {new Date(apt.start_time).toLocaleTimeString([], {
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        })}
                                    </span>
                                    <span className="font-medium text-primary">
                                        {apt.location?.name || 'Location N/A'}
                                    </span>
                                </div>
                                {apt.reason && (
                                    <p className="text-sm text-text-light mt-1 truncate">
                                        {apt.reason}
                                    </p>
                                )}
                            </div>
                        )) : (
                            <div className="text-center py-8">
                                <p className="text-text-light mb-2">No appointments for this day.</p>
                                <button
                                    onClick={onAddNew}
                                    className="text-primary hover:underline font-medium">
                                    Schedule an appointment
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        function AppointmentModal({ isOpen, onClose, appointment, onSave, onDelete, selectedDate, appointments, schedule, patients, locations }) {
            const [formData, setFormData] = useState({});

            useEffect(() => {
                if (isOpen) {
                    const isNew = !appointment;
                    const startTime = isNew ? selectedDate : new Date(appointment.start_time);

                    // Create a default end_time 30 minutes after the start_time for new appointments
                    const endTime = isNew ? new Date(startTime.getTime() + 30 * 60000) : new Date(appointment.end_time);

                    const initialData = {
                        id: appointment ? appointment.id : null,
                        patient_id: appointment ? appointment.patient_id : '',
                        location_id: appointment ? appointment.location_id : '',
                        start_time: startTime,
                        end_time: endTime, // Add the end_time here
                        reason: appointment ? appointment.reason : '',
                        status: appointment ? appointment.status : 'Confirmed',
                    };
                    setFormData(initialData);
                }
            }, [appointment, isOpen, selectedDate]);

            if (!isOpen) return null;

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
                onClose();
            };

            const handleDelete = () => {
                if (appointment && onDelete) {
                    onDelete(appointment.id);
                    onClose();
                }
            };

            return (
                <div className="modal-backdrop">
                    <div className="modal-content">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold text-primary">
                                {appointment ? 'Edit Appointment' : 'New Appointment'}
                            </h3>
                            <button
                                onClick={onClose}
                                className="text-gray-400 hover:text-gray-600 text-2xl">
                                ×
                            </button>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            {/* Patient Selection - Add when patients endpoint is available */}
                            {patients.length > 0 && (
                                <select
                                    value={formData.patient_id || ''}
                                    onChange={(e) => setFormData({ ...formData, patient_id: e.target.value })}
                                    className="w-full p-2.5 border border-accent rounded-lg bg-secondary focus:ring-primary focus:border-primary"
                                    required>
                                    <option value="">Select Patient</option>
                                    {patients.map(patient => (
                                        <option key={patient.id} value={patient.id}>{patient.name}</option>
                                    ))}
                                </select>
                            )}

                            {/* Location Selection - Add when locations endpoint is available */}
                            {locations.length > 0 && (
                                <select
                                    value={formData.location_id || ''}
                                    onChange={(e) => setFormData({ ...formData, location_id: e.target.value })}
                                    className="w-full p-2.5 border border-accent rounded-lg bg-secondary focus:ring-primary focus:border-primary"
                                    required>
                                    <option value="">Select Location</option>
                                    {locations.map(location => (
                                        <option key={location.id} value={location.id}>{location.name}</option>
                                    ))}
                                </select>
                            )}

                            <input
                                type="text"
                                placeholder="Reason for visit"
                                value={formData.reason || ''}
                                onChange={(e) => setFormData({ ...formData, reason: e.target.value })}
                                className="w-full p-2.5 border border-accent rounded-lg bg-secondary focus:ring-primary focus:border-primary"
                            />

                            <select
                                value={formData.status || 'Confirmed'}
                                onChange={e => setFormData({ ...formData, status: e.target.value })}
                                className="w-full p-2.5 border border-accent rounded-lg bg-secondary focus:ring-primary focus:border-primary">
                                <option value="Confirmed">Confirmed</option>
                                <option value="Completed">Completed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>

                            {/* Date and Time Selection */}
                            <input
                                type="datetime-local"
                                value={formData.start_time ? new Date(formData.start_time).toISOString().slice(0, 16) : ''}
                                onChange={(e) => setFormData({ ...formData, start_time: new Date(e.target.value) })}
                                className="w-full p-2.5 border border-accent rounded-lg bg-secondary focus:ring-primary focus:border-primary"
                                required
                            />

                            <div className="pt-4 flex justify-between">
                                <div>
                                    {appointment && (
                                        <button
                                            type="button"
                                            onClick={handleDelete}
                                            className="px-4 py-2 bg-red-600 text-white text-sm font-semibold rounded-lg hover:bg-red-700 transition-colors">
                                            Delete
                                        </button>
                                    )}
                                </div>
                                <div className="flex gap-x-3">
                                    <button
                                        type="button"
                                        onClick={onClose}
                                        className="px-4 py-2 bg-gray-200 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-300 transition-colors">
                                        Cancel
                                    </button>
                                    <button
                                        type="submit"
                                        className="px-4 py-2 bg-primary text-light text-sm font-semibold rounded-lg hover:bg-opacity-90 transition-colors">
                                        Save
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function AdvancedScheduleManager({ schedule, locations, setSchedule }) {
            const { role } = useAuth();
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const [editingDay, setEditingDay] = useState(null);
            const [editingShift, setEditingShift] = useState(null);

            const addShift = (dayIndex) => {
                if (role !== 'admin') return;
                const newShift = { l: locations[0]?.id || 1, s: '09:00', e: '17:00' };
                const updatedSchedule = {
                    ...schedule,
                    [dayIndex]: [...(schedule[dayIndex] || []), newShift]
                };
                setSchedule(updatedSchedule);
            };

            const updateShift = (dayIndex, shiftIndex, field, value) => {
                if (role !== 'admin') return;
                const updatedShifts = [...schedule[dayIndex]];
                updatedShifts[shiftIndex] = { ...updatedShifts[shiftIndex], [field]: value };
                setSchedule({
                    ...schedule,
                    [dayIndex]: updatedShifts
                });
            };

            const removeShift = (dayIndex, shiftIndex) => {
                if (role !== 'admin') return;
                const updatedShifts = schedule[dayIndex].filter((_, index) => index !== shiftIndex);
                setSchedule({
                    ...schedule,
                    [dayIndex]: updatedShifts
                });
            };

            return (
                <div className="bg-light p-8 rounded-xl shadow-lg">
                    <div className="mb-6">
                        <h2 className="text-3xl font-bold text-primary mb-2">Schedule Management</h2>
                        <p className="text-text-light">
                            Define working hours for each day.
                            {role !== 'admin' && ' Contact admin to make changes.'}
                        </p>
                    </div>

                    <div className="space-y-6">
                        {dayNames.map((dayName, dayIndex) => (
                            <div key={dayIndex} className="border border-accent rounded-lg p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold text-primary">{dayName}</h3>
                                    {role === 'admin' && (
                                        <button
                                            onClick={() => addShift(dayIndex)}
                                            className="px-3 py-1 bg-primary text-light text-sm font-semibold rounded-md hover:bg-opacity-90">
                                            + Add Shift
                                        </button>
                                    )}
                                </div>

                                <div className="space-y-3">
                                    {(schedule[dayIndex] || []).map((shift, shiftIndex) => (
                                        <div key={shiftIndex} className="flex items-center space-x-3 bg-secondary p-3 rounded-lg">
                                            {locations.length > 0 && (
                                                <select
                                                    value={shift.l}
                                                    onChange={(e) => updateShift(dayIndex, shiftIndex, 'l', parseInt(e.target.value))}
                                                    disabled={role !== 'admin'}
                                                    className="p-2 border border-accent rounded bg-light disabled:opacity-50">
                                                    {locations.map(location => (
                                                        <option key={location.id} value={location.id}>{location.name}</option>
                                                    ))}
                                                </select>
                                            )}

                                            <input
                                                type="time"
                                                value={shift.s}
                                                onChange={(e) => updateShift(dayIndex, shiftIndex, 's', e.target.value)}
                                                disabled={role !== 'admin'}
                                                className="p-2 border border-accent rounded bg-light disabled:opacity-50"
                                            />

                                            <span className="text-text-light">to</span>

                                            <input
                                                type="time"
                                                value={shift.e}
                                                onChange={(e) => updateShift(dayIndex, shiftIndex, 'e', e.target.value)}
                                                disabled={role !== 'admin'}
                                                className="p-2 border border-accent rounded bg-light disabled:opacity-50"
                                            />

                                            {role === 'admin' && (
                                                <button
                                                    onClick={() => removeShift(dayIndex, shiftIndex)}
                                                    className="text-red-600 hover:text-red-800 font-semibold">
                                                    Remove
                                                </button>
                                            )}
                                        </div>
                                    ))}

                                    {(!schedule[dayIndex] || schedule[dayIndex].length === 0) && (
                                        <p className="text-text-light text-center py-4">No shifts scheduled for this day</p>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>

                    {role === 'admin' && (
                        <div className="mt-6 pt-6 border-t border-accent">
                            <button className="px-6 py-3 bg-primary text-light font-semibold rounded-lg hover:bg-opacity-90 transition-colors">
                                Save Schedule Changes
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        function UserManagement({ users, onSave, onDelete }) {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [selectedUser, setSelectedUser] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');

            const handleEdit = (user) => {
                setSelectedUser(user);
                setIsModalOpen(true);
            };

            const handleAddNew = () => {
                setSelectedUser(null);
                setIsModalOpen(true);
            };

            const filteredUsers = users.filter(user =>
                user.username.toLowerCase().includes(searchTerm.toLowerCase()) ||
                user.email?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                user.role.toLowerCase().includes(searchTerm.toLowerCase())
            );

            return (
                <div className="bg-light p-8 rounded-xl shadow-lg">
                    {isModalOpen && (
                        <UserModal
                            user={selectedUser}
                            onSave={onSave}
                            onClose={() => setIsModalOpen(false)}
                        />
                    )}

                    <div className="flex justify-between items-center mb-6">
                        <div>
                            <h2 className="text-3xl font-bold text-primary">User Management</h2>
                            <p className="text-text-light">Add, edit, or remove staff accounts.</p>
                        </div>
                        <button
                            onClick={handleAddNew}
                            className="px-4 py-2 bg-primary text-light font-semibold rounded-lg hover:bg-opacity-90 transition-colors">
                            + Add New User
                        </button>
                    </div>

                    <div className="mb-4">
                        <input
                            type="text"
                            placeholder="Search users..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="w-full max-w-md p-2.5 border border-accent rounded-lg bg-secondary focus:ring-primary focus:border-primary"
                        />
                    </div>

                    <div className="overflow-x-auto">
                        <table className="min-w-full">
                            <thead className="bg-secondary">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-bold text-primary uppercase tracking-wider">Username</th>
                                    <th className="px-6 py-3 text-left text-xs font-bold text-primary uppercase tracking-wider">Email</th>
                                    <th className="px-6 py-3 text-left text-xs font-bold text-primary uppercase tracking-wider">Phone</th>
                                    <th className="px-6 py-3 text-left text-xs font-bold text-primary uppercase tracking-wider">Role</th>
                                    <th className="px-6 py-3 text-left text-xs font-bold text-primary uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="bg-light divide-y divide-accent">
                                {filteredUsers.length > 0 ? filteredUsers.map(user => (
                                    <tr key={user.id} className="hover:bg-secondary hover:bg-opacity-50">
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-text-dark">
                                            {user.username}
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-text-light">
                                            {user.email || 'N/A'}
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-text-light">
                                            {user.phone_number || 'N/A'}
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm">
                                            <span className={`px-2 py-1 rounded-full text-xs font-medium capitalize ${user.role === 'admin'
                                                ? 'bg-purple-100 text-purple-800'
                                                : 'bg-blue-100 text-blue-800'
                                                }`}>
                                                {user.role}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                                            <button
                                                onClick={() => handleEdit(user)}
                                                className="font-semibold text-primary hover:underline transition-colors">
                                                Edit
                                            </button>
                                            <button
                                                onClick={() => onDelete(user.id)}
                                                className="font-semibold text-red-600 hover:underline transition-colors">
                                                Delete
                                            </button>
                                        </td>
                                    </tr>
                                )) : (
                                    <tr>
                                        <td colSpan="5" className="text-center py-8 text-text-light">
                                            {searchTerm ? 'No users found matching your search.' : 'No users found.'}
                                        </td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function UserModal({ user, onSave, onClose }) {
            const [formData, setFormData] = useState({
                id: null,
                username: '',
                email: '',
                phone_number: '',
                password: '',
                role: 'staff'
            });

            useEffect(() => {
                if (user) {
                    setFormData({ ...user, password: '' });
                } else {
                    setFormData({
                        id: null,
                        username: '',
                        email: '',
                        phone_number: '',
                        password: '',
                        role: 'staff'
                    });
                }
            }, [user]);

            const handleChange = (e) => {
                setFormData({ ...formData, [e.target.name]: e.target.value });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const dataToSave = { ...formData };
                if (!dataToSave.password) {
                    delete dataToSave.password;
                }
                onSave(dataToSave);
                onClose();
            };

            return (
                <div className="modal-backdrop">
                    <div className="modal-content">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold text-primary">
                                {user ? 'Edit User' : 'Create New User'}
                            </h3>
                            <button
                                onClick={onClose}
                                className="text-gray-400 hover:text-gray-600 text-2xl">
                                ×
                            </button>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input
                                name="username"
                                value={formData.username}
                                onChange={handleChange}
                                placeholder="Username"
                                required
                                disabled={!!user}
                                className="w-full p-2.5 border border-accent rounded-lg bg-secondary focus:ring-primary focus:border-primary disabled:opacity-50 disabled:cursor-not-allowed"
                            />

                            <input
                                name="email"
                                type="email"
                                value={formData.email || ''}
                                onChange={handleChange}
                                placeholder="Email Address"
                                className="w-full p-2.5 border border-accent rounded-lg bg-secondary focus:ring-primary focus:border-primary"
                            />

                            <input
                                name="phone_number"
                                value={formData.phone_number || ''}
                                onChange={handleChange}
                                placeholder="Phone Number"
                                className="w-full p-2.5 border border-accent rounded-lg bg-secondary focus:ring-primary focus:border-primary"
                            />

                            <input
                                name="password"
                                type="password"
                                value={formData.password}
                                onChange={handleChange}
                                placeholder={user ? "New Password (leave blank to keep current)" : "Password"}
                                required={!user}
                                className="w-full p-2.5 border border-accent rounded-lg bg-secondary focus:ring-primary focus:border-primary"
                            />

                            <select
                                name="role"
                                value={formData.role}
                                onChange={handleChange}
                                className="w-full p-2.5 border border-accent rounded-lg bg-secondary focus:ring-primary focus:border-primary">
                                <option value="staff">Staff</option>
                                <option value="admin">Admin</option>
                            </select>

                            <div className="pt-4 flex justify-end gap-x-3">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-colors">
                                    Cancel
                                </button>
                                <button
                                    type="submit"
                                    className="px-4 py-2 bg-primary text-light font-semibold rounded-lg hover:bg-opacity-90 transition-colors">
                                    {user ? 'Update' : 'Create'} User
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function ActivityLogView({ logs }) {
            const [filter, setFilter] = useState('');
            const [sortOrder, setSortOrder] = useState('desc');

            const filteredLogs = logs
                .filter(log =>
                    !filter ||
                    log.action.toLowerCase().includes(filter.toLowerCase()) ||
                    log.user.username.toLowerCase().includes(filter.toLowerCase()) ||
                    log.details.toLowerCase().includes(filter.toLowerCase())
                )
                .sort((a, b) => {
                    const dateA = new Date(a.timestamp);
                    const dateB = new Date(b.timestamp);
                    return sortOrder === 'desc' ? dateB - dateA : dateA - dateB;
                });

            return (
                <div className="bg-light p-8 rounded-xl shadow-lg">
                    <div className="mb-6">
                        <h2 className="text-3xl font-bold text-primary mb-2">Activity Log</h2>
                        <p className="text-text-light">A record of all significant actions within the system.</p>
                    </div>

                    <div className="flex flex-col sm:flex-row gap-4 mb-6">
                        <input
                            type="text"
                            placeholder="Filter logs..."
                            value={filter}
                            onChange={(e) => setFilter(e.target.value)}
                            className="flex-1 p-2.5 border border-accent rounded-lg bg-secondary focus:ring-primary focus:border-primary"
                        />
                        <button
                            onClick={() => setSortOrder(sortOrder === 'desc' ? 'asc' : 'desc')}
                            className="px-4 py-2 bg-secondary text-primary font-semibold rounded-lg hover:bg-accent transition-colors">
                            Sort {sortOrder === 'desc' ? '↓ Newest' : '↑ Oldest'}
                        </button>
                    </div>

                    <div className="overflow-x-auto max-h-[75vh] border border-accent rounded-lg">
                        <table className="min-w-full">
                            <thead className="bg-secondary sticky top-0">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-bold text-primary uppercase tracking-wider">
                                        Timestamp
                                    </th>
                                    <th className="px-6 py-3 text-left text-xs font-bold text-primary uppercase tracking-wider">
                                        User
                                    </th>
                                    <th className="px-6 py-3 text-left text-xs font-bold text-primary uppercase tracking-wider">
                                        Action
                                    </th>
                                    <th className="px-6 py-3 text-left text-xs font-bold text-primary uppercase tracking-wider">
                                        Details
                                    </th>
                                </tr>
                            </thead>
                            <tbody className="bg-light divide-y divide-accent">
                                {filteredLogs.length > 0 ? filteredLogs.map(log => (
                                    <tr key={log.id} className="hover:bg-secondary hover:bg-opacity-30">
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-text-light">
                                            {new Date(log.timestamp).toLocaleString()}
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-text-dark font-medium">
                                            {log.user.username}
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-text-dark">
                                            <span className="px-2 py-1 bg-primary bg-opacity-10 text-primary rounded-full text-xs font-medium">
                                                {log.action}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4 text-sm text-text-light max-w-md">
                                            <div className="truncate" title={log.details}>
                                                {log.details}
                                            </div>
                                        </td>
                                    </tr>
                                )) : (
                                    <tr>
                                        <td colSpan="4" className="text-center py-8 text-text-light">
                                            {filter ? 'No logs found matching your filter.' : 'No activity logs found.'}
                                        </td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>

                    <div className="mt-4 text-sm text-text-light">
                        Showing {filteredLogs.length} of {logs.length} log entries
                    </div>
                </div>
            );
        }


        function PatientManagement({ patients: initialPatients, onSave }) {
            const [patients, setPatients] = useState(initialPatients);
            const [selectedPatient, setSelectedPatient] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [isModalOpen, setIsModalOpen] = useState(false);

            const handleSavePatient = async (patientData) => {
                const newPatient = await onSave(patientData);
                if (newPatient) {
                    setPatients(prev => [...prev, newPatient]);
                    setIsModalOpen(false);
                }
            };

            const filteredPatients = patients.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()) || p.phone_number.includes(searchTerm));

            if (selectedPatient) { return <PatientDetailView patient={selectedPatient} onBack={() => setSelectedPatient(null)} />; }

            return (
                <div className="bg-light p-8 rounded-xl shadow-lg">
                    {isModalOpen && <PatientModal onClose={() => setIsModalOpen(false)} onSave={handleSavePatient} />}
                    <div className="flex justify-between items-center mb-6">
                        <div>
                            <h2 className="text-3xl font-bold text-primary">Patient Records</h2>
                            <p className="text-text-light">Search for or create a new patient record.</p>
                        </div>
                        <button onClick={() => setIsModalOpen(true)} className="px-4 py-2 bg-primary text-light font-semibold rounded-lg hover:bg-opacity-90">+ Add New Patient</button>
                    </div>
                    <input type="text" placeholder="Search by name or phone..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full max-w-md p-2.5 mb-4 border border-accent rounded-lg bg-secondary" />
                    <div className="overflow-x-auto">
                        <table className="min-w-full">
                            <thead className="bg-secondary">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-bold text-primary uppercase">Name</th>
                                    <th className="px-6 py-3 text-left text-xs font-bold text-primary uppercase">Phone</th>
                                    <th className="px-6 py-3 text-left text-xs font-bold text-primary uppercase">Email</th>
                                </tr>
                            </thead>
                            <tbody className="bg-light divide-y divide-accent">
                                {filteredPatients.map(patient => (
                                    <tr key={patient.id} onClick={() => setSelectedPatient(patient)} className="hover:bg-secondary cursor-pointer">
                                        <td className="px-6 py-4">{patient.name}</td>
                                        <td className="px-6 py-4">{patient.phone_number}</td>
                                        <td className="px-6 py-4">{patient.email || 'N/A'}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // --- NEW PATIENT CREATION MODAL ---
        function PatientModal({ onClose, onSave }) {
            const [formData, setFormData] = useState({ name: '', phone_number: '', email: '', date_of_birth: '' });
            const handleChange = e => setFormData({ ...formData, [e.target.name]: e.target.value });
            const handleSubmit = e => { e.preventDefault(); onSave(formData); };
            return (
                <div className="modal-backdrop">
                    <div className="modal-content">
                        <h3 className="text-xl font-bold text-primary mb-6">Create New Patient</h3>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input name="name" value={formData.name} onChange={handleChange} placeholder="Full Name" required className="w-full p-2.5 border rounded-lg" />
                            <input name="phone_number" value={formData.phone_number} onChange={handleChange} placeholder="Phone Number" required className="w-full p-2.5 border rounded-lg" />
                            <input name="email" type="email" value={formData.email} onChange={handleChange} placeholder="Email (Optional)" className="w-full p-2.5 border rounded-lg" />
                            <input name="date_of_birth" type="date" value={formData.date_of_birth} onChange={handleChange} placeholder="Date of Birth" className="w-full p-2.5 border rounded-lg" />
                            <div className="pt-4 flex justify-end gap-x-3">
                                <button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 rounded-lg">Cancel</button>
                                <button type="submit" className="px-4 py-2 bg-primary text-light rounded-lg">Save Patient</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // --- PATIENT DETAIL VIEW (WITH REMARK & DOCUMENT FORMS) ---
        function PatientDetailView({ patient, onBack }) {
            const [details, setDetails] = useState(null);
            const [activeTab, setActiveTab] = useState('appointments');
            const [isLoading, setIsLoading] = useState(true);
            const [newRemark, setNewRemark] = useState('');

            useEffect(() => {
                setIsLoading(true);
                api.get(`/patients/${patient.id}`).then(data => setDetails(data))
                    .catch(err => console.error("Failed to fetch patient details", err))
                    .finally(() => setIsLoading(false));
            }, [patient.id]);

            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const description = prompt("Enter a brief description for this file:", file.name);
                const formData = new FormData();
                formData.append('upload_file', file);
                try {
                    const newDocument = await api.post(`/patients/${patient.id}/documents/?description=${encodeURIComponent(description)}`, formData);
                    setDetails(prev => ({ ...prev, documents: [...prev.documents, newDocument] }));
                } catch (error) {
                    alert(`File upload failed: ${error.detail}`);
                }
            };

            const handleAddRemark = async () => {
                if (!newRemark.trim()) return;
                try {
                    const savedRemark = await api.post(`/patients/${patient.id}/remarks/`, { text: newRemark });
                    setDetails(prev => ({ ...prev, remarks: [...prev.remarks, savedRemark] }));
                    setNewRemark('');
                } catch (error) {
                    alert(`Failed to add remark: ${error.detail}`);
                }
            };

            if (isLoading) return <div className="spinner"></div>;
            if (!details) return <div>Error loading patient details.</div>;

            const TabButton = ({ tabName, label }) => (<button onClick={() => setActiveTab(tabName)} className={`px-4 py-2 font-semibold rounded-t-lg ${activeTab === tabName ? 'bg-light border-b-2 border-primary text-primary' : 'bg-secondary text-text-light'}`}>{label}</button>);

            return (
                <div className="bg-light p-8 rounded-xl shadow-lg">
                    <button onClick={onBack} className="mb-4 font-semibold text-primary hover:underline">&larr; Back to All Patients</button>
                    {<div className="flex items-center space-x-4 mb-6 pb-6 border-b border-accent">
                        <div className="w-20 h-20 bg-primary text-light flex items-center justify-center rounded-full text-4xl font-bold">
                            {details.name.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <h2 className="text-3xl font-bold text-primary">{details.name}</h2>
                            <p className="text-text-light mt-1">{details.phone_number} &bull; {details.email || 'No email provided'}</p>
                            <p className="text-text-light">Age: {details.age ? `${details.age} years old` : 'N/A'}</p>
                        </div>
                    </div>}
                    <div className="border-b border-accent -mx-8 px-8"><div className="flex space-x-2"><TabButton tabName="appointments" label="Appointments" /><TabButton tabName="documents" label="Documents" /><TabButton tabName="remarks" label="Remarks" /></div></div>
                    <div className="pt-6">
                        {activeTab === 'appointments' && (
                            <div>
                                <h3 className="text-xl font-bold text-primary mb-4">Appointment History</h3>
                                <ul className="space-y-3">
                                    {details.appointments.length > 0 ? details.appointments.map(apt => (
                                        <li key={apt.id} className="p-4 bg-secondary rounded-lg border-l-4 border-accent">
                                            <div className="flex justify-between items-center">
                                                <p className="font-semibold text-text-dark"><strong>{new Date(apt.start_time).toLocaleDateString()}</strong> at {new Date(apt.start_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                                                <span className="text-sm font-medium text-primary">{apt.location.name}</span>
                                            </div>
                                            <p className="text-sm text-text-light mt-1">Status: {apt.status} | Reason: {apt.reason || 'N/A'}</p>
                                        </li>
                                    )) : <p className="text-text-light">No appointment history found.</p>}
                                </ul>
                            </div>
                        )}
                        {activeTab === 'documents' && (
                            <div>
                                <h3 className="text-xl font-bold text-primary mb-4">Documents</h3>
                                <div className="mb-4 p-4 border border-dashed rounded-lg"><h4 className="font-semibold mb-2">Upload New Document</h4><input type="file" onChange={handleFileUpload} /></div>
                                <ul className="space-y-2">{details.documents.map(doc => (<li key={doc.id} className="p-2 bg-secondary rounded flex justify-between">
                                    <a href={`${API_BASE_URL}${doc.file_path}`} target="_blank" rel="noopener noreferrer" className="text-primary underline">{doc.description || doc.file_path}</a>
                                    <span className="text-xs text-text-light">{new Date(doc.upload_date).toLocaleDateString()}</span>
                                </li>))}</ul>
                            </div>
                        )}
                        {activeTab === 'remarks' && (
                            <div>
                                <h3 className="text-xl font-bold text-primary mb-4">Doctor's Remarks</h3>
                                <div className="mb-4"><textarea value={newRemark} onChange={e => setNewRemark(e.target.value)} placeholder="Add a new remark..." className="w-full p-2 border rounded-lg"></textarea><button onClick={handleAddRemark} className="mt-2 px-4 py-2 bg-primary text-light rounded-lg">Add Remark</button></div>
                                <ul className="space-y-3">{details.remarks.map(remark => (<li key={remark.id} className="p-3 bg-secondary rounded-lg">
                                    <p>{remark.text}</p><p className="text-xs text-right text-text-light mt-2">-- {remark.author.username} on {new Date(remark.created_at).toLocaleDateString()}</p>
                                </li>))}</ul>
                            </div>
                        )}
                    </div>
                </div>
            );
        }


        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>

</html>